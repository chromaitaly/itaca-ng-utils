/*****************************************************************/
/** itaca-ng-utils v1.0.0 14-11-2017	**/
/** itaca-ng-utils, logos and all images are registered     	**/
/** trademarks of Chroma Italy Hotels srl.                     	**/
/** All rights reserved.                                     	**/
/** Registration code: 21-11-2016/011058        	**/
/** 						                                 	**/
/**                               Chroma Italy Hotels srl ® 2017	**/
/*****************************************************************/
!function(){"use strict";angular.module("itaca.utils",["ngMaterial","itaca.services","pascalprecht.translate","tmh.dynamicLocale","LocalStorageModule"]),angular.module("itaca.utils").config(["$windowProvider","$translateProvider","tmhDynamicLocaleProvider",function(t,a,n){var e=(t.$get().navigator.language||t.$get().navigator.userLanguage).split("-")[0].toLowerCase();a.useLoader("i18nLoader"),a.preferredLanguage(e),a.useCookieStorage(),a.useMissingTranslationHandlerLog(),$translateSanitizationProvider.addStrategy("sce","sceStrategy"),a.useSanitizeValueStrategy("sce"),n.localeLocationPattern("/resources/public/js/i18n/angular-locale_{{locale}}.js"),n.useCookieStorage(),n.defaultLocale(e)}])}(),function(){"use strict";function t(t){var a=this;this.$init=function(){_.isArray(t)&&_.forEach(t,function(t,n){a.addOption(n,t)})},this.addOption=function(t,n){return!!angular.isString(t)&&(a[t]=n,!0)},this.addOptionStrict=function(t,n){return!!angular.isString(t)&&(!a.hasOwnProperty(t)&&(a[t]=n,!0))},this.updateOption=function(t,n){if(!angular.isString(t))return!1;if(!a.hasOwnProperty(t))return a.addOption(t,n);var e=a[t];return a[t]=n,e},this.$init()}angular.module("itaca.utils").provider("AppOptions",function(){var a={defaultLang:"en",page:{title:"Home"}};this.init=function(t,n){if(!_.isPlainObject(t))return!1;_.isBoolean(n)&&n?a=t:_.assign(a,t)},this.$get=function(){return new t(a)}})}(),function(){"use strict";function t(t,a){var n=function(a){var n={};if(t.$broadcast("onBeforeUnload",n).defaultPrevented)return n.message};return a.addEventListener("beforeunload",n),a.onbeforeunload=n,a.onunload=function(){t.$broadcast("onUnload")},{}}t.$inject=["$rootScope","$window"],angular.module("itaca.utils").factory("_beforeUnload",t)}(),function(){"use strict";angular.module("itaca.utils").factory("ContactUtils",function(){var t={};return t.getUri=function(t,a){var n="";switch(t){case"PHONE":case"MOBILE":case"FAX":n="tel:";break;case"MAIL":n="mailto:";break;case"WEBSITE":n="http://";break;case"FACEBOOK":n="https://www.facebook.com/";break;case"TWITTER":n="https://www.twitter.com/";break;case"INSTAGRAM":n="https://www.instagram.com/";break;default:n="http://"}return n+a},t})}(),function(){"use strict";function t(t,a,n,e){var o={};return o.absoluteDate=function(t,a){return o.absoluteMoment(t,a).toDate()},o.absoluteMoment=function(t,n){var e=t?a(t):a(),o=a(e).utc([e.year(),e.month(),e.date()]);return n?o:o.startOf("day")},o.dateForTimezone=function(t,n){return a.tz(t,n)},o.hotelDate=function(t){return e.hotel&&e.hotel.addressInfo&&e.hotel.addressInfo.timeZoneId?o.dateForTimezone(e.hotel.addressInfo.timeZoneId):a(t).utcOffset((e.defaultOffset||0)/60)},o.convertDateStringsToDates=function(a,e,i){if("object"!=typeof a)return a;e=e||10,i=i||0;for(var u in a)if(a.hasOwnProperty(u)){var r,l=a[u];if("string"==typeof l&&(r=l.match(n.dateString))){var s=r[0];try{var c=Date.parse(s);isNaN(c)||(a[u]=new Date(c)),s=void 0,c=void 0}catch(a){t.warn("Error converting date '"+s+"': "+a)}}else"object"==typeof l&&i<e&&o.convertDateStringsToDates(l,e,i+1)}},o.weekdays=function(){var t=[];return _.forEach(a.weekdays(!0),function(n,e){var o=a().day(n);t.push({label:n,day:o.day(),weekday:o.weekday(),isoWeekday:o.isoWeekday()})}),t},o.secondsToOffsetString=function(t){if(_.isNil(t))return"";if(t=Number(t),_.isNaN(t))return"";var a=String(Math.floor(Math.abs(t)/3600));a=a.length<2?"0"+a:a;var n=String(Math.floor(Math.abs(t)%3600/60));return n=n.length<2?"0"+n:n,(t>0?"+":"-")+a+n},o.rangeTimeChecker=function(t,n,e){var o=a.utc(t).seconds(0).milliseconds(0),i=a.utc(n),u=a(o).hours(i.hours()).minutes(i.minutes()).seconds(0).milliseconds(0),r=a.utc(e),l=a(o).hours(r.hours()).minutes(r.minutes()).seconds(0).milliseconds(0);return l=l.hours()>=u.hours()&&l.hours()<=23?l:l.add(1,"days"),o=o.hours()>=u.hours()&&o.hours()<=23?o:o.add(1,"days"),a.range(u,l).contains(o)},o}t.$inject=["$log","moment","REGEXP","AppOptions"],angular.module("itaca.utils").factory("DateUtils",t)}(),function(){"use strict";function t(t){var a={};return a.focusFirstInvalid=function(n){var e=angular.isObject(n)?n:document.getElementsByName(n)[0];if(e&&angular.isElement(e)&&angular.isFunction(e.querySelector)){var o=e.querySelector(".ng-invalid:not([disabled]):not([type='hidden'])");return!!o&&(_.isEqual(o.tagName.toLowerCase(),"ng-form")?a.focusFirstInvalid(o):(o.focus(),t.scrollToElementAnimated(o),!0))}},a.focusFirstInput=function(n){var e=angular.isObject(n)?n:document.getElementsByName(n)[0];if(e&&angular.isElement(e)&&angular.isFunction(e.querySelector)){var o=e.querySelector("input:not([disabled]):not([type='hidden'])");return!!o&&(o.focus(),t.scrollToElementAnimated(o,a.offset),!0)}},a.isInvalid=function(t){var a=document[t];if(a&&angular.isFunction(a.querySelector))return!!a.querySelector(".ng-invalid")},a}t.$inject=["$document"],angular.module("itaca.utils").factory("FormUtils",t)}(),function(){"use strict";function t(t){var a={};return a.isElementInView=function(a,n){var e=angular.element(a)[0];if(!e)return!1;var o=t.pageYOffset,i=o+t.innerHeight,u=e.offsetTop,r=u+e.offsetHeight;return!0===n?o<u&&i>r:u<=i&&r>=o},a.getScrollParent=function(t){var n=angular.element(t)[0];return null===n?null:n.scrollHeight>n.clientHeight?n:a.getScrollParent(n.parentNode)},a}t.$inject=["$window"],angular.module("itaca.utils").factory("HtmlUtils",t)}(),function(){"use strict";function t(t,a,n,e,o){return function(i){var u=[];if(angular.isString(o))u.push(o);else{if(!angular.isArray(o))return;u=o}var r={};r[i.queryParameter||"lang"]=i.key.toLowerCase().replace(/-/g,"_");var l={lang:i.key},s=[];_.forEach(u,function(o){var u=e(o)(l),c=a.get(u,angular.extend({params:r},i.$http)).then(function(t){return t.data},function(){return t.error("Error getting translations from url: "+u+" - lang: "+i.key),n.reject(i.key)});s.push(c)});var c=n.defer();return n.all(s).then(function(t){for(var a=t.length,n={},e=0;e<a;e++)for(var o in t[e])n[o]=t[e][o];c.resolve(n)},function(t){c.reject(t)}),c.promise}}angular.module("itaca.utils").provider("i18nLoader",function(){var a="/api/rs/public/i18n";this.setResources=function(t){if(!angular.isString(t)&&angular.isArray(t))return!1;a=t},this.$get=["$log","$http","$q","$interpolate",function(n,e,o,i){return new t(n,e,o,i,a)}]})}(),function(){"use strict";angular.module("itaca.utils").factory("IconUtils",function(){var t={};return t.languageIcons=function(){return{ITALIAN:{icon:"flag-icon flag-icon-it"},ENGLISH:{icon:"flag-icon flag-icon-gb"},FRENCH:{icon:"flag-icon flag-icon-fr"},SPANISH:{icon:"flag-icon flag-icon-es"},GERMAN:{icon:"flag-icon flag-icon-de"},PORTUGUESE:{icon:"flag-icon flag-icon-pt"},RUSSIAN:{icon:"flag-icon flag-icon-ru"},MANDARIN:{icon:"flag-icon flag-icon-cn"},HINDI:{icon:"flag-icon flag-icon-in"},ARABIC:{icon:"flag-icon flag-icon-sa"},BENGALI:{icon:"flag-icon flag-icon-bd"},JAPANESE:{icon:"flag-icon flag-icon-jp"},PUNJABI:{icon:"flag-icon flag-icon-pk"},JAVANESE:{icon:"flag-icon flag-icon-id"},WU:{icon:"flag-icon flag-icon-cn"},MALAY_INDONESIAN:{icon:"flag-icon flag-icon-in"},TELUGU:{icon:"flag-icon flag-icon-in"},VIETNAMESE:{icon:"flag-icon flag-icon-vn"},MARATHI:{icon:"flag-icon flag-icon-in"},TAMIL:{icon:"flag-icon flag-icon-lk"},URDU:{icon:"flag-icon flag-icon-ae"},TURKISH:{icon:"flag-icon flag-icon-tr"},LANG_SIGN:{icon:"material-icons flaticon-hearing-impaired"},LANG_SIGN_IT:{icon:"material-icons flaticon-hearing-impaired"}}},t.contactIcons=function(){return{PHONE:{icon:"mdi mdi-phone",type:"contact.phone",prefix:"tel:",suffix:""},MOBILE:{icon:"mdi mdi-cellphone-android",type:"contact.mobile",prefix:"tel:",suffix:""},FAX:{icon:"mdi mdi-fax",type:"contact.fax",prefix:"tel:",suffix:""},EMAIL:{icon:"mdi mdi-email",type:"contact.email",prefix:"mailto:",suffix:""},WEBSITE:{icon:"mdi mdi-web",type:"contact.website",prefix:"",suffix:""},FACEBOOK:{icon:"mdi mdi-facebook-box",type:"contact.facebook",prefix:"https://facebook.com/",suffix:""},TWITTER:{icon:"mdi mdi-twitter-box",type:"contact.twitter",prefix:"https://twitter.com/",suffix:""},INSTAGRAM:{icon:"mdi mdi-instagram",type:"contact.instagram",prefix:"https://www.instagram.com/",suffix:""},WHATSAPP:{icon:"mdi mdi-whatsapp",type:"contact.whatsapp",prefix:bowser.ios?"whatsapp://send?":"intent://send/",suffix:bowser.ios?"":"#Intent;scheme=smsto;package=com.whatsapp;action=android.intent.action.SENDTO;end"},SKYPE:{icon:"mdi mdi-skype",type:"contact.skype",prefix:"skype://",suffix:"?call"},VIBER:{icon:"mdi mdi-phone",type:"contact.viber",prefix:"viber://forward?",suffix:""},TELEGRAM:{icon:"mdi mdi-telegram",type:"contact.telegram",prefix:"tg://",suffix:""}}},t.paymentIcons=function(){return{PAYPAL:"pf pf-paypal",VISA:"pf pf-visa",MASTERCARD:"pf pf-mastercard",AMEX:"pf pf-american-express",BIT_COIN:"pf pf-bitcoin",CARTA_SI:"pf pf-carta-si",DINERS_CLUB:"pf pf-diners",DISCOVER:"pf pf-discover",JCB:"pf pf-jcb",UNION_PAY:"pf pf-unionpay",VISA_ELECTRON:"pf pf-visa-electron",V_PAY:"pf pf-visa",MAESTRO:"pf pf-maestro",CIRRUS:"pf pf-cirrus",POSTEPAY:"pf pf-postepay",APPLE_PAY:"pf pf-apple-pay",PAGSEGURO:"pf pf-pagseguro",BANCONTACT:"pf pf-bancontact-mister-cash",BANCOMAT:"pf pf-card"}},t.serviceIcon=function(){return{"service.type.technology.console":"mdi mdi-gamepad-variant","service.type.technology.games":"mdi mdi-gamepad-variant","service.type.technology.tv.flat":"mdi mdi-monitor","service.type.technology.tv":"mdi mdi-monitor","service.type.entertainment.children.tv":"mdi mdi-monitor","service.type.popular.pet.small":"mdi mdi-paw","service.type.popular.pet.medium":"mdi mdi-paw","service.type.popular.pet.large":"mdi mdi-paw","service.type.popular.pet.disabled":"mdi mdi-paw","service.type.popular.router":"mdi mdi-router-wireless","service.type.miscellaneous.air.conditioning":"mdi mdi-air-conditioner","service.type.room.air.conditioning":"mdi mdi-air-conditioner","service.type.miscellaneous.heating":"mdi mdi-air-conditioner","service.type.transport.parking.secured":"mdi mdi-parking","service.type.transport.parking.street":"mdi mdi-parking","service.type.transport.parking.accessible":"mdi mdi-parking","service.type.popular.bouquet":"mdi mdi-flower","service.type.popular.rose":"mdi mdi-flower","service.type.popular.breakfast.continental":"mdi mdi-food-fork-drink","service.type.popular.breakfast":"mdi mdi-food-fork-drink","service.type.popular.breakfast.room":"mdi mdi-food-fork-drink","service.type.miscellaneous.non­smoking.throughout":"mdi mdi-smoking-off","service.type.miscellaneous.non­smoking.rooms":"mdi mdi-smoking-off","service.type.popular.smoking.area":"mdi mdi-smoking","service.type.popular.smoking.room":"mdi mdi-smoking","service.type.popular.wifi.room":"mdi mdi-wifi","service.type.popular.wifi.all":"mdi mdi-wifi","service.type.popular.internet.point":"mdi mdi-wifi"}},t.transfersIcon=function(){return{CAR:"flaticon-car-black-side-view-pointing-left",LIMOUSINE:"flaticon-sedan-car-model",PULLMAN:"flaticon-bus-front",SHUTTLE:"flaticon-microbus",MINIVAN:"flaticon-van-black-transport-side-view-pointing-to-left",LUXURY_CAR:"flaticon-supercar"}},t.portalIcons=function(){return{PHONE:"mdi mdi-phone material-icons",EMAIL:"mdi mdi-email material-icons",PORTAL:"channel-icon channel-chroma",BOOKING:"channel-icon channel-booking",EXPEDIA:"channel-icon channel-expedia",VENERE:"channel-icon channel-venere",AIRBNB:"channel-icon channel-airbnb",AGODA:"channel-icon channel-agoda",OTHER:"mdi mdi-web material-icons"}},t})}(),function(){"use strict";function t(t){var a={};return a.response=function(a){return t.convertDateStringsToDates(a),a},a}t.$inject=["DateUtils"],angular.module("itaca.utils").factory("jsonDateInterceptor",t)}(),function(){"use strict";angular.module("itaca.utils").factory("NumberUtils",function(){var t={};return t.fixedDecimals=function(t,a){if(!t||0===t)return 0;var n=Number(t).toFixed(a||2);return Number(n).valueOf()},t.vatAmount=function(t,a){return this.fixedDecimals(t-this.taxableAmount(t,a))},t.taxableAmount=function(t,a){return this.fixedDecimals(a?t/((100+a)/100):t)},t.calculateDiscount=function(a,n,e){return a&&n?(a=parseFloat(a),n=parseFloat(n),e=e||"PRICE",t.fixedDecimals("PERCENTAGE"==e?a/100*n:100*n/a)):0},t.uniqueNumber=function(){var a=Date.now();return a<=t.uniqueNumber.previous?a=++t.uniqueNumber.previous:t.uniqueNumber.previous=a,a},t.uniqueNumber.previous=0,t.isEven=function(t){return t%2==0},t.isOdd=function(t){return 1==Math.abs(t%2)},t.defaultNumber=function(a,n){var e=Number(a);return isNaN(e)?t.defaultNumber(n,0):e},t.lcmArray=function(a){if(!_.isArray(a)||_.isEmpty(a))return!1;for(var n=a[0],e=1;e<a.length;e++)n=t.lcm(n,a[e]);return n},t.lcm=function(a,n){return"number"==typeof a&&"number"==typeof n&&(a&&n?Math.abs(a*n/t.gcd(a,n)):0)},t.gcd=function(t,a){for(t=Math.abs(t),a=Math.abs(a);a;){var n=a;a=t%a,t=n}return t},t})}(),function(){"use strict";angular.module("itaca.utils").factory("ObjectUtils",function(){var t={};return t.clearObject=function(t,a){if(t){var n=_.mapValues(t,function(t,n){return a&&a.test(n)?t:_.isArray(t)?[]:void 0});_.assign(t,n)}},t})}(),function(){"use strict";function t(t,a){({}).request=function(n){if(!navigator.onLine){a.warn("No connection! The request will be aborted: "+n.url);var e=t.defer();n.timeout=e.promise,e.reject()}return n}}t.$inject=["$q","$log"],angular.module("itaca.utils").factory("offlineInterceptor",t)}(),function(){"use strict";function t(t,a,n,e,o){var i=this;this.init=function(){i.all()},this.all=function(){var t=a.defer();return _.isPlainObject(o)?(i.prefixes=o,t.resolve(i.prefixes)):_.isString(o)&&n.get(o).then(function(a){i.prefixes=a.data.content,t.resolve(i.prefixes)},function(a){t.reject("Error loading phone prefixes")}),t.promise},this.get=function(t,n){if(_.isNil(t))return null;_.isNil(n)&&(n="code");var e=a.defer();return i.all().then(function(a){var o=_.find(a,function(a){return a[n]==t});e.resolve(o)},function(t){e.reject(t)}),e.promise},this.compile=function(t,a){return(t||"")+(a||"")},this.decompile=function(t){if(!t)return null;var n=a.defer(),e=i.decompileSimple(t);return e.prefix?i.get(e.prefix,"dial_code").then(function(t){e.prefix=t,n.resolve(e)},function(t){n.resolve(e)}):n.resolve(e),n.promise},this.decompileSimple=function(t){if(!t)return null;var a={};if(_.isEmpty(i.prefixes))a.number=t;else{var n=_.find(i.prefixes,function(a){return t.startsWith(a.dial_code)});n&&n.dial_code?(a.prefix=_.trim(n.dial_code),a.number=_.trim(t.substring(t.indexOf(n.dial_code)+n.dial_code.length))):a.number=t}return a}}angular.module("itaca.utils").provider("PhoneUtils",function(){var a,n="/phone-prefixes.json";this.setData=function(t){_.isPlainObject(t)?a=t:_.isString(t)&&(n=t)},this.$get=["$resource","$q","$http","libphonenumber",function(e,o,i,u){return new t(e,o,i,u,a||n)}]})}(),function(){"use strict";function t(t){var a={};return a.notifyNewProfileImage=function(a){t.$broadcast("profile-image-updated",a)},a.notifyNewCoverImage=function(a){t.$broadcast("cover-image-updated",a)},a.notifyLoadProfileImage=function(a){t.$broadcast("load-image-profile",a)},a}t.$inject=["$rootScope"],angular.module("itaca.utils").factory("ProfileUtils",t)}(),function(){"use strict";angular.module("itaca.utils").constant("REGEXP",t);var t={username:/^[a-z0-9_.-@]{3,32}$/,password:/^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@$!%*?&_+-]*)(?=\S+$).{8,32}$/,strong_password:/^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@$!%*?&_+-])(?=\S+$).{8,32}$/,email:/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.(aero|arpa|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro|travel|mobi|[a-z][a-z])|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i,zip:/^[0-9]{5}$/,province:/^[a-zA-Z]{2}$/,phone:/^([+]{0,1}[0-9]{2,4}){1}[0-9]{3,11}$/,creditCard:/^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\d{3})\d{11})$/,price:/^[0-9]+(\.[0-9]{1,2})?$/,priceNoStrict:/^[-+]*[0-9]+(\.[0-9]{1,2})?$/,vat:/^((AT)?U[0-9]{8}|(BE)?0[0-9]{9}|(BG)?[0-9]{9,10}|(CY)?[0-9]{8}L|(CZ)?[0-9]{8,10}|(DE)?[0-9]{9}|(DK)?[0-9]{8}|(EE)?[0-9]{9}|(EL|GR)?[0-9]{9}|(ES)?[0-9A-Z][0-9]{7}[0-9A-Z]|(FI)?[0-9]{8}|(FR)?[0-9A-Z]{2}[0-9]{9}|(GB)?([0-9]{9}([0-9]{3})?|[A-Z]{2}[0-9]{3})|(HU)?[0-9]{8}|(IE)?[0-9]S[0-9]{5}L|(IT)?[0-9]{11}|(LT)?([0-9]{9}|[0-9]{12})|(LU)?[0-9]{8}|(LV)?[0-9]{11}|(MT)?[0-9]{8}|(NL)?[0-9]{9}B[0-9]{2}|(PL)?[0-9]{10}|(PT)?[0-9]{9}|(RO)?[0-9]{2,10}|(SE)?[0-9]{12}|(SI)?[0-9]{8}|(SK)?[0-9]{10})$/,fiscalCode:/^([A-Za-z]{6}[0-9lmnpqrstuvLMNPQRSTUV]{2}[abcdehlmprstABCDEHLMPRST]{1}[0-9lmnpqrstuvLMNPQRSTUV]{2}[A-Za-z]{1}[0-9lmnpqrstuvLMNPQRSTUV]{3}[A-Za-z]{1})|([0-9]{11})$/,dateString:/^(\d{4}|\+\d{6})(?:-(\d{2})(?:-(\d{2})(?:T(\d{2}):(\d{2}):(\d{2})\.(\d{1,})(Z|([\-+])((\d{2}):(\d{2})|(\d{4})))?)?)?)?$/}}(),function(){"use strict";function t(t,a,n,e,o,i){var u={};return u.clearReservation=function(t,a){a?n.clearObject(t,/^(check(?:in$|out$))|^people$|^requestPeople$|^hotelId$/):n.clearObject(t)},u.storeLastReservation=function(){return o.setReservation(i)},u.loadLastReservation=function(){var t=o.getReservation();return t||((t=_.mapValues(i,function(t){if(_.isArray(t))return[]})).people={adults:1}),_.assignIn(i,t),e.convertDateStringsToDates(i),i&&i.checkin&&i.checkout&&moment(i.checkin).isBefore(e.absoluteMoment(),"days")&&(i={rooms:[]},u.storeLastReservation()),t},u.availableNights=function(t,a,n){if(!t||!a)return null;var o=e.absoluteMoment(t),i=e.absoluteMoment(a),u=_.isBoolean(n)&&!n?e.absoluteMoment(t):n?e.absoluteMoment(n):e.absoluteMoment();return i.isAfter(u,"days")&&o.isBefore(u,"days")?i.diff(u,"days"):i.diff(o,"days")},u.calculateGuestDocuments=function(t){t.identityDocuments=t.identityDocuments&&t.identityDocuments.length>0?t.identityDocuments:[],t.guestsCount=u.guestsCount(t.people,t.extraPeople);var a=parseInt(t.guestsCount.total);if(_.size(t.identityDocuments)>a)t.identityDocuments=_.dropRight(t.identityDocuments,_.size(t.identityDocuments)-a);else if(_.size(t.identityDocuments)<a)for(var n=a-_.size(t.identityDocuments),e=0;e<n;e++)t.identityDocuments.push({})},u.peopleSummary=function(a,n){a||(a={}),n||(n={});var e=u.guestsCount(a,n);return!e&&e.total<=0?t("people.none").then(function(t){return t}):t(["people.adult","people.adults","people.child","people.children","people.boy","people.boys","people.kid","people.kids"]).then(function(t){var e="";if(a.adults||n.adults){var o=parseInt(a.adults||0)+parseInt(n.adults||0);o>0&&(e+=o+" "+(o<2)?t["people.adult"]:t["people.adults"])}if(a.boys||n.boys){var i=parseInt(a.boys||0)+parseInt(n.boys||0);i>0&&(e+=a.adults||n.adults?", ":"",e+=i+" "+(i<2)?t["people.boy"]:t["people.boys"])}if(a.children||n.children){var u=parseInt(a.children||0)+parseInt(n.children||0);u>0&&(e+=a.adults||n.adults||a.boys||n.boys?", ":"",e+=u+" "+(u<2)?t["people.child"]:t["people.children"])}if(a.kids||n.kids){var r=parseInt(a.kids||0)+parseInt(n.kids||0);r>0&&(e+=a.adults||n.adults||a.boys||n.boys||a.children||n.children?", ":"",e+=r+" "+(r<2)?t["people.kid"]:t["people.kids"])}return e.toLowerCase()})},u.extraPeople=function(t){var a={adults:0};return _.forEach(t,function(t){if(t.people){var n=t.people;n.adults&&(a.adults=a.adults?parseInt(a.adults)+parseInt(n.adults):parseInt(n.adults)),n.boys&&(a.boys=a.boys?parseInt(a.boys)+parseInt(n.boys):parseInt(n.boys)),n.children&&(a.children=a.children?parseInt(a.children)+parseInt(n.children):parseInt(n.children)),n.kids&&(a.kids=a.kids?parseInt(a.kids)+parseInt(n.kids):parseInt(n.kids))}}),a},u.totalPeople=function(t,n){return t=t||{adults:0,boys:0,children:0,kids:0},n=n||{adults:0,boys:0,children:0,kids:0},{adults:a.defaultNumber(t.adults)+a.defaultNumber(n.adults),boys:a.defaultNumber(t.boys)+a.defaultNumber(n.boys),children:a.defaultNumber(t.children)+a.defaultNumber(n.children),kids:a.defaultNumber(t.kids)+a.defaultNumber(n.kids)}},u.guestsCount=function(t,a){t=t||{adults:0,boys:0,children:0,kids:0},a=a||{adults:0,boys:0,children:0,kids:0};var n=0;!_.isNil(t.adults)&&t.adults>0&&(n+=parseInt(t.adults)),!_.isNil(t.boys)&&t.boys>0&&(n+=parseInt(t.boys)),!_.isNil(t.children)&&t.children>0&&(n+=parseInt(t.children)),!_.isNil(t.kids)&&t.kids>0&&(n+=parseInt(t.kids));var e=0,o=!1;return!_.isNil(a.adults)&&a.adults>0&&(e+=parseInt(a.adults)),!_.isNil(a.boys)&&a.boys>0&&(o=!0,e+=parseInt(a.boys)),!_.isNil(a.children)&&a.children>0&&(o=!0,e+=parseInt(a.children)),!_.isNil(a.kids)&&a.kids>0&&(o=!0,e+=parseInt(a.kids)),{standard:n,extra:e,extraHasChildren:o,total:n+e}},u.guestsCountByBeds=function(t,a,n){var e=0,o=0,i=!1,u=!1;if(t&&angular.isArray(t)&&_.forEach(t,function(t){e+=t.maxPerson*t.count}),a&&a.length){n=n||0;for(var r=angular.copy(a),l=parseInt(n);l;){var s=_.maxBy(r,"maxPerson");if(!s)break;_.pull(r,s);var c=l-s.count>=0?s.count:l;o+=s.maxPerson*c,l-=c,i||(i=null!=s.people&&s.people.adults),u||(u=s.people&&(s.people.boys||s.people.children||s.people.kids))}}return{standard:e,extra:o,extraHasAdults:i,extraHasChildren:u,partial:e+o}},u.peopleByRooms=function(t,a){var n={adults:0,boys:0,children:0,kids:0};return _.forEach(t,function(t,e,o){var i=angular.copy(t.people||{});a&&!_.isEmpty(t.beds)&&(i.adults=0,i.boys=0,i.children=0,i.kids=0,_.forEach(t.beds,function(t){i.adults=parseInt(t.people.adults)?i.adults+parseInt(t.people.adults):i.adults,i.boys=parseInt(t.people.boys)?i.boys+parseInt(t.people.boys):i.boys,i.children=parseInt(t.people.children)?i.children+parseInt(t.people.children):i.children,i.kids=parseInt(t.people.kids)?i.kids+parseInt(t.people.kids):i.kids})),n.adults=parseInt(i.adults)?n.adults+parseInt(i.adults):n.adults,n.boys=parseInt(i.boys)?n.boys+parseInt(i.boys):n.boys,n.children=parseInt(i.children)?n.children+parseInt(i.children):n.children,n.kids=parseInt(i.kids)?n.kids+parseInt(i.kids):n.kids;var u=angular.copy(t.extraPeople||{});a&&!_.isEmpty(t.otherBeds)&&(u.adults=0,u.boys=0,u.children=0,u.kids=0,_.forEach(t.otherBeds,function(t){u.adults=parseInt(t.people.adults)?u.adults+parseInt(t.people.adults):u.adults,u.boys=parseInt(t.people.boys)?u.boys+parseInt(t.people.boys):u.boys,u.children=parseInt(t.people.children)?u.children+parseInt(t.people.children):u.children,u.kids=parseInt(t.people.kids)?u.kids+parseInt(t.people.kids):u.kids})),u&&(n.adults=parseInt(u.adults)?n.adults+parseInt(u.adults):n.adults,n.boys=parseInt(u.boys)?n.boys+parseInt(u.boys):n.boys,n.children=parseInt(u.children)?n.children+parseInt(u.children):n.children,n.kids=parseInt(u.kids)?n.kids+parseInt(u.kids):n.kids)}),n},u.peopleByMax=function(t,a,n){if(!t&&!a)return{};if(!t)return angular.copy(a);if(!a)return angular.copy(t);var e=n;e||(e=-1);var o=_.isNil(t.adults)?0:_.isNil(a.adults)?t.adults:t.adults<=a.adults?t.adults:a.adults;e>=0&&(e-=o=o<=e?o:e);var i=_.isNil(t.boys)?0:_.isNil(a.boys)?t.boys:t.boys<=a.boys?t.boys:a.boys;e>=0&&(e-=i=i<=e?i:e);var u=_.isNil(t.children)?0:_.isNil(a.children)?t.children:t.children<=a.children?t.children:a.children;e>=0&&(e-=u=u<=e?u:e);var r=_.isNil(t.kids)?0:_.isNil(a.kids)?t.kids:t.kids<=a.kids?t.kids:a.kids;return e>=0&&(e-=r=r<=e?r:e),{adults:o,boys:i,children:u,kids:r}},u.peopleAvailabilityArrays=function(t,a,n){a=a||{adults:0,boys:0,children:0,kids:0};for(var e=u.guestsCount(a).standard,o=parseInt(n||0)-e,i={adults:0,boys:0,children:0,kids:0},r=1;r<=parseInt(t.adults||0);r++)a.adults=a.adults||0,(l=!(r<=a.adults)&&o+a.adults-r<0)||(i.adults=r);for(r=1;r<=parseInt(t.boys||0);r++)a.boys=a.boys||0,(l=!(r<=a.boys)&&o+a.boys-r<0)||(i.boys=r);for(r=1;r<=parseInt(t.children||0);r++)a.children=a.children||0,(l=!(r<=a.children)&&o+a.children-r<0)||(i.children=r);for(r=1;r<=parseInt(t.kids||0);r++){a.kids=a.kids||0;var l=!(r<=a.kids)&&o+a.kids-r<0;l||(i.kids=r)}return i},u.roomSold=function(t,n,e,o,i,r,l,s){if(!t||!n||!e)return{};o||(o={adults:1});var c=o.adults>=n.guestsCount.standard?n.guestsCount.standard:o.adults;i||(i={adults:0});var m=i.adults>=n.guestsCount.extra?n.guestsCount.extra:i.adults,d={type:n,totalRate:t,cancellationPolicy:t.cancellationPolicy?t.cancellationPolicy:null,noShowPolicy:t.noShowPolicy?t.noShowPolicy:null,status:"CONFIRMED",services:s||[],beds:r||[],otherBeds:l||[],people:o,extraPeople:i,creationDate:new Date};d.guestsCount=u.guestsCount(c,m);var f=(100+e)/100,p=t.amount.finalAmount/f;return d.totalRate.amount.vatAmount=a.fixedDecimals(p*e/100),d.totalRate.amount.vatRate=e,d},u.serviceSold=function(t,n,e,o){if(!t)return{};t.maxCount||(t.maxCount=1),o||(o=1),o>t.maxCount&&-1!=t.maxCount&&(o=t.maxCount),n||(n={adults:0,boys:0,kids:0,children:0});var i=moment.duration(e,"days"),u={type:"PRICE",currency:"EUR",initialAmount:0,finalAmount:0,vatRate:0,vatAmount:0};switch(t.paymentType){case"SINGLE":var r=t.paymentOptions[0];switch(t.frequency){case"LUMP_SUM":u.finalAmount=r.amount.finalAmount;break;case"DAILY":u.finalAmount=r.amount.finalAmount*e;break;case"MONTHLY":u.finalAmount=r.amount.finalAmount*Math.ceil(i.asMonths());break;case"YEARLY":u.finalAmount=r.amount.finalAmount*Math.ceil(i.asYears())}u.vatRate=r.amount.vatRate;break;case"PER_PERSON":_.forEach(t.paymentOptions,function(a){var o=0;switch(a.size){case"PER_ADULT":n.adults&&(o=a.amount.finalAmount*n.adults,u.vatRate=u.vatRate&&u.vatRate>a.amount.vatRate?u.vatRate:a.amount.vatRate);break;case"PER_BOY":n.boys&&(o=a.amount.finalAmount*n.boys,u.vatRate=u.vatRate&&u.vatRate>a.amount.vatRate?u.vatRate:a.amount.vatRate);break;case"PER_CHILD":n.children&&(o=a.amount.finalAmount*n.children,u.vatRate=u.vatRate&&u.vatRate>a.amount.vatRate?u.vatRate:a.amount.vatRate);break;case"PER_KID":n.kids&&(o=a.amount.finalAmount*n.kids,u.vatRate=u.vatRate&&u.vatRate>a.amount.vatRate?u.vatRate:a.amount.vatRate)}switch(t.frequency){case"DAILY":case"NIGHTLY":o*=e;break;case"MONTHLY":o*=Math.ceil(i.asMonths());break;case"YEARLY":o*=Math.ceil(i.asYears())}u.finalAmount+=o})}return u.finalAmount=u.finalAmount*o,u.initialAmount=u.finalAmount,u.vatAmount=a.vatAmount(u.finalAmount,u.vatRate),{service:t,amount:u,people:n,included:"INCLUDED"==t.bookability,status:"CONFIRMED",count:o}},u.updateServiceSoldPrice=function(t,n,o,i,r){var l=o;s.startDate&&s.endDate&&(l=e.absoluteMoment(s.endDate).diff(e.absoluteMoment(t.startDate),"days"));var s=r?angular.copy(t):null;_.assign(t,u.serviceSold(t.service,n,l,i)),t.amount=s?s.amount:t.amount,t.amount.vatAmount=a.vatAmount(t.amount.finalAmount,t.amount.vatRate)},u.bedSold=function(t,n,e,o){if(!t)return{};var i={type:"PRICE",currency:"EUR",initialAmount:0,finalAmount:0,vatRate:o,vatAmount:0};return n.adults&&n.adults>0&&(i.finalAmount+=n.adults*t.adultsPrice),n.boys&&n.boys>0&&(i.finalAmount+=n.boys*t.boysPrice),n.children&&n.children>0&&(i.finalAmount+=n.children*t.childrenPrice),n.kids&&n.kids>0&&(i.finalAmount+=n.kids*t.kidsPrice),"DAILY"!=t.frequency&&"NIGHTLY"!=t.frequency||(i.finalAmount*=e),i.initialAmount=i.finalAmount,i.vatAmount=a.vatAmount(i.finalAmount,i.vatRate),{bed:t,people:n||{},amount:i,status:"CONFIRMED"}},u.updateBedSoldPrice=function(t,n,o,i,r){var l=o;t.startDate&&t.endDate&&(l=e.absoluteMoment(t.endDate).diff(e.absoluteMoment(t.startDate),"days"));var s=r?angular.copy(t):null;_.assign(t,u.bedSold(t.bed,n,l,i)),t.amount=s?s.amount:t.amount,t.amount.vatAmount=a.vatAmount(t.amount.finalAmount,t.amount.vatRate)},u.updatePolicyAmount=function(t,n,e){if(t&&n&&e){var o=n.cancellation.chargeNights,i=n.cancellation.percentage||0;i=i<=100?i:100;var u={finalAmount:0};if(o<0||o==e)u.finalAmount=a.fixedDecimals(t.totalRate.amount.finalAmount);else for(var r=0;r<o;r++){var l=t.totalRate.dailyRates[r];l&&(u.finalAmount+=a.fixedDecimals(l.amount.finalAmount))}u.finalAmount=u.finalAmount*(i/100),n.amount=u}},u.calculateTotalPrice=function(t){if(t){e.absoluteMoment(t.checkout).diff(e.absoluteMoment(t.checkin),"days");var n=0,o=0,i=0,u=0,r=0,l=0,s=[],c=t.hotel&&t.hotel.vatTax&&t.hotel.vatTax.finalAmount?t.hotel.vatTax.finalAmount:10,m={},d=0,f=0,p=0,A=0;_.forEach(t.rooms,function(t,e,v){t.totalRate.amount.vatRate=c,t.totalRate.amount.vatAmount=a.vatAmount(t.totalRate.amount.finalAmount,t.totalRate.amount.vatRate),"CONFIRMED"==t.status||"EARLY_CHECKOUT"==t.status?(n+=t.totalRate.amount.initialAmount,o+=t.totalRate.amount.finalAmount,r+=t.totalRate.amount.vatAmount,_.forEach(t.totalRate.dailyRates,function(t){if(!_.isNil(t.promotion)){var a=0;a="PRICE"!=t.promotion.discount.type?t.amount.initialAmount-t.amount.initialAmount*((100-t.promotion.discount.finalAmount)/100):t.amount.initialAmount-t.promotion.discount.finalAmount;var n=_.find(s,function(a){return t.promotion.id&&a.promo.id==t.promotion.id});n?n.price+=a:s.push({promo:t.promotion,percentage:"PRICE"!=t.promotion.discount.type?t.promotion.discount.finalAmount+"%":null,price:a}),l+=a}}),d+=t.totalRate.amount.initialAmount,A+=t.totalRate.amount.initialAmount,t.totalRate.amount.vatRate?m[t.totalRate.amount.vatRate]=m[t.totalRate.amount.vatRate]?m[t.totalRate.amount.vatRate]+t.totalRate.amount.vatAmount:t.totalRate.amount.vatAmount:m[c]=m[c]?m[c]+t.totalRate.amount.vatAmount:t.totalRate.amount.vatAmount,_.forEach(t.services,function(t){n+=t.amount.finalAmount,o+=t.amount.finalAmount,r+=t.amount.vatAmount,t.amount.initialAmount=t.amount.initialAmount||angular.copy(t.amount.finalAmount),f+=t.amount.initialAmount,A+=t.amount.initialAmount;var a=!1;_.forEach(m,function(n,e){e&&e==t.amount.vatRate&&(m[e]+=t.amount.vatAmount,a=!0)}),a||t.amount.vatRate&&(m[t.amount.vatRate]=m[t.amount.vatRate]?m[t.amount.vatRate]+t.amount.vatAmount:t.amount.vatAmount)}),_.forEach(t.otherBeds,function(t){t.amount&&(n+=t.amount.finalAmount,o+=t.amount.finalAmount,r+=t.amount.vatAmount,t.amount.initialAmount=t.amount.initialAmount||angular.copy(t.amount.finalAmount),p+=t.amount.initialAmount,A+=t.amount.initialAmount,t.amount.vatRate?m[t.amount.vatRate]=m[t.amount.vatRate]?m[t.amount.vatRate]+t.amount.vatAmount:t.amount.vatAmount:m[c]=m[c]?m[c]+t.amount.vatAmount:t.amount.vatAmount)})):(i+=t.cancelAmount.initialAmount,u+=t.cancelAmount.finalAmount)}),t.cancelAmount||(t.cancelAmount={currency:"EUR",type:"PRICE"});var v=["CANCELLED","NO_SHOW"];t.cancelAmount.initialAmount=_.includes(v,t.status)?t.cancelAmount.initialAmount:a.fixedDecimals(i),t.cancelAmount.finalAmount=_.includes(v,t.status)?t.cancelAmount.finalAmount:a.fixedDecimals(u),t.totalAmount||(t.totalAmount={currency:"EUR",type:"PRICE"}),t.totalAmount.initialAmount=_.includes(v,t.status)?t.totalAmount.initialAmount:n,t.totalAmount.finalAmount=_.includes(v,t.status)?t.totalAmount.finalAmount:o,t.discount||(t.discount={finalAmount:0,type:"PERCENTAGE"});var y=a.calculateDiscount(t.totalAmount.finalAmount,t.discount.finalAmount,"PERCENTAGE");t.totalAmount.discountRate=t.discount.finalAmount,t.totalAmount.discountAmount=y,t.totalAmount.finalAmount=t.totalAmount.finalAmount-y,t.grandAmount={initialAmount:t.totalAmount.initialAmount,finalAmount:t.totalAmount.finalAmount},t.grandAmount.initialAmount+=t.cancelAmount&&t.cancelAmount.initialAmount?t.cancelAmount.initialAmount:0,t.grandAmount.finalAmount+=t.cancelAmount&&t.cancelAmount.finalAmount?t.cancelAmount.finalAmount:0;var h=A-l-t.totalAmount.finalAmount-y;if(t.totalPriceDetails={rooms:a.fixedDecimals(d),services:a.fixedDecimals(f),otherBeds:a.fixedDecimals(p),subTotal:a.fixedDecimals(A),discountPromo:a.fixedDecimals(l),discountHotel:a.fixedDecimals(h)},t.arrayPromo=s,t.totalVat={total:r,vatMap:m},t.totalAmount.discountRate){var R={};r=0,_.forEach(m,function(a,n){R[n]=a-parseFloat(a)/100*parseFloat(t.totalAmount.discountRate),r+=R[n]}),t.totalVat={total:r,vatMap:R}}}},u.calculateVatMap=function(t,a){if(t){var n=0,e=t.hotel&&t.hotel.vatTax&&t.hotel.vatTax.finalAmount?t.hotel.vatTax.finalAmount:10,o={};if(_.forEach(t.rooms,function(t,a,i){"EARLY_CHECKOUT"==t.status?(n+=t.cancelAmount.vatAmount,t.totalRate.cancelAmount.vatRate?o[t.totalRate.cancelAmount.vatRate]=o[t.totalRate.cancelAmount.vatRate]?o[t.totalRate.cancelAmount.vatRate]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount:o[e]=o[e]?o[e]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount,_.forEach(t.services,function(t){n+=t.cancelAmount.vatAmount;var a=!1;_.forEach(o,function(n,e){e&&e==t.cancelAmount.vatRate&&(o[e]+=t.cancelAmount.vatAmount,a=!0)}),a||t.cancelAmount.vatRate&&(o[t.cancelAmount.vatRate]=o[t.cancelAmount.vatRate]?o[t.cancelAmount.vatRate]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount)}),_.forEach(t.otherBeds,function(t){t.cancelAmount&&(n+=t.cancelAmount.vatAmount,t.cancelAmount.vatRate?o[t.cancelAmount.vatRate]=o[t.cancelAmount.vatRate]?o[t.cancelAmount.vatRate]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount:o[e]=o[e]?o[e]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount)})):"CONFIRMED"==t.status&&(n+=t.totalRate.amount.vatAmount,t.totalRate.amount.vatRate?o[t.totalRate.amount.vatRate]=o[t.totalRate.amount.vatRate]?o[t.totalRate.amount.vatRate]+t.totalRate.amount.vatAmount:t.totalRate.amount.vatAmount:o[e]=o[e]?o[e]+t.totalRate.amount.vatAmount:t.totalRate.amount.vatAmount,_.forEach(t.services,function(t){n+=t.amount.vatAmount;var a=!1;_.forEach(o,function(n,e){e&&e==t.amount.vatRate&&(o[e]+=t.amount.vatAmount,a=!0)}),a||t.amount.vatRate&&(o[t.amount.vatRate]=o[t.amount.vatRate]?o[t.amount.vatRate]+t.amount.vatAmount:t.amount.vatAmount)}),_.forEach(t.otherBeds,function(t){t.amount&&(n+=t.amount.vatAmount,t.amount.vatRate?o[t.amount.vatRate]=o[t.amount.vatRate]?o[t.amount.vatRate]+t.amount.vatAmount:t.amount.vatAmount:o[e]=o[e]?o[e]+t.amount.vatAmount:t.amount.vatAmount)}))}),a>=0){var i={};n=0,_.forEach(o,function(a,e){i[e]=a-parseFloat(a)/100*parseFloat(t.totalAmount.discountRate),n+=i[e]}),t.totalVat={total:n,vatMap:i}}}},u.applyDiscount=function(t,n,e){if(t&&n){e=e||"PRICE";var o,i,u=t.totalAmount.finalAmount;"PERCENTAGE"==e?(o=a.calculateDiscount(u,n,e),i=n):(o=n,i=a.calculateDiscount(u,n,e)),t.totalAmount.discountRate=i,t.totalAmount.discountAmount=o,t.totalAmount.finalAmount=u-o}},u.calculateTotalTransfers=function(t){if(t){(_.isNil(t.externalServices)||_.isNil(t.externalServices.transfersServices))&&(t.externalServices={transfersServices:[]});var a=0,n=0;_.forEach(t.externalServices.transfersServices,function(t,e,o){"CONFIRMED"==t.status&&(a+=t.amount.finalAmount,n+=t.amount.vatAmount,t.surcharge&&(a+=t.transferService.nightCharge.finalAmount))}),t.totalTransfers={totalAmount:a,vatAmount:n,taxableAmount:a-n}}},u.calculateTotalRooms=function(t){if(t&&!_.isNil(t.rooms)){var a=0,n=0,e=0,o=0,i=0,u=[],r=0,l=t.rooms.length;return _.forEach(t.rooms,function(t,s,c){if("CONFIRMED"==t.status||"EARLY_CHECKOUT"==t.status){if(t.extendedRoom?(r+=1,l-=1):a+=1,!_.isEmpty(t.dailyDetails)&&_.some(t.dailyDetails,"room")){var m=_.uniqBy(t.dailyDetails,"room.name");u.push(_.size(m)>1?m[0].room.name+"+":m[0].room.name)}"STANDARD"==t.totalRate.type?t.totalRate.cancellationPolicy&&t.totalRate.cancellationPolicy.flexible?o++:e++:"NOT_REFUNDABLE"==t.totalRate.type&&i++}else n+=1}),{active:a,cancelled:n,total:l,standard:e,flexible:o,notRefundable:i,physicalRooms:u,extendedRooms:r}}},u.calculateRoomTotalPrice=function(t){if(t){var a={initialAmount:t.totalRate.amount.initialAmount,finalAmount:t.totalRate.amount.finalAmount,servicesAmount:0,bedsAmount:0};_.forEach(t.services,function(t){a.initialAmount+=_.isNil(t.amount.initialAmount)?t.amount.finalAmount:t.amount.initialAmount,a.finalAmount+=t.amount.finalAmount,a.servicesAmount+=t.amount.finalAmount}),_.forEach(t.otherBeds,function(t){a.initialAmount+=_.isNil(t.amount.initialAmount)?t.amount.finalAmount:t.amount.initialAmount,a.finalAmount+=t.amount.finalAmount,a.bedsAmount+=t.amount.finalAmount}),t.totalPrice=a}},u.createCancelledReservation=function(t,n){var o=this;n=n||(t.hotel.vatTax?t.hotel.vatTax.finalAmount:0);var i=angular.copy(t);i.cancelAmount?_.assign(i.cancelAmount,{initialAmount:0,finalAmount:0}):i.cancelAmount={initialAmount:0,finalAmount:0};var u,r=moment();return _.forEach(i.rooms,function(t){if("CONFIRMED"==t.status){if(t.endDate&&e.absoluteMoment(t.endDate).isBefore(r,"days"))return;t.cancelled=!1,_.assign(t,o.createCancelledRoom(t,i,r,n)),i.cancelAmount.initialAmount+=a.fixedDecimals(t.cancelAmount.finalAmount),i.cancelAmount.finalAmount+=a.fixedDecimals(t.cancelAmount.finalAmount)}else t.cancelled=!0}),u=i.cancelAmount.finalAmount<=0?"reservation.manager.cancel.free":"reservation.manager.cancel.penalty",i.statusText=u,i.cancelDate=r.toDate(),i.status="CANCELLED",i.sendEmail=!0,i},u.createCancelledRoom=function(t,n,o,i){var u=o?e.absoluteMoment(o):e.absoluteMoment();if(t.endDate&&e.absoluteMoment(t.endDate).isBefore(u,"days"))return t;u.diff(e.absoluteMoment(t.startDate||n.checkin),"days");var r=angular.copy(t);return r.cancelled=!1,r.cancelAmount=r.cancelAmount?r.cancelAmount:{},r.totalRate.cancellationPolicy?(r.tempStatus="penalty",r.cancelAmount.finalAmount=r.totalRate.cancellationPolicy.amount.finalAmount,r.totalRate.cancellationPolicy.limitDate&&moment(r.totalRate.cancellationPolicy.limitDate).utcOffset((n.hotel.addressInfo.offset||0)/60).isSameOrAfter(u)&&(r.cancelAmount.finalAmount=0,r.tempStatus="free")):(r.cancelAmount.finalAmount=0,r.tempStatus="free"),r.cancelAmount.initialAmount=a.fixedDecimals(r.cancelAmount.finalAmount),r.cancelAmount.finalAmount=a.fixedDecimals(r.cancelAmount.finalAmount),r.cancelled=!1,r.cancelAmount.vatRate=r.totalRate.amount.vatRate?r.totalRate.amount.vatRate:i,r.cancelAmount.vatAmount=a.vatAmount(r.cancelAmount.finalAmount,r.cancelAmount.vatRate),r.cancelDate=u.toDate(),r.status="CANCELLED",_.forEach(r.services,function(t){t.status="CANCELLED"}),_.forEach(r.otherBeds,function(t){t.status="CANCELLED"}),r},u.createNoShowReservation=function(t,n){n=n||(t.hotel.vatTax?t.hotel.vatTax.finalAmount:0);var e=angular.copy(t),o=new Date,i=(moment(o),0);return _.forEach(e.rooms,function(t){t.cancelAmount=t.cancelAmount?t.cancelAmount:{},t.totalRate.noShowPolicy?(t.tempStatus="penalty",t.cancelAmount.finalAmount=t.totalRate.noShowPolicy.amount.finalAmount):(t.cancelAmount.finalAmount=0,t.tempStatus="free"),t.cancelAmount.finalAmount=a.fixedDecimals(t.cancelAmount.finalAmount),"CONFIRMED"==t.status?(i+=t.cancelAmount.finalAmount,t.cancelled=!1,t.cancelAmount.vatRate=t.totalRate.amount.vatRate?t.totalRate.amount.vatRate:n,t.cancelAmount.vatAmount=a.vatAmount(t.cancelAmount.finalAmount,t.cancelAmount.vatRate),t.cancelDate=o,t.status="NO_SHOW",_.forEach(t.services,function(t){t.status="NO_SHOW"}),_.forEach(t.otherBeds,function(t){t.status="NO_SHOW"})):t.cancelled=!0}),e.cancelAmount={initialAmount:a.fixedDecimals(i),finalAmount:a.fixedDecimals(i),total:a.fixedDecimals(0)},e.cancelDate=o,e.status="NO_SHOW",e.sendEmail=!0,e},u.createEarlyCheckoutReservation=function(t,n){var o=this;n=n||(t.hotel.vatTax?t.hotel.vatTax.finalAmount:0);var i=angular.copy(t),u=new Date,r=e.absoluteMoment(u);i.initialAmount=angular.copy(i.totalAmount),_.assign(i.totalAmount,{initialAmount:0,finalAmount:0});var l,s,c,m,d,f;return r.diff(e.absoluteMoment(i.checkin),"days")>0?(_.forEach(i.rooms,function(t){if("CONFIRMED"==t.status){if(t.endDate&&e.absoluteMoment(t.endDate).isBefore(r,"days"))return void(t.status="EARLY_CHECKOUT");t.cancelled=!1,_.assign(t,o.createEarlyCheckoutRoom(t,i,r,n)),t.checkoutDone=u,i.totalAmount.initialAmount+=t.totalRoomAmount.initialAmount,i.totalAmount.finalAmount+=t.totalRoomAmount.finalAmount}else t.cancelled=!0}),s="reservation.earlycheckout.title",c="reservation.earlycheckout.reason.label",m="reservation.earlycheckout.penalty",l="reservation.manager.earlyCheckout",d="reservation.earlycheckout.free.label",f="reservation.earlycheckout.penalty.label",i.checkoutDone=u,i.status="EARLY_CHECKOUT",i.totalAmount.initialAmount=a.fixedDecimals(i.totalAmount.initialAmount),i.totalAmount.finalAmount=a.fixedDecimals(i.totalAmount.finalAmount),i.totalAmount.vatRate=i.totalAmount.vatRate||n,i.totalAmount.vatAmount=a.vatAmount(i.totalAmount.finalAmount,i.totalAmount.vatRate)):(s="reservation.deleteCheckin.title",c="reservation.deleteCheckin.reason.label",m="reservation.deleteCheckin.penalty",l=(i=o.createCancelledReservation(t,n)).cancelAmount.finalAmount>0?"reservation.manager.deleteCheckin":"reservation.manager.deleteCheckin.free",d="reservation.cancellation.free",f="reservation.bill.penalty"),i.title=s,i.reason=c,i.penalty=m,i.statusText=l,i.freeLabel=d,i.penaltyLabel=f,i.sendEmail=!0,i},u.createEarlyCheckoutRoom=function(t,a,n,e){var o=u.createTerminatedRoom(t,a,n,e,"EARLY_CHECKOUT");return o&&(o.checkoutDone=new Date),o},u.createTerminatedRoom=function(t,n,o,i,u){if(!t||"CONFIRMED"!=t.status)return null;var r=o?e.absoluteMoment(o):e.absoluteMoment(),l=t.endDate?e.absoluteMoment(t.endDate):null;if(l&&l.isSame(r,"days"))return angular.copy(t);var s=e.absoluteMoment(t.startDate||n.checkin);l=l||e.absoluteMoment(n.checkout);var c=moment.range(s,l);if(!c.contains(r,{exclusive:!0}))return null;var m=this,d=t.totalRate.amount.currency;i=i||t.totalRate.amount.vatRate||n.hotel.vatTax.finalAmount;var f=angular.copy(t);f.totalRoomAmount={initialAmount:0,finalAmount:0,currency:d},f.cancelled=!1;var p=moment.range(s,r);f.paymentServices=[],_.forEach(f.services,function(t){m.terminateServiceSold(t,p,u,c)&&(t.included||"INCLUDED"==t.service.bookability||f.paymentServices.push(t),f.totalRoomAmount.initialAmount+=a.fixedDecimals(t.amount.initialAmount||t.amount.finalAmount),f.totalRoomAmount.finalAmount+=a.fixedDecimals(t.amount.finalAmount))}),_.forEach(f.beds,function(t){t&&"CONFIRMED"==t.status&&(t.status=u||t.status)}),_.forEach(f.otherBeds,function(t){m.terminateBedSold(t,p,i,u,c)&&(f.totalRoomAmount.initialAmount+=a.fixedDecimals(t.amount.initialAmount||t.amount.finalAmount),f.totalRoomAmount.finalAmount+=a.fixedDecimals(t.amount.finalAmount))}),f.amount=f.totalRoomAmount,f.status=u||t.status,f.endDate=e.absoluteDate(p.end),f.initialAmount=angular.copy(t.totalRate.amount),f.tempStatus="earlyCheckout";var A="EARLY_CHECKOUT"==f.status&&p.end.isSame(e.absoluteMoment(),"day")?moment.range(p.start,moment(p.end).add(1,"days")):p;if(f.totalRate.initialDailyRates=angular.copy(f.totalRate.dailyRates),"STANDARD"==f.totalRate.type){_.forEach(f.totalRate.initialDailyRates,function(t){t.disabled=!A.contains(t.date,{exclusive:!0}),t.toRemove=t.disabled}),f.totalRate.dailyRates=_.filter(f.totalRate.initialDailyRates,function(t){return!t.toRemove});g={initialAmount:0,finalAmount:0,currency:d};_.forEach(f.totalRate.dailyRates,function(t){g.initialAmount+=a.fixedDecimals(t.amount.initialAmount||t.amount.finalAmount),g.finalAmount+=a.fixedDecimals(t.amount.finalAmount)}),_.assign(f.totalRate.amount,g)}else if("NOT_REFUNDABLE"==f.totalRate.type){var v=f.totalRate.cancellationPolicy?f.totalRate.cancellationPolicy.cancellation:null,y=v?v.chargeNights>0?v.chargeNights:-1:null,h=y?y>0&&y<c.diff("days")?moment.range(c.start,moment(c.start).add(y,"days")):c:null,R=h&&h.diff("days")>A.diff("days")?h:A;_.forEach(f.totalRate.initialDailyRates,function(t){var n=e.absoluteMoment(t.date);R.contains(n,{exclusive:!0})?(t.disabled=!1,t.toRemove=!1,!A.contains(n,{exclusive:!0})&&h&&h.contains(n,{exclusive:!0})&&(f.tempStatus="penalty",t.disabled=!0,v.percentage<100&&(t.amount.initialAmount=t.amount.finalAmount,t.amount.finalAmount=a.calculateDiscount(t.amount.finalAmount,v.percentage,"PERCENTAGE")))):(t.disabled=!0,t.toRemove=!0)}),f.totalRate.dailyRates=_.filter(f.totalRate.initialDailyRates,function(t){return!t.toRemove});var g={initialAmount:0,finalAmount:0,currency:d};_.forEach(f.totalRate.dailyRates,function(t){g.initialAmount+=a.fixedDecimals(t.amount.initialAmount||t.amount.finalAmount),g.finalAmount+=a.fixedDecimals(t.amount.finalAmount)}),g.finalAmount<(f.totalRate.cancellationPolicy&&f.totalRate.cancellationPolicy.amount?f.totalRate.cancellationPolicy.amount.finalAmount:0)&&(g=f.totalRate.cancellationPolicy.amount,f.tempStatus="penalty"),_.assign(f.totalRate.amount,g)}return f.totalRate.amount.vatRate=f.totalRate.amount.vatRate||i,f.totalRate.amount.vatAmount=a.vatAmount(f.totalRate.amount.finalAmount,f.totalRate.amount.vatRate),f.totalRoomAmount.initialAmount=a.fixedDecimals(f.totalRoomAmount.initialAmount+f.totalRate.amount.initialAmount),f.totalRoomAmount.finalAmount=a.fixedDecimals(f.totalRoomAmount.finalAmount+f.totalRate.amount.finalAmount),m.calculateRoomTotalPrice(f),f},u.terminateServiceSold=function(t,a,n,o){if(!t||"CONFIRMED"!=t.status)return!1;var i=moment.range(e.absoluteMoment(t.startDate||a.start),e.absoluteMoment(t.endDate||a.end));if(!i.contains(a.end))return!1;var r=(i=moment.range(i.start,a.end)).diff("days"),l=u.serviceSold(t.service,t.people,r,t.count);if(t.status=n||t.status,t.initialAmount=angular.copy(t.amount),t.amount=angular.copy(l.amount),"DAILY"==t.service.frequency||"NIGHTLY"==t.service.frequency){if(o&&o.start&&o.end){t.dailyRates=[];for(var s=u.serviceSold(t.service,t.people,1,t.count).amount,c=e.absoluteMoment(t.startDate||o.start),m=e.absoluteMoment(t.endDate||o.end),d=e.absoluteMoment(o.start);d.isBefore(e.absoluteMoment(o.end),"days");d.add(1,"days"))t.dailyRates.push({date:d.toDate(),amount:d.isBefore(c,"days")||d.isAfter(m,"days")?null:s,disabled:d.isSameOrAfter(a.end,"days")})}t.endDate=e.absoluteDate(a.end)}return!0},u.terminateBedSold=function(t,a,n,o,i){if(!t||"CONFIRMED"!=t.status)return!1;var r=moment.range(t.startDate||a.start,t.endDate||a.end);if(!r.contains(a.end))return!1;var l=(r=moment.range(r.start,a.end)).diff("days"),s=u.bedSold(t.bed,t.people,l,n);if(t.status=o||t.status,t.initialAmount=angular.copy(t.amount),t.amount=angular.copy(s.amount),"DAILY"==t.bed.frequency||"NIGHTLY"==t.bed.frequency){if(i&&i.start&&i.end){t.dailyRates=[];for(var c=u.bedSold(t.bed,t.people,1,n).amount,m=e.absoluteMoment(t.startDate||i.start),d=e.absoluteMoment(t.endDate||i.end),f=e.absoluteMoment(i.start);f.isBefore(e.absoluteMoment(i.end),"days");f.add(1,"days"))t.dailyRates.push({date:f.toDate(),amount:f.isBefore(m,"days")||f.isAfter(d,"days")?null:c,disabled:f.isSameOrAfter(a.end,"days")})}t.endDate=e.absoluteDate(a.end)}return!0},u.bestPromotion=function(t){var a,n=0;return _.forEach(t,function(t){if(!t.secret)if("STANDARD"==t.promotionType){if(!a)return n=t.discount.finalAmount-t.discount.initialAmount,void(a=t);if(t.discount.finalAmount-t.discount.initialAmount>n){if(!t.onArrival&&a.onArrival)return;n=t.discount.finalAmount-t.discount.initialAmount,a=t}else t.discount.finalAmount-t.discount.initialAmount>n&&t.onArrival&&!a.onArrival&&(n=t.discount.finalAmount-t.discount.initialAmount,a=t)}else n=t.discount.finalAmount-t.discount.initialAmount,a=t}),a},u.bestPromotionForRates=function(t){var a=[];return _.forEach(t,function(t){a=_.union(promotion,t.promotions)}),u.bestPromotion(a)},u.getRoomPenalty=function(t,a,n){var e=null;if(t.totalRate.cancellationPolicy){var o=moment.isMoment(n)?n:moment(n);e=t.totalRate.cancellationPolicy.limitDate&&moment(t.totalRate.cancellationPolicy.limitDate).utcOffset((a.addressInfo.offset||0)/60).isSameOrAfter(o)?{finalAmount:0,initialAmount:0}:t.totalRate.cancellationPolicy.amount}return e},u.generatePhysicalRoomsList=function(t,a){if(a&&!_.isEmpty(a))return t=_.isNil(t)?{}:t,_.forEach(a,function(a){_.forEach(a.roomsAvailabilities,function(a){if(a.roomClosed)return!0;t[a.room.id]=t[a.room.id]||[],_.some(t[a.room.id],function(t){return moment(t.date).isSame(moment(a.date),"day")})||t[a.room.id].push({date:a.date,roomsSold:[]})})}),t},u.isRoomInPenalty=function(t,a,n){var e=u.getRoomPenalty(t,a,n);return angular.isObject(e)&&e.finalAmount>0},u.maskCardPan=function(t){return String(t).replace(/-/g,"").replace(/.*(\d{4})$/,"**** **** **** $1")},u.beautifyCardPan=function(t){return String(t).replace(/-/g,"").replace(/(.{4})/g,"$1 ").replace(/-([^-]*)$/,"$1")},u}t.$inject=["$translate","NumberUtils","ObjectUtils","DateUtils","LocalStorage","RESERVATION"],angular.module("itaca.utils").value("RESERVATION",{rooms:[]}),angular.module("itaca.utils").factory("ReservationUtils",t)}(),function(){"use strict";angular.module("itaca.utils").factory("ReviewsUtils",function(){var t={};return t.generateScoreLabel=function(t){if(t){var a;switch(t){case 4:a="review.score.bad";break;case 5:a="review.score.poor";break;case 6:a="review.score.sufficient";break;case 7:a="review.score.good";break;case 8:a="review.score.very.good";break;case 9:a="review.score.excellent";break;case 10:a="review.score.fabulous"}return a}},t})}(),function(){"use strict";function t(t){return function(a,n){if("text"===n){var e="";(e=t.trustAsHtml(a)).$$unwrapTrustedValue&&(e=e.$$unwrapTrustedValue()),a=e}return a}}t.$inject=["$sce"],angular.module("itaca.utils").factory("sceStrategy",t)}(),function(){"use strict";function t(t,a){var n=this;this.$$redirectUrl=a||"/login",this.responseError=function(a){return a.data&&401===a.data.status&&location.assign(n.$$redirectUrl),t.reject(a)}}angular.module("itaca.utils").provider("sessionExpiredInterceptor",function(){var a="/login";this.init=function(t){if(!_.isString(t))return!1;a=t},this.$get=["$q",function(n){return new t(n,a)}]})}(),function(){"use strict";angular.module("itaca.utils").factory("StringUtils",function(){var t={};return t.isBlank=function(t){return _.isUndefined(t)||_.isNull(t)||_.isEmpty(t)},t.isNotBlank=function(a){return!t.isBlank(a)},t.isEmpty=function(a){return t.isNotBlank(a)&&_.isEmpty(_.trim(a))},t.isNotEmpty=function(a){return!t.isEmpty(a)},t.normalizeForUrl=function(t,a){return _.toLower(_.replace(_.deburr(a?_.snakeCase(t):t),/[^\w]/gi,""))},t})}(),function(){"use strict";function t(t){var a={};return a.buildUrl=function(a,n){var e=t(n);return e.length>0&&(a+=(-1===a.indexOf("?")?"?":"&")+e),a},a.withParam=function(t,n,e){var o=t.split("?")[1],i=o?JSON.parse('{"'+o.replace(/&/g,'","').replace(/=/g,'":"')+'"}',function(t,a){return""===t?a:decodeURIComponent(a)}):{};return i[n]=e,a.buildUrl(t,i)},a.parseUrl=function(t){var a=document.createElement("a");return a.href=t,a},a}t.$inject=["$httpParamSerializer"],angular.module("itaca.utils").factory("UrlUtils",t)}();