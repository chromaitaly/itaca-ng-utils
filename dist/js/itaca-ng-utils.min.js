/*******************************************************************************
********************************************************************************
********************************************************************************
***	   itaca-ng-utils														 
***    Copyright (C) 2016-2018   Chroma Italy Hotels srl	 
***                                                                          
***    This program is free software: you can redistribute it and/or modify  
***    it under the terms of the GNU General Public License as published by  
***    the Free Software Foundation, either version 3 of the License, or     
***    (at your option) any later version.                                   
***                                                                          
***    This program is distributed in the hope that it will be useful,       
***    but WITHOUT ANY WARRANTY; without even the implied warranty of        
***    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         
***    GNU General Public License for more details.                          
***                                                                          
***    You should have received a copy of the GNU General Public License     
***    along with this program.  If not, see <http://www.gnu.org/licenses/>. 
********************************************************************************
********************************************************************************
*******************************************************************************/
!function(){"use strict";angular.module("itaca.utils",["ngMaterial","itaca.services","pascalprecht.translate","tmh.dynamicLocale","LocalStorageModule"]),angular.module("itaca.utils").config(["$windowProvider","$translateProvider","tmhDynamicLocaleProvider",function(t,e,n){var a=(t.$get().navigator.language||t.$get().navigator.userLanguage).split("-")[0].toLowerCase();e.useLoader("i18nLoader"),e.preferredLanguage(a),e.useCookieStorage(),e.useMissingTranslationHandlerLog(),$translateSanitizationProvider.addStrategy("sce","sceStrategy"),e.useSanitizeValueStrategy("sce"),n.localeLocationPattern("/resources/public/js/i18n/angular-locale_{{locale}}.js"),n.useCookieStorage(),n.defaultLocale(a)}])}(),function(){"use strict";function t(t){var e={};return e.sum=function(e,n){if(!e)return n;if(!n||n)return e;var a=angular.copy(e);return a.initialAmount=t.fixedDecimals(a.initialAmount||0),a.finalAmount=t.fixedDecimals(a.finalAmount||0),a.initialAmount+=t.fixedDecimals(n.initialAmount),a.finalAmount+=t.fixedDecimals(n.finalAmount),a},e.subtract=function(e,n){if(!e)return n;if(!n||!n)return e;var a=angular.copy(e);return a.initialAmount=t.fixedDecimals(a.initialAmount||0),a.finalAmount=t.fixedDecimals(a.finalAmount||0),a.initialAmount-=t.fixedDecimals(n.initialAmount),a.finalAmount-=t.fixedDecimals(n.finalAmount),a},e.calculateDiscount=function(e){if(!e)return null;e.discountAmount=t.fixedDecimals(e.initialAmount-e.finalAmount),e.discountRate=t.calculateDiscount(e.initialAmount,e.discountAmount)},e.calculateVat=function(e,n){if(!e)return null;e.vatRate=t.fixedDecimals(n),e.vatAmount=t.vatAmount(e.finalAmount,e.vatRate)},e}t.$inject=["NumberUtils"],angular.module("itaca.utils").factory("AmountUtils",t)}(),function(){"use strict";function t(t){var e=this;this.$init=function(){_.isPlainObject(t)&&_.forEach(t,function(t,n){e.addOption(n,t)})},this.addOption=function(t,n){return!!angular.isString(t)&&(e[t]=n,!0)},this.addOptionStrict=function(t,n){return!!angular.isString(t)&&(!e.hasOwnProperty(t)&&(e[t]=n,!0))},this.updateOption=function(t,n){if(!angular.isString(t))return!1;if(!e.hasOwnProperty(t))return e.addOption(t,n);var a=e[t];return e[t]=n,a},this.$init()}angular.module("itaca.utils").provider("AppOptions",function(){var e={defaultLang:"en",page:{title:"Home"}};this.init=function(t,n){if(!_.isPlainObject(t))return!1;_.isBoolean(n)&&n?e=t:_.assign(e,t)},this.$get=function(){return new t(e)}})}(),function(){"use strict";function t(t,e){var n=function(e){var n={};if(t.$broadcast("onBeforeUnload",n).defaultPrevented)return n.message};return e.addEventListener("beforeunload",n),e.onbeforeunload=n,e.onunload=function(){t.$broadcast("onUnload")},{}}t.$inject=["$rootScope","$window"],angular.module("itaca.utils").factory("_beforeUnload",t)}(),function(){"use strict";angular.module("itaca.utils").factory("ContactUtils",function(){var t={};return t.getUri=function(t,e){var n="";switch(t){case"PHONE":case"MOBILE":case"FAX":n="tel:";break;case"MAIL":n="mailto:";break;case"WEBSITE":n="http://";break;case"FACEBOOK":n="https://www.facebook.com/";break;case"TWITTER":n="https://www.twitter.com/";break;case"INSTAGRAM":n="https://www.instagram.com/";break;default:n="http://"}return n+e},t})}(),function(){"use strict";function t(t){var e={};return e.response=function(e){return t.convertDateStringsToDates(e),e},e.request=function(e){return t.convertDatesToUTC(e.data),e},e}t.$inject=["DateUtils"],angular.module("itaca.utils").factory("DateInterceptor",t)}(),function(){"use strict";function t(t,e,n,a){var o={};return o.absoluteDate=function(t,e){return o.absoluteMoment(t,e).toDate()},o.absoluteMoment=function(t,n){var a=e(t||void 0);if(!a.isValid())throw new Error("The date is not valid!");var o=e(a).utcOffset(0,!0);return n?o.startOf("day"):o},o.dateForTimezone=function(t,n){return e.tz(t,n)},o.hotelDate=function(t){return a.hotel&&a.hotel.addressInfo&&(a.hotel.addressInfo.timeZoneId||a.hotel.addressInfo.offset)?a.hotel.addressInfo.timeZoneId?o.dateForTimezone(a.hotel.addressInfo.timeZoneId):e(t).utcOffset(a.hotel.addressInfo.offset/60):e(t).utcOffset((a.defaultOffset||0)/60)},o.convertDateStringsToDates=function(a,i,r){if("object"!=typeof a)return a;i=i||10,r=r||0;var u=n&&n.dateString?n.dateString:/^(\d{4}|\+\d{6})(?:-(\d{2})(?:-(\d{2})(?:T(\d{2}):(\d{2}):(\d{2})\.(\d{1,})(Z|([\-+])((\d{2}):(\d{2})|(\d{4})))?)?)?)?$/;for(var l in a)if(a.hasOwnProperty(l)){var s,c=a[l];if("string"==typeof c&&(s=c.match(u))){var m=s[0];try{a[l]=e(m,e.HTML5_FMT.DATETIME_LOCAL_MS).toDate(),m=void 0}catch(e){t.warn("Error converting date '"+m+"': "+e)}}else"object"==typeof c&&r<i&&o.convertDateStringsToDates(c,i,r+1)}},o.convertDatesToUTC=function(n,a,i){if("object"!=typeof n)return n;a=a||10,i=i||0;for(var r in n)if(n.hasOwnProperty(r)){var u=n[r];if(angular.isDate(u)||e.isMoment(u))try{n[r]=o.absoluteDate(u)}catch(e){t.warn("Error converting date to utc'"+data+"': "+e)}else"object"==typeof u&&i<a&&o.convertDatesToUTC(u,a,i+1)}},o.weekdays=function(){var t=[];return _.forEach(e.weekdays(!0),function(n,a){var o=e().day(n);t.push({label:n,labelShort:e.weekdaysShort(!0,a),day:o.day(),weekday:o.weekday(),isoWeekday:o.isoWeekday()})}),t},o.secondsToOffsetString=function(t){if(_.isNil(t))return"";if(t=Number(t),_.isNaN(t))return"";var e=String(Math.floor(Math.abs(t)/3600));e=e.length<2?"0"+e:e;var n=String(Math.floor(Math.abs(t)%3600/60));return n=n.length<2?"0"+n:n,(t>0?"+":"-")+e+n},o.timeRangeCheck=function(t,n,a){var o=e.utc(t).seconds(0).milliseconds(0),i=e.utc(n),r=e(o).hours(i.hours()).minutes(i.minutes()).seconds(0).milliseconds(0),u=e.utc(a),l=e(o).hours(u.hours()).minutes(u.minutes()).seconds(0).milliseconds(0);return l=l.hours()>=r.hours()&&l.hours()<=23?l:l.add(1,"days"),o=o.hours()>=r.hours()&&o.hours()<=23?o:o.add(1,"days"),e.range(r,l).contains(o)},o.diff=function(t,n,a,o){return e(n).startOf("day").diff(e(t).startOf("day"),a||"days",!!_.isBoolean(o)&&o)},o.to=function(t,n,a){return e(t).startOf("day").to(e(n).startOf("day"),!!_.isBoolean(a)&&a)},o}t.$inject=["$log","moment","REGEXP","AppOptions"],angular.module("itaca.utils").factory("DateUtils",t)}(),function(){"use strict";function t(t){var e={};return e.focusFirstInvalid=function(n){var a=angular.isObject(n)?n:document.getElementsByName(n)[0];if(a&&angular.isElement(a)&&angular.isFunction(a.querySelector)){var o=a.querySelector(".ng-invalid:not([disabled]):not([type='hidden'])");return!!o&&(_.isEqual(o.tagName.toLowerCase(),"ng-form")?e.focusFirstInvalid(o):(o.focus(),t.scrollToElementAnimated(o),!0))}},e.focusFirstInput=function(n){var a=angular.isObject(n)?n:document.getElementsByName(n)[0];if(a&&angular.isElement(a)&&angular.isFunction(a.querySelector)){var o=a.querySelector("input:not([disabled]):not([type='hidden'])");return!!o&&(o.focus(),t.scrollToElementAnimated(o,e.offset),!0)}},e.isInvalid=function(t){var e=document[t];if(e&&angular.isFunction(e.querySelector))return!!e.querySelector(".ng-invalid")},e}t.$inject=["$document"],angular.module("itaca.utils").factory("FormUtils",t)}(),function(){"use strict";function t(t,e){var n={};return n.isElementInView=function(e,n){var a=angular.element(e)[0];if(!a)return!1;var o=t.pageYOffset,i=o+t.innerHeight,r=a.offsetTop,u=r+a.offsetHeight;return!0===n?o<r&&i>u:r<=i&&u>=o},n.getScrollParent=function(t){var e=angular.element(t)[0];return null===e?null:e.scrollHeight>e.clientHeight?e:n.getScrollParent(e.parentNode)},n.addElement=function(t,n,a,o){var i=a?angular.isElement(a)?a.length?a[0]:a:document.querySelector(a):document.body;if(i){i=angular.element(i);var r=angular.merge(i.scope().$new(!0),n),u=e(t)(r);return o?i.prepend(u):i.append(u),r}return!1},n}t.$inject=["$window","$compile"],angular.module("itaca.utils").factory("HtmlUtils",t)}(),function(){"use strict";function t(t,e,n,a,o){return function(i){var r=[];if(angular.isString(o))r.push(o);else{if(!angular.isArray(o))return;r=o}var u={};u[i.queryParameter||"lang"]=i.key.toLowerCase().replace(/-/g,"_");var l={lang:i.key},s=[];_.forEach(r,function(o){var r=a(o)(l),c=e.get(r,angular.extend({params:u},i.$http)).then(function(t){return t.data},function(){return t.error("Error getting translations from url: "+r+" - lang: "+i.key+" - error: "+response.message),n.reject(i.key)});s.push(c)});var c=n.defer();return n.all(s).then(function(t){for(var e=t.length,n={},a=0;a<e;a++)for(var o in t[a])n[o]=t[a][o];c.resolve(n)},function(t){c.reject(t)}),c.promise}}angular.module("itaca.utils").provider("i18nLoader",function(){var e="/api/rs/public/i18n";this.setResources=function(t){if(!angular.isString(t)&&angular.isArray(t))return!1;e=t},this.$get=["$log","$http","$q","$interpolate",function(n,a,o,i){return new t(n,a,o,i,e)}]})}(),function(){"use strict";angular.module("itaca.utils").factory("IconUtils",function(){var t={};return t.languageIcons=function(){return{ITALIAN:{icon:"flag-icon flag-icon-it"},ENGLISH:{icon:"flag-icon flag-icon-gb"},FRENCH:{icon:"flag-icon flag-icon-fr"},SPANISH:{icon:"flag-icon flag-icon-es"},GERMAN:{icon:"flag-icon flag-icon-de"},PORTUGUESE:{icon:"flag-icon flag-icon-pt"},RUSSIAN:{icon:"flag-icon flag-icon-ru"},MANDARIN:{icon:"flag-icon flag-icon-cn"},HINDI:{icon:"flag-icon flag-icon-in"},ARABIC:{icon:"flag-icon flag-icon-sa"},BENGALI:{icon:"flag-icon flag-icon-bd"},JAPANESE:{icon:"flag-icon flag-icon-jp"},PUNJABI:{icon:"flag-icon flag-icon-pk"},JAVANESE:{icon:"flag-icon flag-icon-id"},WU:{icon:"flag-icon flag-icon-cn"},MALAY_INDONESIAN:{icon:"flag-icon flag-icon-in"},TELUGU:{icon:"flag-icon flag-icon-in"},VIETNAMESE:{icon:"flag-icon flag-icon-vn"},MARATHI:{icon:"flag-icon flag-icon-in"},TAMIL:{icon:"flag-icon flag-icon-lk"},URDU:{icon:"flag-icon flag-icon-ae"},TURKISH:{icon:"flag-icon flag-icon-tr"},LANG_SIGN:{icon:"material-icons flaticon-hearing-impaired"},LANG_SIGN_IT:{icon:"material-icons flaticon-hearing-impaired"}}},t.contactIcons=function(){return{PHONE:{icon:"mdi mdi-phone",type:"contact.phone",prefix:"tel:",suffix:""},MOBILE:{icon:"mdi mdi-cellphone-android",type:"contact.mobile",prefix:"tel:",suffix:""},FAX:{icon:"mdi mdi-fax",type:"contact.fax",prefix:"tel:",suffix:""},EMAIL:{icon:"mdi mdi-email",type:"contact.email",prefix:"mailto:",suffix:""},WEBSITE:{icon:"mdi mdi-web",type:"contact.website",prefix:"",suffix:""},FACEBOOK:{icon:"mdi mdi-facebook-box",type:"contact.facebook",prefix:"https://facebook.com/",suffix:""},TWITTER:{icon:"mdi mdi-twitter-box",type:"contact.twitter",prefix:"https://twitter.com/",suffix:""},INSTAGRAM:{icon:"mdi mdi-instagram",type:"contact.instagram",prefix:"https://www.instagram.com/",suffix:""},WHATSAPP:{icon:"mdi mdi-whatsapp",type:"contact.whatsapp",prefix:bowser.ios?"whatsapp://send?":"intent://send/",suffix:bowser.ios?"":"#Intent;scheme=smsto;package=com.whatsapp;action=android.intent.action.SENDTO;end"},SKYPE:{icon:"mdi mdi-skype",type:"contact.skype",prefix:"skype://",suffix:"?call"},VIBER:{icon:"mdi mdi-phone",type:"contact.viber",prefix:"viber://forward?",suffix:""},TELEGRAM:{icon:"mdi mdi-telegram",type:"contact.telegram",prefix:"tg://",suffix:""}}},t.paymentIcons=function(){return{PAYPAL:"pf pf-paypal",VISA:"pf pf-visa",MASTERCARD:"pf pf-mastercard",AMEX:"pf pf-american-express",BIT_COIN:"pf pf-bitcoin",CARTA_SI:"pf pf-carta-si",DINERS_CLUB:"pf pf-diners",DISCOVER:"pf pf-discover",JCB:"pf pf-jcb",UNION_PAY:"pf pf-unionpay",VISA_ELECTRON:"pf pf-visa-electron",V_PAY:"pf pf-visa",MAESTRO:"pf pf-maestro",CIRRUS:"pf pf-cirrus",POSTEPAY:"pf pf-postepay",APPLE_PAY:"pf pf-apple-pay",PAGSEGURO:"pf pf-pagseguro",BANCONTACT:"pf pf-bancontact-mister-cash",BANCOMAT:"pf pf-card"}},t.serviceIcons=function(){return{"service.type.technology.console":"mdi mdi-gamepad-variant","service.type.technology.games":"mdi mdi-gamepad-variant","service.type.technology.tv.flat":"mdi mdi-monitor","service.type.technology.tv":"mdi mdi-monitor","service.type.entertainment.children.tv":"mdi mdi-monitor","service.type.popular.pet.small":"mdi mdi-paw","service.type.popular.pet.medium":"mdi mdi-paw","service.type.popular.pet.large":"mdi mdi-paw","service.type.popular.pet.disabled":"mdi mdi-paw","service.type.popular.router":"mdi mdi-router-wireless","service.type.miscellaneous.air.conditioning":"mdi mdi-air-conditioner","service.type.room.air.conditioning":"mdi mdi-air-conditioner","service.type.miscellaneous.heating":"mdi mdi-air-conditioner","service.type.room.washing.machine":"mdi mdi-washing-machine","service.type.transport.parking.secured":"mdi mdi-parking","service.type.transport.parking.street":"mdi mdi-parking","service.type.transport.parking.accessible":"mdi mdi-parking","service.type.popular.bouquet":"mdi mdi-flower","service.type.popular.rose":"mdi mdi-flower","service.type.popular.breakfast.continental":"mdi mdi-food-fork-drink","service.type.popular.breakfast":"mdi mdi-food-fork-drink","service.type.popular.breakfast.room":"mdi mdi-food-fork-drink","service.type.miscellaneous.non­smoking.throughout":"mdi mdi-smoking-off","service.type.miscellaneous.non­smoking.rooms":"mdi mdi-smoking-off","service.type.popular.smoking.area":"mdi mdi-smoking","service.type.popular.smoking.room":"mdi mdi-smoking","service.type.popular.wifi.room":"mdi mdi-wifi","service.type.popular.wifi.all":"mdi mdi-wifi","service.type.popular.internet.point":"mdi mdi-wifi","service.type.food.champagne":"mdi mdi-glass-flute","service.type.food.prosecco":"mdi mdi-glass-flute","service.type.food.wine.red":"mdi mdi-glass-tulip","service.type.food.wine.white":"mdi mdi-glass-tulip","service.type.food.homemade.cake":"mdi mdi-cake","service.type.food.water":"mdi mdi-cup-water","service.room.type.welcomeCoffee":"mdi mdi-coffee","service.type.food.cookies":"mdi mdi-cookie"}},t.transferIcons=function(){return{CAR:"flaticon-car-black-side-view-pointing-left",LIMOUSINE:"flaticon-sedan-car-model",PULLMAN:"flaticon-bus-front",SHUTTLE:"flaticon-microbus",MINIVAN:"flaticon-van-black-transport-side-view-pointing-to-left",LUXURY_CAR:"flaticon-supercar"}},t.portalIcons=function(){return{PHONE:"channel-icon channel-chroma",EMAIL:"channel-icon channel-chroma",PORTAL:"channel-icon channel-chroma",BOOKING:"channel-icon channel-booking",EXPEDIA:"channel-icon channel-expedia",VENERE:"channel-icon channel-venere",AIRBNB:"channel-icon channel-airbnb",AGODA:"channel-icon channel-agoda",AMADEUS:"channel-icon channel-amadeus",SABRE:"channel-icon channel-sabre",GALILEO:"channel-icon channel-galileo",WORLDSPAN:"channel-icon channel-worldspan",DHISCO:"channel-icon channel-dhisco",EDREAMS:"channel-icon channel-edreams",GOVOYAGES:"channel-icon channel-govoyages",OPODO:"channel-icon channel-opodo",TRAVELLINK:"channel-icon channel-travellink",LILIGO:"channel-icon channel-liligo",OTHER:"mdi mdi-web material-icons"}},t})}(),function(){"use strict";function t(t,e,n,a,o){return function(i,r,u,l){var s=this;this.source=i,this.$$sourceType=angular.isArray(this.source)?1:angular.isObject(this.source)?2:-1,this.serviceFnName=u||"all",this.params=r,this.defaultSize=10,this.page=0,this.totalPages=0,this.items=[],this.totalItems=0,this.lastPage=!1,this.busy=!1,this.executed=!1,this.newItems=!1,this.postBody=l,this.nextPage=function(){var i=a.defer();return n(function(){if(s.source){if(s.busy||s.lastPage)return e.debug(s.busy?"Service busy":"Service reached last page"),void i.resolve();if(1==s.$$sourceType){s.busy=!0,angular.isObject(s.params)||(s.params={}),(angular.isUndefined(s.params.size)||Number.isNaN(s.params.size)||s.params.size<=0)&&(s.params.size=s.defaultSize),s.page<0&&(s.page=0);var a=s.source;if(s.params.sort){var u,l;_.forEach(s.params.sort,function(t){var e=t.split(",");u||(u=[]),u.push(e[0]),e[1]&&(l||(l=[]),l.push(e[1]))}),a=_.orderBy(s.source,u,l)}a=s.params.filter&&!_.isEmpty(_.trim(s.params.filter))?t(a,{$:s.params.filter}):a,s.totalItems=a.length,s.totalPages=Math.ceil(s.totalItems/s.params.size);var c=s.params.size*s.page,m=c+s.params.size-1;m>a.length&&(m=a.length,s.lastPage=!0);var f=a.slice(c,m);f&&f.length>0?(s.params.filter&&(s.items=[]),angular.forEach(f,function(t,e){this.push(t)},s.items),s.newItems=!0,s.page++):s.newItems=!1,s.executed=!0,n(function(){s.busy=!1}),i.resolve()}else if(2==s.$$sourceType){if(s.serviceFnName&&!angular.isFunction(s.source[s.serviceFnName]))return e.error("Service has no '"+s.serviceFnName+"' function"),void i.reject("Service has no '"+s.serviceFnName+"' function");s.busy=!0,angular.isObject(s.params)||(s.params={}),(angular.isUndefined(s.params.size)||Number.isNaN(s.params.size)||s.params.size<=0)&&(s.params.size=s.defaultSize),s.page<0&&(s.page=0),s.params.page=s.page;var d=s.serviceFnName?s.serviceFnName:"all";s.source[d](s.params,s.postBody).then(function(t){var e=t.content;s.totalPages=t.totalPages,s.totalItems=t.totalElements,s.lastPage=t.last,e&&e.length>0?(angular.isDefined(r.filter)&&(s.items=[]),angular.forEach(e,function(t,e){this.push(t)},s.items),s.newItems=!0,s.page++):s.newItems=!1,i.resolve()},function(t){e.error(t),o.error(t),i.reject(t)}).finally(function(){s.busy=!1,s.executed=!0},function(){s.busy=!1,s.executed=!0})}else e.error("Source must be an array or a Service Object"),i.reject("Source must be an array or a Service Object")}else e.error("Source is not defined"),i.reject("Source is not defined")},500).then(function(){return i.promise})},this.reload=function(){if(s)return s.reset(),s.nextPage()},this.reset=function(){s.busy=!1,s.executed=!0,s.lastPage=!1,s.page=0,s.totalPages=0,s.totalItems=0,s.items=[],s.newItems=!1},this.resetParams=function(){_.forEach(s.params,function(t,e,n){"size"!=e&&"page"!=e&&"sort"!=e&&(n[e]=void 0)})},this.resetAndReload=function(){s.resetParams(),s.reload()},this.getItemAtIndex=function(t){return s.items[t]?(console.log("Getting item "+t),s.items[t]):(s.nextPage(),null)},this.getLength=function(){return console.log("Length "+s.totalItems),s.totalItems}}}t.$inject=["filterFilter","$log","$timeout","$q","Notification"],angular.module("itaca.utils").factory("InfinitePaging",t)}(),function(){"use strict";function t(t,e,n,a,o){var i=this;this.$$reservationStorageName=a||"X-ITACA-RSV",this.$$quoteStorageName=o||"X-ITACA-QUOTE",this.setReservation=function(t){if(!t||t.step>3||t.id||!t.hotel||!t.hotel.id)return!1;var e=n.get(i.$$reservationStorageName);_.isPlainObject(e)||(e={});var a=t.hotel.id,o=t.guest?t.guest.id:null,r=_.isPlainObject(e[a])?e[a]:{};return t.step=t.step>2?2:t.step,_.unset(t,"payment"),_.unset(t,"paymentMethod"),_.unset(t,"paymentType"),_.unset(t,"bill"),_.unset(t,"billing"),_.unset(t,"guest"),r[o||"anonymous"]=t,e[a]=r,n.set(i.$$reservationStorageName,e),!0},this.getReservation=function(t,e){if(!t)return null;var a=n.get(i.$$reservationStorageName),o=a?a[t]:null;return o?o[e||"anonymous"]:null},this.removeReservation=function(t,e){if(!t)return!1;var a=n.get(i.$$reservationStorageName),o=a?a[t]:null;return!!o&&(o[e||"anonymous"]=void 0,a[t]=o,n.set(i.$$reservationStorageName,a),!0)},this.setQuote=function(e){var a=n.get(i.$$quoteStorageName);if(a=a&&angular.isObject(a)?a:{},t.user&&t.user.id){var o=a[t.user.id];return o=o&&angular.isObject(o)?o:{},_.unset(e,"payment"),_.unset(e,"guest"),o[t.hotelId]=e,a[t.user.id]=o,n.set(i.$$quoteStorageName,a),!0}return!1},this.getQuote=function(){var a=n.get(i.$$quoteStorageName);if(a&&a[t.user.id]){var o=a[t.user.id][t.hotelId];return e.convertDateStringsToDates(o),o}return{}},this.removeQuote=function(){var e=n.get(i.$$quoteStorageName);e&&e[t.user.id]&&(e[t.user.id][t.hotelId]=void 0)}}angular.module("itaca.services").provider("LocalStorage",function(){var e="X-ITACA-RSV",n="X-ITACA-QUOTE";this.setReservationStorageName=function(t){_.isEmpty(t)||(e=t)},this.setQuoteStorageName=function(t){_.isEmpty(t)||(n=t)},this.$get=["AppOptions","DateUtils","localStorageService",function(a,o,i){return new t(a,o,i,e,n)}]})}(),function(){"use strict";function t(t,e,n){var a=this;this.init=function(){a.all()},this.all=function(){var o=t.defer();return _.isPlainObject(n)?(a.locales=n,o.resolve(a.locales)):_.isString(n)&&e.get(n).then(function(t){a.locales=t.data.content,o.resolve(a.locales)},function(t){o.reject("Error loading phone prefixes")}),o.promise},this.get=function(t){return _.find(a.locales,function(e){return e[1]==t})},this.init()}angular.module("itaca.utils").provider("LocaleUtils",function(){var e,n="/resources/public/js/data/json/locales.json";this.setData=function(t){_.isPlainObject(t)?e=t:_.isString(t)&&(n=t)},this.$get=["$q","$http",function(a,o){return new t(a,o,e||n)}]})}(),function(){"use strict";angular.module("itaca.utils").factory("NumberUtils",function(){var t={};return t.fixedDecimals=function(t,e){if(!t||0===t)return 0;var n=Number(t).toFixed(e||2);return Number(n).valueOf()},t.vatAmount=function(t,e){return this.fixedDecimals(t-this.taxableAmount(t,e))},t.taxableAmount=function(t,e){return this.fixedDecimals(e?t/((100+e)/100):t)},t.calculateDiscount=function(e,n,a){return e&&n?(e=parseFloat(e),n=parseFloat(n),a=a||"PRICE",t.fixedDecimals("PERCENTAGE"==a?e/100*n:100*n/e)):0},t.applyDiscount=function(e,n,a){var o="PRICE"==(a=a||"PRICE")?parseFloat(n):t.calculateDiscount(e,n,a);return t.fixedDecimals(e-o)},t.uniqueNumber=function(){var e=Date.now();return e<=t.uniqueNumber.previous?e=++t.uniqueNumber.previous:t.uniqueNumber.previous=e,e},t.uniqueNumber.previous=0,t.isEven=function(t){return t%2==0},t.isOdd=function(t){return 1==Math.abs(t%2)},t.defaultNumber=function(e,n){var a=Number(e);return isNaN(a)?t.defaultNumber(n,0):a},t.lcmArray=function(e){if(!_.isArray(e)||_.isEmpty(e))return!1;for(var n=e[0],a=1;a<e.length;a++)n=t.lcm(n,e[a]);return n},t.lcm=function(e,n){return"number"==typeof e&&"number"==typeof n&&(e&&n?Math.abs(e*n/t.gcd(e,n)):0)},t.gcd=function(t,e){for(t=Math.abs(t),e=Math.abs(e);e;){var n=e;e=t%e,t=n}return t},t})}(),function(){"use strict";angular.module("itaca.utils").factory("ObjectUtils",function(){var t={};return t.clearObject=function(t,e){if(t){var n=_.mapValues(t,function(t,n){return e&&e.test(n)?t:_.isArray(t)?[]:void 0});_.assign(t,n)}},t})}(),function(){"use strict";function t(t,e){var n={};return n.request=function(n){if(!navigator.onLine){e.warn("No connection! The request will be aborted: "+n.url);var a=t.defer();n.timeout=a.promise,a.reject()}return n},n}t.$inject=["$q","$log"],angular.module("itaca.utils").factory("OfflineInterceptor",t)}(),function(){"use strict";function t(t,e,n){var a=this;this.init=function(){a.all()},this.all=function(){var o=t.defer();return _.isPlainObject(n)?(a.prefixes=n,o.resolve(a.prefixes)):_.isString(n)&&e.get(n).then(function(t){a.prefixes=t.data.content,o.resolve(a.prefixes)},function(t){o.reject("Error loading phone prefixes")}),o.promise},this.get=function(e,n){if(_.isNil(e))return null;_.isNil(n)&&(n="code");var o=t.defer();return a.all().then(function(t){var a=_.find(t,function(t){return t[n]==e});o.resolve(a)},function(t){o.reject(t)}),o.promise},this.compile=function(t,e){return(t||"")+(e||"")},this.decompile=function(e){if(!e)return null;var n=t.defer(),o=a.decompileSimple(e);return o.prefix?a.get(o.prefix,"dial_code").then(function(t){o.prefix=t,n.resolve(o)},function(t){n.resolve(o)}):n.resolve(o),n.promise},this.decompileSimple=function(t){if(!t)return null;var e={};if(_.isEmpty(a.prefixes))e.number=t;else{var n=_.find(a.prefixes,function(e){return t.startsWith(e.dial_code)});n&&n.dial_code?(e.prefix=_.trim(n.dial_code),e.number=_.trim(t.substring(t.indexOf(n.dial_code)+n.dial_code.length))):e.number=t}return e},this.init()}angular.module("itaca.utils").provider("PhoneUtils",function(){var e,n="/resources/public/js/data/json/phone-prefixes.json";this.setData=function(t){_.isPlainObject(t)?e=t:_.isString(t)&&(n=t)},this.$get=["$q","$http",function(a,o){return new t(a,o,e||n)}]})}(),function(){"use strict";function t(t){var e={};return e.notifyNewProfileImage=function(e){t.$broadcast("profile-image-updated",e)},e.notifyNewCoverImage=function(e){t.$broadcast("cover-image-updated",e)},e.notifyLoadProfileImage=function(e){t.$broadcast("load-image-profile",e)},e}t.$inject=["$rootScope"],angular.module("itaca.utils").factory("ProfileUtils",t)}(),function(){"use strict";angular.module("itaca.utils").factory("REGEXP",function(){return{username:/^[a-z0-9_.-@]{3,32}$/,password:/^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@$!%*?&_+-]*)(?=\S+$).{8,32}$/,strong_password:/^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@$!%*?&_+-])(?=\S+$).{8,32}$/,email:/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.(aero|arpa|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro|travel|mobi|[a-z][a-z])|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i,zip:/^[0-9]{5}$/,province:/^[a-zA-Z]{2}$/,phone:/^([+]{0,1}[0-9]{2,4}){1}[0-9]{3,11}$/,creditCard:/^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\d{3})\d{11})$/,price:/^[0-9]+(\.[0-9]{1,2})?$/,priceNoStrict:/^[-+]*[0-9]+(\.[0-9]{1,2})?$/,vat:/^((AT)?U[0-9]{8}|(BE)?0[0-9]{9}|(BG)?[0-9]{9,10}|(CY)?[0-9]{8}L|(CZ)?[0-9]{8,10}|(DE)?[0-9]{9}|(DK)?[0-9]{8}|(EE)?[0-9]{9}|(EL|GR)?[0-9]{9}|(ES)?[0-9A-Z][0-9]{7}[0-9A-Z]|(FI)?[0-9]{8}|(FR)?[0-9A-Z]{2}[0-9]{9}|(GB)?([0-9]{9}([0-9]{3})?|[A-Z]{2}[0-9]{3})|(HU)?[0-9]{8}|(IE)?[0-9]S[0-9]{5}L|(IT)?[0-9]{11}|(LT)?([0-9]{9}|[0-9]{12})|(LU)?[0-9]{8}|(LV)?[0-9]{11}|(MT)?[0-9]{8}|(NL)?[0-9]{9}B[0-9]{2}|(PL)?[0-9]{10}|(PT)?[0-9]{9}|(RO)?[0-9]{2,10}|(SE)?[0-9]{12}|(SI)?[0-9]{8}|(SK)?[0-9]{10})$/,fiscalCode:/^([A-Za-z]{6}[0-9lmnpqrstuvLMNPQRSTUV]{2}[abcdehlmprstABCDEHLMPRST]{1}[0-9lmnpqrstuvLMNPQRSTUV]{2}[A-Za-z]{1}[0-9lmnpqrstuvLMNPQRSTUV]{3}[A-Za-z]{1})|([0-9]{11})$/,dateString:/^(\d{4}|\+\d{6})(?:-(\d{2})(?:-(\d{2})(?:T(\d{2}):(\d{2}):(\d{2})\.(\d{1,})(Z|([\-+])((\d{2}):(\d{2})|(\d{4})))?)?)?)?$/}})}(),function(){"use strict";function t(t,e){var n={};return n.responseError=function(n){var a=t.defer();return n.data&&"java.net.SocketTimeoutException"===n.data.exception?e(["error.request.generic","common.try.again.or.contact.us"]).then(function(t){n.data.message=t["error.request.generic"]+". "+t["common.try.again.or.contact.us"],a.reject(n)}):a.reject(n),a.promise},n}t.$inject=["$q","$translate"],angular.module("itaca.utils").factory("RequestTimeoutInterceptor",t)}(),function(){"use strict";function t(t,e,n,a,o,i,r){var u={};return u.clearReservation=function(t,e){e?a.clearObject(t,/^(check(?:in$|out$))|^people$|^requestPeople$|^hotelId$|^hotel$/):a.clearObject(t)},u.storeLastReservation=function(){return i.setReservation(r)},u.loadLastReservation=function(t,e){var n=i.getReservation(t,e);return n||(n=_.mapValues(r,function(t){if(_.isArray(t))return[]})),o.convertDateStringsToDates(n),n&&n.checkin&&n.checkout&&moment(n.checkin).isBefore(moment(),"days")&&(u.clearReservation(n),i.removeReservation(t,e)),n},u.removeLastReservation=function(t,e){return t||(t=r.hotel&&r.hotel.id?r.hotel.id:null),e||(e=r.guest&&r.guest.id?r.guest.id:null),i.removeReservation(t,e)},u.availableNights=function(t,e,n){if(!t||!e)return null;var a=moment(t),i=moment(e),r=_.isBoolean(n)&&!n?moment(t):n?moment(n):moment();return i.isAfter(r,"days")&&a.isBefore(r,"days")?o.diff(r,i):o.diff(a,i)},u.calculateGuestDocuments=function(t){t.identityDocuments=t.identityDocuments&&t.identityDocuments.length>0?t.identityDocuments:[],t.guestsCount=u.guestsCount(t.people,t.extraPeople);var e=parseInt(t.guestsCount.total);if(_.size(t.identityDocuments)>e)t.identityDocuments=_.dropRight(t.identityDocuments,_.size(t.identityDocuments)-e);else if(_.size(t.identityDocuments)<e)for(var n=e-_.size(t.identityDocuments),a=0;a<n;a++)t.identityDocuments.push({})},u.normalizePeople=function(t){return _.isPlainObject(t)||(t={}),t.adults=e.defaultNumber(t.adults),t.boys=e.defaultNumber(t.boys),t.children=e.defaultNumber(t.children),t.kids=e.defaultNumber(t.kids),t},u.peopleSummary=function(e,n){e||(e={}),n||(n={});var a=u.guestsCount(e,n);return!a&&a.total<=0?t("people.none").then(function(t){return t}):t(["people.adult","people.adults","people.child","people.children","people.boy","people.boys","people.kid","people.kids"]).then(function(t){var a="",o=e.adults>0||n.adults>0;if(o){var i=parseInt(e.adults||0)+parseInt(n.adults||0);i>0&&(a+=i+" "+(i<2?t["people.adult"]:t["people.adults"]))}var r=e.boys>0||n.boys>0;if(r){var u=parseInt(e.boys||0)+parseInt(n.boys||0);u>0&&(a+=o?", ":"",a+=u+" "+(u<2?t["people.boy"]:t["people.boys"]))}var l=e.children>0||n.children>0;if(l){var s=parseInt(e.children||0)+parseInt(n.children||0);s>0&&(a+=o||r?", ":"",a+=s+" "+(s<2?t["people.child"]:t["people.children"]))}if(e.kids>0||n.kids>0){var c=parseInt(e.kids||0)+parseInt(n.kids||0);c>0&&(a+=o||r||l?", ":"",a+=c+" "+(c<2?t["people.kid"]:t["people.kids"]))}return a.toLowerCase()})},u.peopleByBeds=function(t){var e={adults:0,boys:0,children:0,kids:0};return _.forEach(t,function(t){if(t.people){var n=t.people;n.adults&&(e.adults=e.adults?parseInt(e.adults)+parseInt(n.adults):parseInt(n.adults)),n.boys&&(e.boys=e.boys?parseInt(e.boys)+parseInt(n.boys):parseInt(n.boys)),n.children&&(e.children=e.children?parseInt(e.children)+parseInt(n.children):parseInt(n.children)),n.kids&&(e.kids=e.kids?parseInt(e.kids)+parseInt(n.kids):parseInt(n.kids))}}),e},u.guestsCount=function(t,e){t=u.normalizePeople(t),e=u.normalizePeople(e);var n=0,a=!1,o=!1;!_.isNil(t.adults)&&t.adults>0&&(a=!0,n+=parseInt(t.adults)),!_.isNil(t.boys)&&t.boys>0&&(o=!0,n+=parseInt(t.boys)),!_.isNil(t.children)&&t.children>0&&(o=!0,n+=parseInt(t.children)),!_.isNil(t.kids)&&t.kids>0&&(o=!0,n+=parseInt(t.kids));var i=0,r=!1,l=!1;return!_.isNil(e.adults)&&e.adults>0&&(r=!0,i+=parseInt(e.adults)),!_.isNil(e.boys)&&e.boys>0&&(l=!0,i+=parseInt(e.boys)),!_.isNil(e.children)&&e.children>0&&(l=!0,i+=parseInt(e.children)),!_.isNil(e.kids)&&e.kids>0&&(l=!0,i+=parseInt(e.kids)),{standard:n,hasAdults:a,hasChildren:o,extra:i,extraHasAdults:r,extraHasChildren:l,total:n+i}},u.guestsCountByRooms=function(t,e){return!(!t||!_.isArray(t))&&u.guestsCount(u.peopleByRooms(t,e),u.extraPeopleByRooms(t,e))},u.guestsCountByBeds=function(t,e,n){var a=0,o=0,i=!1,r=!1;if(t&&angular.isArray(t)&&_.forEach(t,function(t){a+=t.maxPerson*t.count}),e&&e.length){n=n||0;for(var u=angular.copy(e),l=parseInt(n);l;){var s=_.maxBy(u,"maxPerson");if(!s)break;_.pull(u,s);var c=l-s.count>=0?s.count:l;o+=s.maxPerson*c,l-=c,i||(i=null!=s.people&&s.people.adults),r||(r=s.people&&(s.people.boys||s.people.children||s.people.kids))}}return{standard:a,extra:o,extraHasAdults:i,extraHasChildren:r,partial:a+o}},u.totalPeople=function(t,e){return t=u.normalizePeople(t),e=u.normalizePeople(e),{adults:t.adults+e.adults,boys:t.boys+e.boys,children:t.children+e.children,kids:t.kids+e.kids}},u.totalPeopleByRooms=function(t,e){return u.totalPeople(u.peopleByRooms(t,e),u.extraPeopleByRooms(t,e))},u.peopleByRooms=function(t,e){var n={adults:0,boys:0,children:0,kids:0};return _.forEach(t,function(t,a,o){var i=angular.copy(t.people||{});e&&!_.isEmpty(t.beds)&&(i.adults=0,i.boys=0,i.children=0,i.kids=0,_.forEach(t.beds,function(t){i.adults=parseInt(t.people.adults)?i.adults+parseInt(t.people.adults):i.adults,i.boys=parseInt(t.people.boys)?i.boys+parseInt(t.people.boys):i.boys,i.children=parseInt(t.people.children)?i.children+parseInt(t.people.children):i.children,i.kids=parseInt(t.people.kids)?i.kids+parseInt(t.people.kids):i.kids})),n.adults=parseInt(i.adults)?n.adults+parseInt(i.adults):n.adults,n.boys=parseInt(i.boys)?n.boys+parseInt(i.boys):n.boys,n.children=parseInt(i.children)?n.children+parseInt(i.children):n.children,n.kids=parseInt(i.kids)?n.kids+parseInt(i.kids):n.kids}),n},u.extraPeopleByRooms=function(t,e){var n={adults:0,boys:0,children:0,kids:0};return _.forEach(t,function(t,a,o){var i=angular.copy(t.extraPeople||{});e&&!_.isEmpty(t.otherBeds)&&(i.adults=0,i.boys=0,i.children=0,i.kids=0,_.forEach(t.otherBeds,function(t){i.adults=parseInt(t.people.adults)?i.adults+parseInt(t.people.adults):i.adults,i.boys=parseInt(t.people.boys)?i.boys+parseInt(t.people.boys):i.boys,i.children=parseInt(t.people.children)?i.children+parseInt(t.people.children):i.children,i.kids=parseInt(t.people.kids)?i.kids+parseInt(t.people.kids):i.kids})),i&&(n.adults=parseInt(i.adults)?n.adults+parseInt(i.adults):n.adults,n.boys=parseInt(i.boys)?n.boys+parseInt(i.boys):n.boys,n.children=parseInt(i.children)?n.children+parseInt(i.children):n.children,n.kids=parseInt(i.kids)?n.kids+parseInt(i.kids):n.kids)}),n},u.peopleByMax=function(t,e,n){if(!t&&!e)return{};if(!t)return n>0?u.peopleByMax(e,{adults:n},n):angular.copy(e);if(!e)return n>0?u.peopleByMax(t,{adults:n},n):angular.copy(t);var a=n;a||(a=-1);var o=_.isNil(t.adults)?0:_.isNil(e.adults)?t.adults:t.adults<=e.adults?t.adults:e.adults;a>=0&&(a-=o=o<=a?o:a);var i=_.isNil(t.boys)?0:_.isNil(e.boys)?t.boys:t.boys<=e.boys?t.boys:e.boys;a>=0&&(a-=i=i<=a?i:a);var r=_.isNil(t.children)?0:_.isNil(e.children)?t.children:t.children<=e.children?t.children:e.children;a>=0&&(a-=r=r<=a?r:a);var l=_.isNil(t.kids)?0:_.isNil(e.kids)?t.kids:t.kids<=e.kids?t.kids:e.kids;return a>=0&&(a-=l=l<=a?l:a),{adults:o,boys:i,children:r,kids:l}},u.peopleAvailability=function(t,e,n){t=u.normalizePeople(t),u.guestsCount(t).standard<=0&&(t=angular.copy(e)),e=u.normalizePeople(e);for(var a=u.guestsCount(e).standard,o=n?parseInt(n)-a:a,i={adults:0,boys:0,children:0,kids:0},r=1;r<=parseInt(t.adults||0);r++)e.adults=e.adults||0,(l=!(r<=e.adults)&&o+e.adults-r<0)||(i.adults=r);for(r=1;r<=parseInt(t.boys||0);r++)e.boys=e.boys||0,(l=!(r<=e.boys)&&o+e.boys-r<0)||(i.boys=r);for(r=1;r<=parseInt(t.children||0);r++)e.children=e.children||0,(l=!(r<=e.children)&&o+e.children-r<0)||(i.children=r);for(r=1;r<=parseInt(t.kids||0);r++){e.kids=e.kids||0;var l=!(r<=e.kids)&&o+e.kids-r<0;l||(i.kids=r)}return i},u.bedsAvailability=function(t,n,a){var o=[];return _.forEach(n,function(t){var n=angular.copy(t);n.uid=n.uid||e.uniqueNumber(),n.$$available=!1,n.$$blocked=!1,n.$$editing=!1,o.push(n)}),_.forEach(t,function(t){var i=0;do{var r=_.filter(o,function(e){return(e.bed||e).type==t.type});if((i=_.size(r))>=t.count)return;var u=angular.copy(t);u.uid=e.uniqueNumber(),u.$$available=!0,u.$$blocked=_.size(n)>=a,o.push(u)}while(i<t.count)}),o},u.$generateRoomIncludedServices=function(t,e,n,a){var o=[];return _.forEach(_.filter(t.services,["bookability","INCLUDED"]),function(t){o.push(u.serviceSold(t,e,n,1))}),_.unionBy(a||[],o,"service.id")},u.$generateRoomIncludedBeds=function(t,n,a,o,i){var r=i||[],l=0,s=u.normalizePeople(angular.copy(n)),c=u.guestsCount(s);return _.forEach(t.beds,function(n){if(c.standard<=0||t.bedCount<=l)return!1;var i=0;do{var m=_.filter(r,function(t){return t.bed.type==n.type});if((i=_.size(m))>=n.count)return;var f=angular.copy(n);f.uid=e.uniqueNumber();var d=u.peopleByMax(s,f.people,f.maxPerson);r.push(u.bedSold(f,d,a,o)),l++,s.adults=s.adults-(d.adults||0),s.boys=s.boys-(d.boys||0),s.children=s.children-(d.children||0),s.kids=s.kids-(d.kids||0),c=u.guestsCount(s)}while(c.standard>0&&i<n.count)}),r},u.roomSold=function(t,e,a,i,r,l,s,c,m){if(!e||!t||!a)return{};var f=o.diff(e.endDate,e.startDate),d=u.guestsCount(i,r);d.standard||(i={adults:1,boys:0,children:0,kids:0},d=u.guestsCount(i,r)),d.extra||(r=u.peopleByBeds(s),d=u.guestsCount(i,r));var p={type:t,totalRate:e,status:m||"CONFIRMED",people:i,extraPeople:r,guestsCount:d,services:u.$generateRoomIncludedServices(t,i,f,c),beds:u.$generateRoomIncludedBeds(t,i,f,a,l),otherBeds:s||[],creationDate:new Date};return n.calculateVat(p.totalRate.amount,a),p},u.serviceSold=function(t,n,a,o){if(!t)return{};t.maxCount||(t.maxCount=1),o||(o=1),o>t.maxCount&&-1!=t.maxCount&&(o=t.maxCount),n||(n={adults:0,boys:0,kids:0,children:0});var i=moment.duration(a,"days"),r={type:"PRICE",currency:"EUR",initialAmount:0,finalAmount:0,vatRate:0,vatAmount:0};switch(t.paymentType){case"SINGLE":var u=t.paymentOptions[0];switch(t.frequency){case"LUMP_SUM":r.finalAmount=u.amount.finalAmount;break;case"DAILY":r.finalAmount=u.amount.finalAmount*a;break;case"MONTHLY":r.finalAmount=u.amount.finalAmount*Math.ceil(i.asMonths());break;case"YEARLY":r.finalAmount=u.amount.finalAmount*Math.ceil(i.asYears())}r.vatRate=u.amount.vatRate;break;case"PER_PERSON":_.forEach(t.paymentOptions,function(e){var o=0;switch(e.size){case"PER_ADULT":n.adults&&(o=e.amount.finalAmount*n.adults,r.vatRate=r.vatRate&&r.vatRate>e.amount.vatRate?r.vatRate:e.amount.vatRate);break;case"PER_BOY":n.boys&&(o=e.amount.finalAmount*n.boys,r.vatRate=r.vatRate&&r.vatRate>e.amount.vatRate?r.vatRate:e.amount.vatRate);break;case"PER_CHILD":n.children&&(o=e.amount.finalAmount*n.children,r.vatRate=r.vatRate&&r.vatRate>e.amount.vatRate?r.vatRate:e.amount.vatRate);break;case"PER_KID":n.kids&&(o=e.amount.finalAmount*n.kids,r.vatRate=r.vatRate&&r.vatRate>e.amount.vatRate?r.vatRate:e.amount.vatRate)}switch(t.frequency){case"DAILY":case"NIGHTLY":o*=a;break;case"MONTHLY":o*=Math.ceil(i.asMonths());break;case"YEARLY":o*=Math.ceil(i.asYears())}r.finalAmount+=o})}return r.finalAmount=r.finalAmount*o,r.initialAmount=r.finalAmount,r.vatAmount=e.vatAmount(r.finalAmount,r.vatRate),{service:t,amount:r,people:n,included:"INCLUDED"==t.bookability,status:"CONFIRMED",count:o}},u.updateServiceSoldPrice=function(t,n,a,i,r){var l=a;t.startDate&&t.endDate&&(l=o.diff(t.startDate,t.endDate));var s=r?angular.copy(t):null;_.assign(t,u.serviceSold(t.service,n||t.people,l,i||t.count)),t.amount=s?s.amount:t.amount,t.amount.vatAmount=e.vatAmount(t.amount.finalAmount,t.amount.vatRate)},u.bedSold=function(t,n,a,o){if(!t)return{};var i={type:"PRICE",currency:"EUR",initialAmount:0,finalAmount:0,vatRate:o,vatAmount:0};return(n=u.normalizePeople(n)).adults&&n.adults>0&&(i.finalAmount+=n.adults*t.adultsPrice),n.boys&&n.boys>0&&(i.finalAmount+=n.boys*t.boysPrice),n.children&&n.children>0&&(i.finalAmount+=n.children*t.childrenPrice),n.kids&&n.kids>0&&(i.finalAmount+=n.kids*t.kidsPrice),"DAILY"!=t.frequency&&"NIGHTLY"!=t.frequency||(i.finalAmount*=a),i.initialAmount=i.finalAmount,i.vatAmount=e.vatAmount(i.finalAmount,i.vatRate),{bed:t,people:n,amount:i,status:"CONFIRMED"}},u.updateBedSoldPrice=function(t,n,a,i,r){var l=a;t.startDate&&t.endDate&&(l=o.diff(t.startDate,t.endDate));var s=r?angular.copy(t):null;_.assign(t,u.bedSold(t.bed,n||t.people,l,i||t.amount.vatRate)),t.amount=s?s.amount:t.amount,t.amount.vatAmount=e.vatAmount(t.amount.finalAmount,t.amount.vatRate)},u.updatePolicyAmount=function(t,n,a){if(t&&n&&a){var o=n.cancellation.chargeNights,i=n.cancellation.percentage||0;i=i<=100?i:100;var r={finalAmount:0};if(o<0||o==a)r.finalAmount=e.fixedDecimals(t.totalRate.amount.finalAmount);else for(var u=0;u<o;u++){var l=t.totalRate.dailyRates[u];l&&(r.finalAmount+=e.fixedDecimals(l.amount.finalAmount))}r.finalAmount=r.finalAmount*(i/100),n.amount=r}},u.calculateTotalPrice=function(t){if(t){o.diff(t.checkin,t.checkout);var n=0,a=0,i=0,r=0,u=0,l=0,s=[],c=t.hotel&&t.hotel.vatTax&&t.hotel.vatTax.finalAmount?t.hotel.vatTax.finalAmount:10,m={},f=0,d=0,p=0,v=0;_.forEach(t.rooms,function(t,o,A){t.totalRate.amount.vatRate=c,t.totalRate.amount.vatAmount=e.vatAmount(t.totalRate.amount.finalAmount,t.totalRate.amount.vatRate),"CONFIRMED"==t.status||"EARLY_CHECKOUT"==t.status?(n+=t.totalRate.amount.initialAmount,a+=t.totalRate.amount.finalAmount,u+=t.totalRate.amount.vatAmount,_.forEach(t.totalRate.dailyRates,function(t){if(!_.isNil(t.promotion)){var e=0;e="PRICE"!=t.promotion.discount.type?t.amount.initialAmount-t.amount.initialAmount*((100-t.promotion.discount.finalAmount)/100):t.amount.initialAmount-t.promotion.discount.finalAmount;var n=_.find(s,function(e){return t.promotion.id&&e.promo.id==t.promotion.id});n?n.price+=e:s.push({promo:t.promotion,percentage:"PRICE"!=t.promotion.discount.type?t.promotion.discount.finalAmount+"%":null,price:e}),l+=e}}),f+=t.totalRate.amount.initialAmount,v+=t.totalRate.amount.initialAmount,t.totalRate.amount.vatRate?m[t.totalRate.amount.vatRate]=m[t.totalRate.amount.vatRate]?m[t.totalRate.amount.vatRate]+t.totalRate.amount.vatAmount:t.totalRate.amount.vatAmount:m[c]=m[c]?m[c]+t.totalRate.amount.vatAmount:t.totalRate.amount.vatAmount,_.forEach(t.services,function(t){n+=t.amount.finalAmount,a+=t.amount.finalAmount,u+=t.amount.vatAmount,t.amount.initialAmount=t.amount.initialAmount||angular.copy(t.amount.finalAmount),d+=t.amount.initialAmount,v+=t.amount.initialAmount;var e=!1;_.forEach(m,function(n,a){a&&a==t.amount.vatRate&&(m[a]+=t.amount.vatAmount,e=!0)}),e||t.amount.vatRate&&(m[t.amount.vatRate]=m[t.amount.vatRate]?m[t.amount.vatRate]+t.amount.vatAmount:t.amount.vatAmount)}),_.forEach(t.otherBeds,function(t){t.amount&&(n+=t.amount.finalAmount,a+=t.amount.finalAmount,u+=t.amount.vatAmount,t.amount.initialAmount=t.amount.initialAmount||angular.copy(t.amount.finalAmount),p+=t.amount.initialAmount,v+=t.amount.initialAmount,t.amount.vatRate?m[t.amount.vatRate]=m[t.amount.vatRate]?m[t.amount.vatRate]+t.amount.vatAmount:t.amount.vatAmount:m[c]=m[c]?m[c]+t.amount.vatAmount:t.amount.vatAmount)})):(i+=t.cancelAmount.initialAmount,r+=t.cancelAmount.finalAmount)}),t.cancelAmount||(t.cancelAmount={currency:"EUR",type:"PRICE"});var A=["CANCELLED","NO_SHOW"];t.cancelAmount.initialAmount=_.includes(A,t.status)?t.cancelAmount.initialAmount:e.fixedDecimals(i),t.cancelAmount.finalAmount=_.includes(A,t.status)?t.cancelAmount.finalAmount:e.fixedDecimals(r),t.totalAmount||(t.totalAmount={currency:"EUR",type:"PRICE"}),t.totalAmount.initialAmount=_.includes(A,t.status)?t.totalAmount.initialAmount:n,t.totalAmount.finalAmount=_.includes(A,t.status)?t.totalAmount.finalAmount:a,t.discount||(t.discount={finalAmount:0,type:"PERCENTAGE"});var h=e.calculateDiscount(t.totalAmount.finalAmount,t.discount.finalAmount,"PERCENTAGE");t.totalAmount.discountRate=t.discount.finalAmount,t.totalAmount.discountAmount=h,t.totalAmount.finalAmount=t.totalAmount.finalAmount-h,t.grandAmount={initialAmount:t.totalAmount.initialAmount,finalAmount:t.totalAmount.finalAmount},t.grandAmount.initialAmount+=t.cancelAmount&&t.cancelAmount.initialAmount?t.cancelAmount.initialAmount:0,t.grandAmount.finalAmount+=t.cancelAmount&&t.cancelAmount.finalAmount?t.cancelAmount.finalAmount:0;var y=v-l-t.totalAmount.finalAmount-h;if(t.totalPriceDetails={rooms:e.fixedDecimals(f),services:e.fixedDecimals(d),otherBeds:e.fixedDecimals(p),subTotal:e.fixedDecimals(v),discountPromo:e.fixedDecimals(l),discountHotel:e.fixedDecimals(y)},t.arrayPromo=s,t.totalVat={total:u,vatMap:m},t.totalAmount.discountRate){var g={};u=0,_.forEach(m,function(e,n){g[n]=e-parseFloat(e)/100*parseFloat(t.totalAmount.discountRate),u+=g[n]}),t.totalVat={total:u,vatMap:g}}}},u.calculateVatMap=function(t,e){if(t){var n=0,a=t.hotel&&t.hotel.vatTax&&t.hotel.vatTax.finalAmount?t.hotel.vatTax.finalAmount:10,o={};if(_.forEach(t.rooms,function(t,e,i){"EARLY_CHECKOUT"==t.status?(n+=t.cancelAmount.vatAmount,t.totalRate.cancelAmount.vatRate?o[t.totalRate.cancelAmount.vatRate]=o[t.totalRate.cancelAmount.vatRate]?o[t.totalRate.cancelAmount.vatRate]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount:o[a]=o[a]?o[a]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount,_.forEach(t.services,function(t){n+=t.cancelAmount.vatAmount;var e=!1;_.forEach(o,function(n,a){a&&a==t.cancelAmount.vatRate&&(o[a]+=t.cancelAmount.vatAmount,e=!0)}),e||t.cancelAmount.vatRate&&(o[t.cancelAmount.vatRate]=o[t.cancelAmount.vatRate]?o[t.cancelAmount.vatRate]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount)}),_.forEach(t.otherBeds,function(t){t.cancelAmount&&(n+=t.cancelAmount.vatAmount,t.cancelAmount.vatRate?o[t.cancelAmount.vatRate]=o[t.cancelAmount.vatRate]?o[t.cancelAmount.vatRate]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount:o[a]=o[a]?o[a]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount)})):"CONFIRMED"==t.status&&(n+=t.totalRate.amount.vatAmount,t.totalRate.amount.vatRate?o[t.totalRate.amount.vatRate]=o[t.totalRate.amount.vatRate]?o[t.totalRate.amount.vatRate]+t.totalRate.amount.vatAmount:t.totalRate.amount.vatAmount:o[a]=o[a]?o[a]+t.totalRate.amount.vatAmount:t.totalRate.amount.vatAmount,_.forEach(t.services,function(t){n+=t.amount.vatAmount;var e=!1;_.forEach(o,function(n,a){a&&a==t.amount.vatRate&&(o[a]+=t.amount.vatAmount,e=!0)}),e||t.amount.vatRate&&(o[t.amount.vatRate]=o[t.amount.vatRate]?o[t.amount.vatRate]+t.amount.vatAmount:t.amount.vatAmount)}),_.forEach(t.otherBeds,function(t){t.amount&&(n+=t.amount.vatAmount,t.amount.vatRate?o[t.amount.vatRate]=o[t.amount.vatRate]?o[t.amount.vatRate]+t.amount.vatAmount:t.amount.vatAmount:o[a]=o[a]?o[a]+t.amount.vatAmount:t.amount.vatAmount)}))}),e>=0){var i={};n=0,_.forEach(o,function(e,a){i[a]=e-parseFloat(e)/100*parseFloat(t.totalAmount.discountRate),n+=i[a]}),t.totalVat={total:n,vatMap:i}}}},u.applyDiscount=function(t,n,a){if(t&&n){a=a||"PRICE";var o,i,r=t.totalAmount.finalAmount;"PERCENTAGE"==a?(o=e.calculateDiscount(r,n,a),i=n):(o=n,i=e.calculateDiscount(r,n,a)),t.totalAmount.discountRate=i,t.totalAmount.discountAmount=o,t.totalAmount.finalAmount=r-o}},u.calculateTotalTransfers=function(t){if(t){(_.isNil(t.externalServices)||_.isNil(t.externalServices.transfersServices))&&(t.externalServices={transfersServices:[]});var e=0,n=0;_.forEach(t.externalServices.transfersServices,function(t,a,o){"CONFIRMED"==t.status&&(e+=t.amount.finalAmount,n+=t.amount.vatAmount,t.surcharge&&(e+=t.transferService.nightCharge.finalAmount))}),t.totalTransfers={totalAmount:e,vatAmount:n,taxableAmount:e-n}}},u.calculateTotalRooms=function(t){if(t&&!_.isNil(t.rooms)){var e=0,n=0,a=0,o=0,i=0,r=[],u=0,l=t.rooms.length;return _.forEach(t.rooms,function(t,s,c){if("CONFIRMED"==t.status||"EARLY_CHECKOUT"==t.status){if(t.extendedRoom?(u+=1,l-=1):e+=1,!_.isEmpty(t.dailyDetails)&&_.some(t.dailyDetails,"room")){var m=_.uniqBy(t.dailyDetails,"room.name");r.push(_.size(m)>1?m[0].room.name+"+":m[0].room.name)}"STANDARD"==t.totalRate.type?t.totalRate.cancellationPolicy&&t.totalRate.cancellationPolicy.flexible?o++:a++:"NOT_REFUNDABLE"==t.totalRate.type&&i++}else n+=1}),{active:e,cancelled:n,total:l,standard:a,flexible:o,notRefundable:i,physicalRooms:r,extendedRooms:u}}},u.calculateRoomTotalPrice=function(t){if(t){var e={initialAmount:t.totalRate.amount.initialAmount,finalAmount:t.totalRate.amount.finalAmount,servicesAmount:0,bedsAmount:0};_.forEach(t.services,function(t){e.initialAmount+=_.isNil(t.amount.initialAmount)?t.amount.finalAmount:t.amount.initialAmount,e.finalAmount+=t.amount.finalAmount,e.servicesAmount+=t.amount.finalAmount}),_.forEach(t.otherBeds,function(t){e.initialAmount+=_.isNil(t.amount.initialAmount)?t.amount.finalAmount:t.amount.initialAmount,e.finalAmount+=t.amount.finalAmount,e.bedsAmount+=t.amount.finalAmount}),t.totalPrice=e}},u.createCancelledReservation=function(t,n){var a=this;n=n||(t.hotel.vatTax?t.hotel.vatTax.finalAmount:0);var o=angular.copy(t);o.cancelAmount?_.assign(o.cancelAmount,{initialAmount:0,finalAmount:0}):o.cancelAmount={initialAmount:0,finalAmount:0};var i,r=moment();return _.forEach(o.rooms,function(t){if("CONFIRMED"==t.status){if(t.endDate&&moment(t.endDate).isBefore(r,"days"))return;t.cancelled=!1,_.assign(t,a.createCancelledRoom(t,o,r,n)),o.cancelAmount.initialAmount+=e.fixedDecimals(t.cancelAmount.finalAmount),o.cancelAmount.finalAmount+=e.fixedDecimals(t.cancelAmount.finalAmount)}else t.cancelled=!0}),i=o.cancelAmount.finalAmount<=0?"reservation.manager.cancel.free":"reservation.manager.cancel.penalty",o.statusText=i,o.cancelDate=r.toDate(),o.status="CANCELLED",o.sendEmail=!0,o},u.createCancelledRoom=function(t,n,a,i){var r=a?moment(a):moment();if(t.endDate&&moment(t.endDate).isBefore(r,"days"))return t;o.diff(t.startDate||n.checkin,r);var u=angular.copy(t);return u.cancelled=!1,u.cancelAmount=u.cancelAmount?u.cancelAmount:{},u.totalRate.cancellationPolicy?(u.tempStatus="penalty",u.cancelAmount.finalAmount=u.totalRate.cancellationPolicy.amount.finalAmount,u.totalRate.cancellationPolicy.limitDate&&moment(u.totalRate.cancellationPolicy.limitDate).utcOffset((n.hotel.addressInfo.offset||0)/60).isSameOrAfter(r)&&(u.cancelAmount.finalAmount=0,u.tempStatus="free")):(u.cancelAmount.finalAmount=0,u.tempStatus="free"),u.cancelAmount.initialAmount=e.fixedDecimals(u.cancelAmount.finalAmount),u.cancelAmount.finalAmount=e.fixedDecimals(u.cancelAmount.finalAmount),u.cancelled=!1,u.cancelAmount.vatRate=u.totalRate.amount.vatRate?u.totalRate.amount.vatRate:i,u.cancelAmount.vatAmount=e.vatAmount(u.cancelAmount.finalAmount,u.cancelAmount.vatRate),u.cancelDate=r.toDate(),u.status="CANCELLED",_.forEach(u.services,function(t){t.status="CANCELLED"}),_.forEach(u.otherBeds,function(t){t.status="CANCELLED"}),u},u.createNoShowReservation=function(t,n){n=n||(t.hotel.vatTax?t.hotel.vatTax.finalAmount:0);var a=angular.copy(t),o=new Date,i=(moment(o),0);return _.forEach(a.rooms,function(t){t.cancelAmount=t.cancelAmount?t.cancelAmount:{},t.totalRate.noShowPolicy?(t.tempStatus="penalty",t.cancelAmount.finalAmount=t.totalRate.noShowPolicy.amount.finalAmount):(t.cancelAmount.finalAmount=0,t.tempStatus="free"),t.cancelAmount.finalAmount=e.fixedDecimals(t.cancelAmount.finalAmount),"CONFIRMED"==t.status?(i+=t.cancelAmount.finalAmount,t.cancelled=!1,t.cancelAmount.vatRate=t.totalRate.amount.vatRate?t.totalRate.amount.vatRate:n,t.cancelAmount.vatAmount=e.vatAmount(t.cancelAmount.finalAmount,t.cancelAmount.vatRate),t.cancelDate=o,t.status="NO_SHOW",_.forEach(t.services,function(t){t.status="NO_SHOW"}),_.forEach(t.otherBeds,function(t){t.status="NO_SHOW"})):t.cancelled=!0}),a.cancelAmount={initialAmount:e.fixedDecimals(i),finalAmount:e.fixedDecimals(i),total:e.fixedDecimals(0)},a.cancelDate=o,a.status="NO_SHOW",a.sendEmail=!0,a},u.createEarlyCheckoutReservation=function(t,n){var a=this;n=n||(t.hotel.vatTax?t.hotel.vatTax.finalAmount:0);var i=angular.copy(t),r=new Date,u=moment(r);i.initialAmount=angular.copy(i.totalAmount),_.assign(i.totalAmount,{initialAmount:0,finalAmount:0});var l,s,c,m,f,d;return o.diff(i.checkin,u)>0?(_.forEach(i.rooms,function(t){if("CONFIRMED"==t.status){if(t.endDate&&moment(t.endDate).isBefore(u,"days"))return void(t.status="EARLY_CHECKOUT");t.cancelled=!1,_.assign(t,a.createEarlyCheckoutRoom(t,i,u,n)),t.checkoutDone=r,i.totalAmount.initialAmount+=t.totalRoomAmount.initialAmount,i.totalAmount.finalAmount+=t.totalRoomAmount.finalAmount}else t.cancelled=!0}),s="reservation.earlycheckout.title",c="reservation.earlycheckout.reason.label",m="reservation.earlycheckout.penalty",l="reservation.manager.earlyCheckout",f="reservation.earlycheckout.free.label",d="reservation.earlycheckout.penalty.label",i.checkoutDone=r,i.status="EARLY_CHECKOUT",i.totalAmount.initialAmount=e.fixedDecimals(i.totalAmount.initialAmount),i.totalAmount.finalAmount=e.fixedDecimals(i.totalAmount.finalAmount),i.totalAmount.vatRate=i.totalAmount.vatRate||n,i.totalAmount.vatAmount=e.vatAmount(i.totalAmount.finalAmount,i.totalAmount.vatRate)):(s="reservation.deleteCheckin.title",c="reservation.deleteCheckin.reason.label",m="reservation.deleteCheckin.penalty",l=(i=a.createCancelledReservation(t,n)).cancelAmount.finalAmount>0?"reservation.manager.deleteCheckin":"reservation.manager.deleteCheckin.free",f="reservation.cancellation.free",d="reservation.bill.penalty"),i.title=s,i.reason=c,i.penalty=m,i.statusText=l,i.freeLabel=f,i.penaltyLabel=d,i.sendEmail=!0,i},u.createEarlyCheckoutRoom=function(t,e,n,a){var o=u.createTerminatedRoom(t,e,n,a,"EARLY_CHECKOUT");return o&&(o.checkoutDone=new Date),o},u.createTerminatedRoom=function(t,n,a,o,i){if(!t||"CONFIRMED"!=t.status)return null;var r=a?moment(a):moment(),u=t.endDate?moment(t.endDate):null;if(u&&u.isSame(r,"days"))return angular.copy(t);var l=moment(t.startDate||n.checkin);u=u||moment(n.checkout);var s=moment.range(l,u);if(!s.contains(r,{exclusive:!0}))return null;var c=this,m=t.totalRate.amount.currency;o=o||t.totalRate.amount.vatRate||n.hotel.vatTax.finalAmount;var f=angular.copy(t);f.totalRoomAmount={initialAmount:0,finalAmount:0,currency:m},f.cancelled=!1;var d=moment.range(l,r);f.paymentServices=[],_.forEach(f.services,function(t){c.terminateServiceSold(t,d,i,s)&&(t.included||"INCLUDED"==t.service.bookability||f.paymentServices.push(t),f.totalRoomAmount.initialAmount+=e.fixedDecimals(t.amount.initialAmount||t.amount.finalAmount),f.totalRoomAmount.finalAmount+=e.fixedDecimals(t.amount.finalAmount))}),_.forEach(f.beds,function(t){t&&"CONFIRMED"==t.status&&(t.status=i||t.status)}),_.forEach(f.otherBeds,function(t){c.terminateBedSold(t,d,o,i,s)&&(f.totalRoomAmount.initialAmount+=e.fixedDecimals(t.amount.initialAmount||t.amount.finalAmount),f.totalRoomAmount.finalAmount+=e.fixedDecimals(t.amount.finalAmount))}),f.amount=f.totalRoomAmount,f.status=i||t.status,f.endDate=moment(d.end).toDate(),f.initialAmount=angular.copy(t.totalRate.amount),f.tempStatus="earlyCheckout";var p="EARLY_CHECKOUT"==f.status&&d.end.isSame(moment(),"day")?moment.range(d.start,moment(d.end).add(1,"days")):d;if(f.totalRate.initialDailyRates=angular.copy(f.totalRate.dailyRates),"STANDARD"==f.totalRate.type){_.forEach(f.totalRate.initialDailyRates,function(t){t.disabled=!p.contains(t.date,{exclusive:!0}),t.toRemove=t.disabled}),f.totalRate.dailyRates=_.filter(f.totalRate.initialDailyRates,function(t){return!t.toRemove});g={initialAmount:0,finalAmount:0,currency:m};_.forEach(f.totalRate.dailyRates,function(t){g.initialAmount+=e.fixedDecimals(t.amount.initialAmount||t.amount.finalAmount),g.finalAmount+=e.fixedDecimals(t.amount.finalAmount)}),_.assign(f.totalRate.amount,g)}else if("NOT_REFUNDABLE"==f.totalRate.type){var v=f.totalRate.cancellationPolicy?f.totalRate.cancellationPolicy.cancellation:null,A=v?v.chargeNights>0?v.chargeNights:-1:null,h=A?A>0&&A<s.diff("days")?moment.range(s.start,moment(s.start).add(A,"days")):s:null,y=h&&h.diff("days")>p.diff("days")?h:p;_.forEach(f.totalRate.initialDailyRates,function(t){var n=moment(t.date);y.contains(n,{exclusive:!0})?(t.disabled=!1,t.toRemove=!1,!p.contains(n,{exclusive:!0})&&h&&h.contains(n,{exclusive:!0})&&(f.tempStatus="penalty",t.disabled=!0,v.percentage<100&&(t.amount.initialAmount=t.amount.finalAmount,t.amount.finalAmount=e.calculateDiscount(t.amount.finalAmount,v.percentage,"PERCENTAGE")))):(t.disabled=!0,t.toRemove=!0)}),f.totalRate.dailyRates=_.filter(f.totalRate.initialDailyRates,function(t){return!t.toRemove});var g={initialAmount:0,finalAmount:0,currency:m};_.forEach(f.totalRate.dailyRates,function(t){g.initialAmount+=e.fixedDecimals(t.amount.initialAmount||t.amount.finalAmount),g.finalAmount+=e.fixedDecimals(t.amount.finalAmount)}),g.finalAmount<(f.totalRate.cancellationPolicy&&f.totalRate.cancellationPolicy.amount?f.totalRate.cancellationPolicy.amount.finalAmount:0)&&(g=f.totalRate.cancellationPolicy.amount,f.tempStatus="penalty"),_.assign(f.totalRate.amount,g)}return f.totalRate.amount.vatRate=f.totalRate.amount.vatRate||o,f.totalRate.amount.vatAmount=e.vatAmount(f.totalRate.amount.finalAmount,f.totalRate.amount.vatRate),f.totalRoomAmount.initialAmount=e.fixedDecimals(f.totalRoomAmount.initialAmount+f.totalRate.amount.initialAmount),f.totalRoomAmount.finalAmount=e.fixedDecimals(f.totalRoomAmount.finalAmount+f.totalRate.amount.finalAmount),c.calculateRoomTotalPrice(f),f},u.terminateServiceSold=function(t,e,n,a){if(!t||"CONFIRMED"!=t.status)return!1;var o=moment.range(moment(t.startDate||e.start),moment(t.endDate||e.end));if(!o.contains(e.end))return!1;var i=(o=moment.range(o.start,e.end)).diff("days"),r=u.serviceSold(t.service,t.people,i,t.count);if(t.status=n||t.status,t.initialAmount=angular.copy(t.amount),t.amount=angular.copy(r.amount),"DAILY"==t.service.frequency||"NIGHTLY"==t.service.frequency){if(a&&a.start&&a.end){t.dailyRates=[];for(var l=u.serviceSold(t.service,t.people,1,t.count).amount,s=moment(t.startDate||a.start),c=moment(t.endDate||a.end),m=moment(a.start);m.isBefore(moment(a.end),"days");m.add(1,"days"))t.dailyRates.push({date:m.toDate(),amount:m.isBefore(s,"days")||m.isAfter(c,"days")?null:l,disabled:m.isSameOrAfter(e.end,"days")})}t.endDate=moment(e.end).toDate()}return!0},u.terminateBedSold=function(t,e,n,a,o){if(!t||"CONFIRMED"!=t.status)return!1;var i=moment.range(t.startDate||e.start,t.endDate||e.end);if(!i.contains(e.end))return!1;var r=(i=moment.range(i.start,e.end)).diff("days"),l=u.bedSold(t.bed,t.people,r,n);if(t.status=a||t.status,t.initialAmount=angular.copy(t.amount),t.amount=angular.copy(l.amount),"DAILY"==t.bed.frequency||"NIGHTLY"==t.bed.frequency){if(o&&o.start&&o.end){t.dailyRates=[];for(var s=u.bedSold(t.bed,t.people,1,n).amount,c=moment(t.startDate||o.start),m=moment(t.endDate||o.end),f=moment(o.start);f.isBefore(moment(o.end),"days");f.add(1,"days"))t.dailyRates.push({date:f.toDate(),amount:f.isBefore(c,"days")||f.isAfter(m,"days")?null:s,disabled:f.isSameOrAfter(e.end,"days")})}t.endDate=moment(e.end).toDate()}return!0},u.bestPromotion=function(t){var e,n=0;return _.forEach(t,function(t){if(!t.secret)if("STANDARD"==t.promotionType){if(!e)return n=t.discount.finalAmount-t.discount.initialAmount,void(e=t);if(t.discount.finalAmount-t.discount.initialAmount>n){if(!t.onArrival&&e.onArrival)return;n=t.discount.finalAmount-t.discount.initialAmount,e=t}else t.discount.finalAmount-t.discount.initialAmount>n&&t.onArrival&&!e.onArrival&&(n=t.discount.finalAmount-t.discount.initialAmount,e=t)}else n=t.discount.finalAmount-t.discount.initialAmount,e=t}),e},u.bestPromotionForRates=function(t){var e=[];return _.forEach(t,function(t){e=_.union(promotion,t.promotions)}),u.bestPromotion(e)},u.getRoomPenalty=function(t,e,n){var a=null;if(t.totalRate.cancellationPolicy){var o=moment.isMoment(n)?n:moment(n);a=t.totalRate.cancellationPolicy.limitDate&&moment(t.totalRate.cancellationPolicy.limitDate).utcOffset((e.addressInfo.offset||0)/60).isSameOrAfter(o)?{finalAmount:0,initialAmount:0}:t.totalRate.cancellationPolicy.amount}return a},u.generatePhysicalRoomsList=function(t,e){if(e&&!_.isEmpty(e))return t=_.isNil(t)?{}:t,_.forEach(e,function(e){_.forEach(e.roomsAvailabilities,function(e){if(e.roomClosed)return!0;t[e.room.id]=t[e.room.id]||[],_.some(t[e.room.id],function(t){return moment(t.date).isSame(moment(e.date),"day")})||t[e.room.id].push({date:e.date,roomsSold:[]})})}),t},u.isRoomInPenalty=function(t,e,n){var a=u.getRoomPenalty(t,e,n);return angular.isObject(a)&&a.finalAmount>0},u.maskCardPan=function(t){return String(t).replace(/-/g,"").replace(/.*(\d{4})$/,"**** **** **** $1")},u.beautifyCardPan=function(t){return String(t).replace(/-/g,"").replace(/(.{4})/g,"$1 ").replace(/-([^-]*)$/,"$1")},u}t.$inject=["$translate","NumberUtils","AmountUtils","ObjectUtils","DateUtils","LocalStorage","RESERVATION"],angular.module("itaca.utils").factory("ReservationUtils",t)}(),function(){"use strict";angular.module("itaca.utils").value("RESERVATION",{rooms:[]})}(),function(){"use strict";angular.module("itaca.utils").factory("ReviewsUtils",function(){var t={};return t.generateScoreLabel=function(t){if(t){var e;switch(t){case 4:e="review.score.bad";break;case 5:e="review.score.poor";break;case 6:e="review.score.sufficient";break;case 7:e="review.score.good";break;case 8:e="review.score.very.good";break;case 9:e="review.score.excellent";break;case 10:e="review.score.fabulous"}return e}},t})}(),function(){"use strict";function t(t){return function(e,n){if("text"===n){var a="";(a=t.trustAsHtml(e)).$$unwrapTrustedValue&&(a=a.$$unwrapTrustedValue()),e=a}return e}}t.$inject=["$sce"],angular.module("itaca.utils").factory("sceStrategy",t)}(),function(){"use strict";function t(t,e){var n=this;this.$$redirectUrl=e||"/login",this.responseError=function(e){return e.data&&401===e.data.status&&location.assign(n.$$redirectUrl),t.reject(e)}}angular.module("itaca.utils").provider("SessionExpiredInterceptor",function(){var e="/login";this.init=function(t){if(!_.isString(t))return!1;e=t},this.$get=["$q",function(n){return new t(n,e)}]})}(),function(){"use strict";angular.module("itaca.utils").factory("StringUtils",function(){var t={};return t.isBlank=function(t){return _.isUndefined(t)||_.isNull(t)||_.isEmpty(t)},t.isNotBlank=function(e){return!t.isBlank(e)},t.isEmpty=function(e){return t.isNotBlank(e)&&_.isEmpty(_.trim(e))},t.isNotEmpty=function(e){return!t.isEmpty(e)},t.normalizeForUrl=function(t,e){return _.toLower(_.replace(_.deburr(e?_.snakeCase(t):t),/[^\w]/gi,""))},t})}(),function(){"use strict";angular.module("itaca.utils").factory("textTransform$$service",function(){var t={};return t.transform=function(t,e,n){t.on("input",function(){var t=n(e.$viewValue);e.$setViewValue(t),e.$render()})},t})}(),function(){"use strict";function t(t){var e={};return e.buildUrl=function(e,n){var a=t(n);return a.length>0&&(e+=(-1===e.indexOf("?")?"?":"&")+a),e},e.withParam=function(t,n,a){var o=t.split("?")[1],i=o?JSON.parse('{"'+o.replace(/&/g,'","').replace(/=/g,'":"')+'"}',function(t,e){return""===t?e:decodeURIComponent(e)}):{};return i[n]=a,e.buildUrl(t,i)},e.parseUrl=function(t){var e=document.createElement("a");return e.href=t,e},e}t.$inject=["$httpParamSerializer"],angular.module("itaca.utils").factory("UrlUtils",t)}();