/*******************************************************************************
********************************************************************************
********************************************************************************
***	   itaca-ng-utils														 
***    Copyright (C) 2016-2018   Chroma Italy Hotels srl	 
***                                                                          
***    This program is free software: you can redistribute it and/or modify  
***    it under the terms of the GNU General Public License as published by  
***    the Free Software Foundation, either version 3 of the License, or     
***    (at your option) any later version.                                   
***                                                                          
***    This program is distributed in the hope that it will be useful,       
***    but WITHOUT ANY WARRANTY; without even the implied warranty of        
***    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         
***    GNU General Public License for more details.                          
***                                                                          
***    You should have received a copy of the GNU General Public License     
***    along with this program.  If not, see <http://www.gnu.org/licenses/>. 
********************************************************************************
********************************************************************************
*******************************************************************************/
!function(){"use strict";angular.module("itaca.utils",["ngMaterial","itaca.services","pascalprecht.translate","tmh.dynamicLocale","LocalStorageModule"]),angular.module("itaca.utils").config(["$windowProvider","$translateProvider","tmhDynamicLocaleProvider",function(t,e,n){var a=(t.$get().navigator.language||t.$get().navigator.userLanguage).split("-")[0].toLowerCase();e.useLoader("i18nLoader"),e.preferredLanguage(a),e.useCookieStorage(),e.useMissingTranslationHandlerLog(),$translateSanitizationProvider.addStrategy("sce","sceStrategy"),e.useSanitizeValueStrategy("sce"),n.localeLocationPattern("/resources/public/js/i18n/angular-locale_{{locale}}.js"),n.useCookieStorage(),n.defaultLocale(a)}])}(),function(){"use strict";function t(a){var t={sum:function(t,e){if(!t)return e;if(!e)return t;var n=angular.copy(t);return n.initialAmount=a.fixedDecimals(n.initialAmount||0),n.finalAmount=a.fixedDecimals(n.finalAmount||0),n.initialAmount+=a.fixedDecimals(e.initialAmount),n.finalAmount+=a.fixedDecimals(e.finalAmount),n},subtract:function(t,e){if(!t)return e;if(!e)return t;var n=angular.copy(t);return n.initialAmount=a.fixedDecimals(n.initialAmount||0),n.finalAmount=a.fixedDecimals(n.finalAmount||0),n.initialAmount-=a.fixedDecimals(e.initialAmount),n.finalAmount-=a.fixedDecimals(e.finalAmount),n},calculateDiscount:function(t){if(!t)return null;t.discountAmount=a.fixedDecimals(t.initialAmount-t.finalAmount),t.discountRate=a.calculateDiscount(t.initialAmount,t.discountAmount)},calculateVat:function(t,e){if(!t)return null;t.vatRate=a.fixedDecimals(e),t.vatAmount=a.vatAmount(t.finalAmount,t.vatRate)}};return t}t.$inject=["NumberUtils"],angular.module("itaca.utils").factory("AmountUtils",t)}(),function(){"use strict";function t(t){var a=this;this.$init=function(){_.isPlainObject(t)&&_.forEach(t,function(t,e){a.addOption(e,t)})},this.addOption=function(t,e){return!!angular.isString(t)&&(a[t]=e,!0)},this.addOptionStrict=function(t,e){return!!angular.isString(t)&&(!a.hasOwnProperty(t)&&(a[t]=e,!0))},this.updateOption=function(t,e){if(!angular.isString(t))return!1;if(!a.hasOwnProperty(t))return a.addOption(t,e);var n=a[t];return a[t]=e,n},this.$init()}angular.module("itaca.utils").provider("AppOptions",function(){var n={defaultLang:"en",page:{title:"Home"}};this.init=function(t,e){if(!_.isPlainObject(t))return!1;_.isBoolean(e)&&e?n=t:_.assign(n,t)},this.$get=function(){return new t(n)}})}(),function(){"use strict";function t(n,t){var e={init:function(){t.onbeforeunload=function(t){var e={};if(n.$broadcast("onBeforeUnload",e).defaultPrevented)return t.returnValue=e.message,e.message},t.onunload=function(){n.$broadcast("onUnload")}}};return e}t.$inject=["$rootScope","$window"],angular.module("itaca.utils").factory("BeforeUnload",t)}(),function(){"use strict";angular.module("itaca.utils").factory("ContactUtils",function(){var t={getUri:function(t,e){var n="";switch(t){case"PHONE":case"MOBILE":case"FAX":n="tel:";break;case"MAIL":n="mailto:";break;case"WEBSITE":n="http://";break;case"FACEBOOK":n="https://www.facebook.com/";break;case"TWITTER":n="https://www.twitter.com/";break;case"INSTAGRAM":n="https://www.instagram.com/";break;default:n="http://"}return n+e}};return t})}(),function(){"use strict";function t(e){var t={response:function(t){return e.convertDateStringsToDates(t),t},request:function(t){return e.convertDatesToUTCStrings(t),t}};return t}t.$inject=["DateUtils"],angular.module("itaca.utils").factory("DateInterceptor",t)}(),function(){"use strict";function t(l,s,c,e){var m={absoluteDate:function(t,e){return m.absoluteMoment(t,e).toDate()},absoluteMoment:function(t,e){var n=s(t||void 0);if(!n.isValid())throw new Error("The date is not valid!");var a=s(n).utcOffset(0,!0);return e?a.startOf("day"):a},dateForTimezone:function(t,e){return s.tz(t,e)},hotelDate:function(t){return e.hotel&&e.hotel.addressInfo&&(e.hotel.addressInfo.timeZoneId||e.hotel.addressInfo.offset)?e.hotel.addressInfo.timeZoneId?m.dateForTimezone(e.hotel.addressInfo.timeZoneId):s(t).utcOffset(e.hotel.addressInfo.offset/60):s(t).utcOffset((e.defaultOffset||0)/60)},convertDateStringsToDates:function(t,e,n){if("object"!=typeof t)return t;e=e||10,n=n||0;var a=c&&c.dateString?c.dateString:/^(\d{4}|\+\d{6})(?:-(\d{2})(?:-(\d{2})(?:T(\d{2}):(\d{2}):(\d{2})\.(\d{1,})(Z|([\-+])((\d{2}):(\d{2})|(\d{4})))?)?)?)?$/;for(var o in t)if(t.hasOwnProperty(o)){var i,r=t[o];if("string"==typeof r&&(i=r.match(a))){var u=i[0];try{t[o]=s(u,s.HTML5_FMT.DATETIME_LOCAL_MS).toDate(),u=void 0}catch(t){l.warn("Error converting date '"+u+"': "+t)}}else"object"==typeof r&&n<e&&m.convertDateStringsToDates(r,e,n+1)}},convertDatesToUTCStrings:function(t,e,n){if("object"!=typeof t)return t;for(var a in e=e||10,n=n||0,t)if(t.hasOwnProperty(a)){var o=t[a];if(angular.isDate(o)||s.isMoment(o))try{t[a]=s(o).utc(!0).format()}catch(t){l.warn("Error converting date to utc'"+data+"': "+t)}else"object"==typeof o&&n<e&&m.convertDatesToUTCStrings(o,e,n+1)}},weekdays:function(){var a=[];return _.forEach(s.weekdays(!0),function(t,e){var n=s().day(t);a.push({label:t,labelShort:s.weekdaysShort(!0,e),day:n.day(),weekday:n.weekday(),isoWeekday:n.isoWeekday()})}),a},secondsToOffsetString:function(t){if(_.isNil(t))return"";if(t=Number(t),_.isNaN(t))return"";var e=String(Math.floor(Math.abs(t)/3600));e=e.length<2?"0"+e:e;var n=String(Math.floor(Math.abs(t)%3600/60));return(0<t?"+":"-")+e+(n=n.length<2?"0"+n:n)},timeRangeCheck:function(t,e,n){var a=s.utc(t).seconds(0).milliseconds(0),o=s.utc(e),i=s(a).hours(o.hours()).minutes(o.minutes()).seconds(0).milliseconds(0),r=s.utc(n),u=s(a).hours(r.hours()).minutes(r.minutes()).seconds(0).milliseconds(0);return u=u.hours()>=i.hours()&&u.hours()<=23?u:u.add(1,"days"),a=a.hours()>=i.hours()&&a.hours()<=23?a:a.add(1,"days"),s.range(i,u).contains(a)},diff:function(t,e,n,a){return s(e).startOf("day").diff(s(t).startOf("day"),n||"days",!!_.isBoolean(a)&&a)},to:function(t,e,n){return s(t).startOf("day").to(s(e).startOf("day"),!!_.isBoolean(n)&&n)}};return m}t.$inject=["$log","moment","REGEXP","AppOptions"],angular.module("itaca.utils").factory("DateUtils",t)}(),function(){"use strict";function t(a){var o={focusFirstInvalid:function(t){var e=angular.isObject(t)?t:document.getElementsByName(t)[0];if(e&&angular.isElement(e)&&angular.isFunction(e.querySelector)){var n=e.querySelector(".ng-invalid:not([disabled]):not([type='hidden'])");return!!n&&(_.isEqual(n.tagName.toLowerCase(),"ng-form")?o.focusFirstInvalid(n):(n.focus(),a.scrollToElementAnimated(n),!0))}},focusFirstInput:function(t){var e=angular.isObject(t)?t:document.getElementsByName(t)[0];if(e&&angular.isElement(e)&&angular.isFunction(e.querySelector)){var n=e.querySelector("input:not([disabled]):not([type='hidden'])");return!!n&&(n.focus(),a.scrollToElementAnimated(n,o.offset),!0)}},isInvalid:function(t){var e=document[t];if(e&&angular.isFunction(e.querySelector))return!!e.querySelector(".ng-invalid")}};return o}t.$inject=["$document"],angular.module("itaca.utils").factory("FormUtils",t)}(),function(){"use strict";function t(u,l){var n={isElementInView:function(t,e){var n=angular.element(t)[0];if(!n)return!1;var a=u.pageYOffset,o=a+u.innerHeight,i=n.offsetTop,r=i+n.offsetHeight;return!0===e?a<i&&r<o:i<=o&&a<=r},getScrollParent:function(t){var e=angular.element(t)[0];return null===e?null:e.scrollHeight>e.clientHeight?e:n.getScrollParent(e.parentNode)},addElement:function(t,e,n,a){var o=n?angular.isElement(n)?n.length?n[0]:n:document.querySelector(n):document.body;if(o){o=angular.element(o);var i=angular.merge(o.scope().$new(!0),e),r=l(t)(i);return a?o.prepend(r):o.append(r),i}return!1}};return n}t.$inject=["$window","$compile"],angular.module("itaca.utils").factory("HtmlUtils",t)}(),function(){"use strict";function i(l,s,c,m,e){return function(a){var t=[];if(angular.isString(e))t.push(e);else{if(!angular.isArray(e))return;t=e}var o={};o[a.queryParameter||"lang"]=a.key.toLowerCase().replace(/-/g,"_");var i={lang:a.key},r=[];_.forEach(t,function(t){var e=m(t)(i),n=s.get(e,angular.extend({params:o},a.$http)).then(function(t){return t.data},function(){return l.error("Error getting translations from url: "+e+" - lang: "+a.key+" - error: "+response.message),c.reject(a.key)});r.push(n)});var u=c.defer();return c.all(r).then(function(t){for(var e=t.length,n={},a=0;a<e;a++)for(var o in t[a])n[o]=t[a][o];u.resolve(n)},function(t){u.reject(t)}),u.promise}}angular.module("itaca.utils").provider("i18nLoader",function(){var o="/api/rs/public/i18n";this.setResources=function(t){if(!angular.isString(t)&&angular.isArray(t))return!1;o=t},this.$get=["$log","$http","$q","$interpolate",function(t,e,n,a){return new i(t,e,n,a,o)}]})}(),function(){"use strict";angular.module("itaca.utils").factory("IconUtils",function(){var t={languageIcons:function(){return{ITALIAN:{icon:"flag-icon flag-icon-it"},ENGLISH:{icon:"flag-icon flag-icon-gb"},FRENCH:{icon:"flag-icon flag-icon-fr"},SPANISH:{icon:"flag-icon flag-icon-es"},GERMAN:{icon:"flag-icon flag-icon-de"},PORTUGUESE:{icon:"flag-icon flag-icon-pt"},RUSSIAN:{icon:"flag-icon flag-icon-ru"},MANDARIN:{icon:"flag-icon flag-icon-cn"},HINDI:{icon:"flag-icon flag-icon-in"},ARABIC:{icon:"flag-icon flag-icon-sa"},BENGALI:{icon:"flag-icon flag-icon-bd"},JAPANESE:{icon:"flag-icon flag-icon-jp"},PUNJABI:{icon:"flag-icon flag-icon-pk"},JAVANESE:{icon:"flag-icon flag-icon-id"},WU:{icon:"flag-icon flag-icon-cn"},MALAY_INDONESIAN:{icon:"flag-icon flag-icon-in"},TELUGU:{icon:"flag-icon flag-icon-in"},VIETNAMESE:{icon:"flag-icon flag-icon-vn"},MARATHI:{icon:"flag-icon flag-icon-in"},TAMIL:{icon:"flag-icon flag-icon-lk"},URDU:{icon:"flag-icon flag-icon-ae"},TURKISH:{icon:"flag-icon flag-icon-tr"},LANG_SIGN:{icon:"material-icons flaticon-hearing-impaired"},LANG_SIGN_IT:{icon:"material-icons flaticon-hearing-impaired"}}},contactIcons:function(){return{PHONE:{icon:"mdi mdi-phone",type:"contact.phone",prefix:"tel:",suffix:""},MOBILE:{icon:"mdi mdi-cellphone-android",type:"contact.mobile",prefix:"tel:",suffix:""},FAX:{icon:"mdi mdi-fax",type:"contact.fax",prefix:"tel:",suffix:""},EMAIL:{icon:"mdi mdi-email",type:"contact.email",prefix:"mailto:",suffix:""},WEBSITE:{icon:"mdi mdi-web",type:"contact.website",prefix:"",suffix:""},FACEBOOK:{icon:"mdi mdi-facebook-box",type:"contact.facebook",prefix:"https://facebook.com/",suffix:""},TWITTER:{icon:"mdi mdi-twitter-box",type:"contact.twitter",prefix:"https://twitter.com/",suffix:""},INSTAGRAM:{icon:"mdi mdi-instagram",type:"contact.instagram",prefix:"https://www.instagram.com/",suffix:""},WHATSAPP:{icon:"mdi mdi-whatsapp",type:"contact.whatsapp",prefix:bowser.ios?"whatsapp://send?":"intent://send/",suffix:bowser.ios?"":"#Intent;scheme=smsto;package=com.whatsapp;action=android.intent.action.SENDTO;end"},SKYPE:{icon:"mdi mdi-skype",type:"contact.skype",prefix:"skype://",suffix:"?call"},VIBER:{icon:"mdi mdi-phone",type:"contact.viber",prefix:"viber://forward?",suffix:""},TELEGRAM:{icon:"mdi mdi-telegram",type:"contact.telegram",prefix:"tg://",suffix:""}}},paymentIcons:function(){return{PAYPAL:"ch-pay-icon ch-pay-icon-paypal",VISA:"ch-pay-icon ch-pay-icon-visa",MASTERCARD:"ch-pay-icon ch-pay-icon-mastercard",AMEX:"ch-pay-icon ch-pay-icon-amex",DINERS_CLUB:"ch-pay-icon ch-pay-icon-diners",DISCOVER:"ch-pay-icon ch-pay-icon-discover",JCB:"ch-pay-icon ch-pay-icon-jcb",UNION_PAY:"ch-pay-icon ch-pay-icon-unionpay",MAESTRO:"ch-pay-icon ch-pay-icon-maestro"}},serviceIcons:function(){return{"service.type.technology.console":"mdi mdi-gamepad-variant","service.type.technology.games":"mdi mdi-gamepad-variant","service.type.technology.tv.flat":"mdi mdi-monitor","service.type.technology.tv":"mdi mdi-monitor","service.type.entertainment.children.tv":"mdi mdi-monitor","service.type.popular.pet.small":"mdi mdi-paw","service.type.popular.pet.medium":"mdi mdi-paw","service.type.popular.pet.large":"mdi mdi-paw","service.type.popular.pet.disabled":"mdi mdi-paw","service.type.popular.router":"mdi mdi-router-wireless","service.type.miscellaneous.air.conditioning":"mdi mdi-air-conditioner","service.type.room.air.conditioning":"mdi mdi-air-conditioner","service.type.miscellaneous.heating":"mdi mdi-air-conditioner","service.type.room.washing.machine":"mdi mdi-washing-machine","service.type.transport.parking.secured":"mdi mdi-parking","service.type.transport.parking.street":"mdi mdi-parking","service.type.transport.parking.accessible":"mdi mdi-parking","service.type.popular.bouquet":"mdi mdi-flower","service.type.popular.rose":"mdi mdi-flower","service.type.popular.breakfast.continental":"mdi mdi-food-fork-drink","service.type.popular.breakfast":"mdi mdi-food-fork-drink","service.type.popular.breakfast.room":"mdi mdi-food-fork-drink","service.type.miscellaneous.non­smoking.throughout":"mdi mdi-smoking-off","service.type.miscellaneous.non­smoking.rooms":"mdi mdi-smoking-off","service.type.popular.smoking.area":"mdi mdi-smoking","service.type.popular.smoking.room":"mdi mdi-smoking","service.type.popular.wifi.room":"mdi mdi-wifi","service.type.popular.wifi.all":"mdi mdi-wifi","service.type.popular.internet.point":"mdi mdi-wifi","service.type.food.champagne":"mdi mdi-glass-flute","service.type.food.prosecco":"mdi mdi-glass-flute","service.type.food.wine.red":"mdi mdi-glass-tulip","service.type.food.wine.white":"mdi mdi-glass-tulip","service.type.food.homemade.cake":"mdi mdi-cake","service.type.food.water":"mdi mdi-cup-water","service.room.type.welcomeCoffee":"mdi mdi-coffee","service.type.food.cookies":"mdi mdi-cookie"}},transferIcons:function(){return{CAR:"flaticon-car-black-side-view-pointing-left",LIMOUSINE:"flaticon-sedan-car-model",PULLMAN:"flaticon-bus-front",SHUTTLE:"flaticon-microbus",MINIVAN:"flaticon-van-black-transport-side-view-pointing-to-left",LUXURY_CAR:"flaticon-supercar"}},portalIcons:function(){return{PHONE:"channel-icon channel-chroma",EMAIL:"channel-icon channel-chroma",PORTAL:"channel-icon channel-chroma",WIDGET:"mdi mdi-monitor-dashboard material-icons",BOOKING:"channel-icon channel-booking",EXPEDIA:"channel-icon channel-expedia",VENERE:"channel-icon channel-venere",AIRBNB:"channel-icon channel-airbnb",AGODA:"channel-icon channel-agoda",AMADEUS:"channel-icon channel-amadeus",SABRE:"channel-icon channel-sabre",GALILEO:"channel-icon channel-galileo",WORLDSPAN:"channel-icon channel-worldspan",DHISCO:"channel-icon channel-dhisco",EDREAMS:"channel-icon channel-edreams",GOVOYAGES:"channel-icon channel-govoyages",OPODO:"channel-icon channel-opodo",TRAVELLINK:"channel-icon channel-travellink",LILIGO:"channel-icon channel-liligo",OTHER:"mdi mdi-web material-icons",Hotels_com:"channel-icon channel-expedia-group",Expedia_Affiliate_Network:"channel-icon channel-expedia-group",Egencia:"channel-icon channel-expedia-group",Travelocity:"channel-icon channel-expedia-group",Hotwire:"channel-icon channel-expedia-group",CheapTickets:"channel-icon channel-expedia-group",Ebookers:"channel-icon channel-expedia-group",MrJet:"channel-icon channel-expedia-group",Lastminute_au:"channel-icon channel-expedia-group",American_Express_Travel:"channel-icon channel-expedia-group",Amex_The_Hotel_Collection:"channel-icon channel-expedia-group",Amex_FINE_HOTELS_AND_RESORTS:"channel-icon channel-expedia-group",Thomas_Cook:"channel-icon channel-expedia-group",Neckermann:"channel-icon channel-expedia-group",Ving:"channel-icon channel-expedia-group",Tjareborg:"channel-icon channel-expedia-group",Spies:"channel-icon channel-expedia-group"}},reservationStatusIcons:function(){return{CONFIRMED:"mdi mdi-check md-18 text-success",TBC:"mdi mdi-av-timer md-18 text-info",CANCELLED:"mdi mdi-delete md-18 text-danger",NO_SHOW:"mdi mdi-eye-off md-18 text-black",CREDITCARD_NOT_VALID:"mdi mdi-credit-card-scan md-18 text-warn",CREDITCARD_PENDING:"mdi mdi-credit-card-scan md-18 text-warn",EARLY_CHECKOUT:"mdi mdi-logout-variant md-18 text-blue-sea",PAYMENT_PENDING:"mdi mdi-lock-clock md-18 text-warn"}},notificationIcons:function(){return{ALERT:"mdi mdi-information",PRE_AUTH:"mdi mdi-cash-usd",CHARGE:"mdi mdi-square-inc-cash",EXTERNAL_SERVICE:"mdi mdi-taxi",RATESHEET:"mdi mdi-cash-usd ",CHANNEL_MANAGER_SYNC:"mdi mdi-cloud-sync",CHANNEL_MANAGER_RESERVATION:"mdi mdi-cloud-download-outline",MESSAGE:"mdi mdi-message-text",REVIEW:"mdi mdi-thumbs-up-down",STATS:"mdi mdi-chart-bar",PWD_EXPIRATION:"mdi mdi-account-key",RATES:"mdi currency-usd",BILLING:"mdi mdi-cash-multiple"}}};return t})}(),function(){"use strict";function t(s,c,m,o,d){return function(t,e,n,a){var l=this;this.source=t,this.$$sourceType=angular.isArray(this.source)?1:angular.isObject(this.source)?2:-1,this.serviceFnName=n||"all",this.params=e,this.defaultSize=10,this.page=0,this.totalPages=0,this.items=[],this.totalItems=0,this.lastPage=!1,this.busy=!1,this.executed=!1,this.newItems=!1,this.postBody=a,this.nextPage=function(){var u=o.defer();return m(function(){if(l.source){if(l.busy||l.lastPage)return c.debug(l.busy?"Service busy":"Service reached last page"),void u.resolve();if(1==l.$$sourceType){l.busy=!0,angular.isObject(l.params)||(l.params={}),(angular.isUndefined(l.params.size)||Number.isNaN(l.params.size)||l.params.size<=0)&&(l.params.size=l.defaultSize),l.page<0&&(l.page=0);var n,a,t=l.source;l.params.sort&&(_.forEach(l.params.sort,function(t){var e=t.split(",");n||(n=[]),n.push(e[0]),e[1]&&(a||(a=[]),a.push(e[1]))}),t=_.orderBy(l.source,n,a)),t=l.params.filter&&!_.isEmpty(_.trim(l.params.filter))?s(t,{$:l.params.filter}):t,l.totalItems=t.length,l.totalPages=Math.ceil(l.totalItems/l.params.size);var e=l.params.size*l.page,o=e+l.params.size-1;o>t.length&&(o=t.length,l.lastPage=!0);var i=t.slice(e,o);i&&0<i.length?(l.params.filter&&(l.items=[]),angular.forEach(i,function(t,e){this.push(t)},l.items),l.newItems=!0,l.page++):l.newItems=!1,l.executed=!0,m(function(){l.busy=!1}),u.resolve()}else if(2==l.$$sourceType){if(l.serviceFnName&&!angular.isFunction(l.source[l.serviceFnName]))return c.error("Service has no '"+l.serviceFnName+"' function"),void u.reject("Service has no '"+l.serviceFnName+"' function");l.busy=!0,angular.isObject(l.params)||(l.params={}),(angular.isUndefined(l.params.size)||Number.isNaN(l.params.size)||l.params.size<=0)&&(l.params.size=l.defaultSize),l.page<0&&(l.page=0),l.params.page=l.page;var r=l.serviceFnName?l.serviceFnName:"all";l.source[r](l.params,l.postBody).then(function(t){var e=t.content;l.totalPages=t.totalPages,l.totalItems=t.totalElements,l.lastPage=t.last,e&&0<e.length?(l.params.filter&&(l.items=[]),angular.forEach(e,function(t,e){this.push(t)},l.items),l.newItems=!0,l.page++):l.newItems=!1,u.resolve()},function(t){c.error(t),d.error(t),u.reject(t)}).finally(function(){l.busy=!1,l.executed=!0},function(){l.busy=!1,l.executed=!0})}else c.error("Source must be an array or a Service Object"),u.reject("Source must be an array or a Service Object")}else c.error("Source is not defined"),u.reject("Source is not defined")},500).then(function(){return u.promise})},this.reload=function(){if(l)return l.reset(),l.nextPage()},this.reset=function(){l.busy=!1,l.executed=!1,l.lastPage=!1,l.page=0,l.totalPages=0,l.totalItems=0,l.items=[],l.newItems=!1},this.resetParams=function(){_.forEach(l.params,function(t,e,n){"size"!=e&&"page"!=e&&"sort"!=e&&(n[e]=void 0)})},this.resetAndReload=function(){l.resetParams(),l.reload()},this.getItemAtIndex=function(t){return l.items[t]?(console.log("Getting item "+t),l.items[t]):(l.nextPage(),null)},this.getLength=function(){return console.log("Length "+l.totalItems),l.totalItems}}}t.$inject=["filterFilter","$log","$timeout","$q","Notification"],angular.module("itaca.utils").factory("InfinitePaging",t)}(),function(){"use strict";function i(a,n,i,t,e){var r=this;this.$$reservationStorageName=t||"X-ITACA-RSV",this.$$quoteStorageName=e||"X-ITACA-QUOTE",this.setReservation=function(t){if(!t||3<t.step||t.id||!t.hotel||!t.hotel.id)return!1;var e=i.get(r.$$reservationStorageName);_.isPlainObject(e)||(e={});var n=t.hotel.id,a=t.guest?t.guest.id:null,o=_.isPlainObject(e[n])?e[n]:{};return t.step=2<t.step?2:t.step,_.unset(t,"payment"),_.unset(t,"paymentMethod"),_.unset(t,"paymentType"),_.unset(t,"bill"),_.unset(t,"billing"),_.unset(t,"guest"),o[a||"anonymous"]=t,e[n]=o,i.set(r.$$reservationStorageName,e),!0},this.getReservation=function(t,e){if(!t)return null;var n=i.get(r.$$reservationStorageName),a=n?n[t]:null;return a?a[e||"anonymous"]:null},this.removeReservation=function(t,e){if(!t)return!1;var n=i.get(r.$$reservationStorageName),a=n?n[t]:null;return!!a&&(a[e||"anonymous"]=void 0,n[t]=a,i.set(r.$$reservationStorageName,n),!0)},this.setQuote=function(t){var e=i.get(r.$$quoteStorageName);if(e=e&&angular.isObject(e)?e:{},a.user&&a.user.id){var n=e[a.user.id];return n=n&&angular.isObject(n)?n:{},_.unset(t,"payment"),_.unset(t,"guest"),n[a.hotelId]=t,e[a.user.id]=n,i.set(r.$$quoteStorageName,e),!0}return!1},this.getQuote=function(){var t=i.get(r.$$quoteStorageName);if(t&&t[a.user.id]){var e=t[a.user.id][a.hotelId];return n.convertDateStringsToDates(e),e}return{}},this.removeQuote=function(){var t=i.get(r.$$quoteStorageName);t&&t[a.user.id]&&(t[a.user.id][a.hotelId]=void 0)}}angular.module("itaca.services").provider("LocalStorage",function(){var a="X-ITACA-RSV",o="X-ITACA-QUOTE";this.setReservationStorageName=function(t){_.isEmpty(t)||(a=t)},this.setQuoteStorageName=function(t){_.isEmpty(t)||(o=t)},this.$get=["AppOptions","DateUtils","localStorageService",function(t,e,n){return new i(t,e,n,a,o)}]})}(),function(){"use strict";function o(t,n,a){var o=this;this.init=function(){o.all()},this.all=function(){var e=t.defer();return _.isPlainObject(a)?(o.locales=a,e.resolve(o.locales)):_.isString(a)&&n.get(a).then(function(t){o.locales=t.data.content,e.resolve(o.locales)},function(t){e.reject("Error loading phone prefixes")}),e.promise},this.get=function(e){return _.find(o.locales,function(t){return t[1]==e})},this.init()}angular.module("itaca.utils").provider("LocaleUtils",function(){var n,a="/resources/public/js/data/json/locales.json";this.setData=function(t){_.isPlainObject(t)?n=t:_.isString(t)&&(a=t)},this.$get=["$q","$http",function(t,e){return new o(t,e,n||a)}]})}(),function(){"use strict";angular.module("itaca.utils").factory("NumberUtils",function(){var o={fixedDecimals:function(t,e){if(!t||0===t)return 0;var n=Number(t).toFixed(e||2);return Number(n).valueOf()},vatAmount:function(t,e){return this.fixedDecimals(t-this.taxableAmount(t,e))},taxableAmount:function(t,e){return this.fixedDecimals(e?t/((100+e)/100):t)}};return o.calculateDiscount=function(t,e,n){return t&&e?(t=parseFloat(t),e=parseFloat(e),n=n||"PRICE",o.fixedDecimals("PERCENTAGE"==n?t/100*e:100*e/t)):0},o.applyDiscount=function(t,e,n){var a="PRICE"==(n=n||"PRICE")?parseFloat(e):o.calculateDiscount(t,e,n);return o.fixedDecimals(t-a)},o.uniqueNumber=function(){var t=Date.now();return t<=o.uniqueNumber.previous?t=++o.uniqueNumber.previous:o.uniqueNumber.previous=t,t},o.uniqueNumber.previous=0,o.isEven=function(t){return t%2==0},o.isOdd=function(t){return 1==Math.abs(t%2)},o.defaultNumber=function(t,e){var n=Number(t);return isNaN(n)?o.defaultNumber(e,0):n},o.lcmArray=function(t){if(!_.isArray(t)||_.isEmpty(t))return!1;for(var e=t[0],n=1;n<t.length;n++)e=o.lcm(e,t[n]);return e},o.lcm=function(t,e){return"number"==typeof t&&"number"==typeof e&&(t&&e?Math.abs(t*e/o.gcd(t,e)):0)},o.gcd=function(t,e){for(t=Math.abs(t),e=Math.abs(e);e;){var n=e;e=t%e,t=n}return t},o.formatter=function(t,e){var n,a=[{value:1,symbol:""},{value:1e3,symbol:"k"},{value:1e6,symbol:"M"},{value:1e9,symbol:"G"},{value:1e12,symbol:"T"},{value:1e15,symbol:"P"},{value:1e18,symbol:"E"}];for(n=a.length-1;0<n&&!(t>=a[n].value);n--);return(t/a[n].value).toFixed(e).replace(/\.0+$|(\.[0-9]*[1-9])0+$/,"$1")+a[n].symbol},o})}(),function(){"use strict";angular.module("itaca.utils").factory("ObjectUtils",function(){var t={clearObject:function(t,n){if(t){var e=_.mapValues(t,function(t,e){return n&&n.test(e)?t:_.isArray(t)?[]:void 0});_.assign(t,e)}}};return t})}(),function(){"use strict";function t(n,a){var t={request:function(t){if(!navigator.onLine){a.warn("No connection! The request will be aborted: "+t.url);var e=n.defer();t.timeout=e.promise,e.reject()}return t}};return t}t.$inject=["$q","$log"],angular.module("itaca.utils").factory("OfflineInterceptor",t)}(),function(){"use strict";function o(i,t,n){var r=this;this.init=function(){r.all()},this.all=function(){var e=i.defer();return _.isPlainObject(n)?(r.prefixes=n,e.resolve(r.prefixes)):_.isString(n)&&t.get(n).then(function(t){r.prefixes=t.data.content,e.resolve(r.prefixes)},function(t){e.reject("Error loading phone prefixes")}),e.promise},this.get=function(n,a){if(_.isNil(n))return null;_.isNil(a)&&(a="code");var o=i.defer();return r.all().then(function(t){var e=_.find(t,function(t){return t[a]==n});o.resolve(e)},function(t){o.reject(t)}),o.promise},this.compile=function(t,e){return(t||"")+(e||"")},this.decompile=function(t){if(!t)return null;var e=i.defer(),n=r.decompileSimple(t);return n.prefix?r.get(n.prefix,"dial_code").then(function(t){n.prefix=t,e.resolve(n)},function(t){e.resolve(n)}):e.resolve(n),e.promise},this.decompileSimple=function(e){if(!e)return null;var t={};if(_.isEmpty(r.prefixes))t.number=e;else{var n=_.find(r.prefixes,function(t){return e.startsWith(t.dial_code)});n&&n.dial_code?(t.prefix=_.trim(n.dial_code),t.number=_.trim(e.substring(e.indexOf(n.dial_code)+n.dial_code.length))):t.number=e}return t},this.init()}angular.module("itaca.utils").provider("PhoneUtils",function(){var n,a="/resources/public/js/data/json/phone-prefixes.json";this.setData=function(t){_.isPlainObject(t)?n=t:_.isString(t)&&(a=t)},this.$get=["$q","$http",function(t,e){return new o(t,e,n||a)}]})}(),function(){"use strict";function t(e){var t={notifyNewProfileImage:function(t){e.$broadcast("profile-image-updated",t)},notifyNewCoverImage:function(t){e.$broadcast("cover-image-updated",t)},notifyLoadProfileImage:function(t){e.$broadcast("load-image-profile",t)}};return t}t.$inject=["$rootScope"],angular.module("itaca.utils").factory("ProfileUtils",t)}(),function(){"use strict";angular.module("itaca.utils").factory("REGEXP",function(){return{username:/^[a-z0-9_.-@]{3,32}$/,password:/^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@$!%*?&_+-]*)(?=\S+$).{8,32}$/,strong_password:/^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@$!%*?&_+-])(?=\S+$).{8,32}$/,email:/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.(aero|arpa|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro|travel|mobi|[a-z][a-z])|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i,zip:/^[0-9]{5}$/,province:/^[a-zA-Z]{2}$/,phone:/^([+]{0,1}[0-9]{2,4}){1}[0-9]{3,11}$/,creditCard:/^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\d{3})\d{11})$/,price:/^[0-9]+(\.[0-9]{1,2})?$/,priceNoStrict:/^[-+]*[0-9]+(\.[0-9]{1,2})?$/,vat:/^((AT)?U[0-9]{8}|(BE)?0[0-9]{9}|(BG)?[0-9]{9,10}|(CY)?[0-9]{8}L|(CZ)?[0-9]{8,10}|(DE)?[0-9]{9}|(DK)?[0-9]{8}|(EE)?[0-9]{9}|(EL|GR)?[0-9]{9}|(ES)?[0-9A-Z][0-9]{7}[0-9A-Z]|(FI)?[0-9]{8}|(FR)?[0-9A-Z]{2}[0-9]{9}|(GB)?([0-9]{9}([0-9]{3})?|[A-Z]{2}[0-9]{3})|(HU)?[0-9]{8}|(IE)?[0-9]S[0-9]{5}L|(IT)?[0-9]{11}|(LT)?([0-9]{9}|[0-9]{12})|(LU)?[0-9]{8}|(LV)?[0-9]{11}|(MT)?[0-9]{8}|(NL)?[0-9]{9}B[0-9]{2}|(PL)?[0-9]{10}|(PT)?[0-9]{9}|(RO)?[0-9]{2,10}|(SE)?[0-9]{12}|(SI)?[0-9]{8}|(SK)?[0-9]{10})$/,fiscalCode:/^([A-Za-z]{6}[0-9lmnpqrstuvLMNPQRSTUV]{2}[abcdehlmprstABCDEHLMPRST]{1}[0-9lmnpqrstuvLMNPQRSTUV]{2}[A-Za-z]{1}[0-9lmnpqrstuvLMNPQRSTUV]{3}[A-Za-z]{1})|([0-9]{11})$/,dateString:/^(\d{4}|\+\d{6})(?:-(\d{2})(?:-(\d{2})(?:T(\d{2}):(\d{2}):(\d{2})\.(\d{1,})(Z|([\-+])((\d{2}):(\d{2})|(\d{4})))?)?)?)?$/}})}(),function(){"use strict";function t(t,a){var e={responseError:function(e){var n=t.defer();return e.data&&"java.net.SocketTimeoutException"===e.data.exception?a(["error.request.generic","common.try.again.or.contact.us"]).then(function(t){e.data.message=t["error.request.generic"]+". "+t["common.try.again.or.contact.us"],n.reject(e)}):n.reject(e),n.promise}};return e}t.$inject=["$q","$translate"],angular.module("itaca.utils").factory("RequestTimeoutInterceptor",t)}(),function(){"use strict";function t(e,E,d,n,b,a,o){var f={reservationSourceOptions:{PHONE:{defaultColor:"#ea80fc"},EMAIL:{defaultColor:"#d500f9"},PORTAL:{defaultColor:"#8e24aa"},BOOKING:{defaultColor:"#3f51b5"},EXPEDIA:{defaultColor:"#ffc107"},AIRBNB:{defaultColor:"#f44336"},AGODA:{defaultColor:"#009688"},AMADEUS:{defaultColor:"#00bcd4"},SABRE:{defaultColor:"#e91e63"},GALILEO:{defaultColor:"#795548"},WORLDSPAN:{defaultColor:"#18ffff"},DHISCO:{defaultColor:"#ffd180"},EDREAMS:{defaultColor:"#2196f3"},GOVOYAGES:{defaultColor:"#ff1744"},OPODO:{defaultColor:"#8bc34a"},TRAVELLINK:{defaultColor:"#00838f"},LILIGO:{defaultColor:"#cddc39"},OTHER:{defaultColor:"#c5cae9"}},clearReservation:function(t,e){e?n.clearObject(t,/^(check(?:in$|out$))|^people$|^requestPeople$|^hotelId$|^hotel$/):n.clearObject(t)},storeLastReservation:function(){return a.setReservation(o)},loadLastReservation:function(t,e){var n=a.getReservation(t,e);return n||(n=_.mapValues(o,function(t){if(_.isArray(t))return[]})),b.convertDateStringsToDates(n),n&&n.checkin&&n.checkout&&moment(n.checkin).isBefore(moment(),"days")&&(f.clearReservation(n),a.removeReservation(t,e)),n},removeLastReservation:function(t,e){return t||(t=o.hotel&&o.hotel.id?o.hotel.id:null),e||(e=o.guest&&o.guest.id?o.guest.id:null),a.removeReservation(t,e)},availableNights:function(t,e,n){if(!t||!e)return null;var a=moment(t),o=moment(e),i=_.isBoolean(n)&&!n?moment(t):n?moment(n):moment();return o.isAfter(i,"days")&&a.isBefore(i,"days")?b.diff(i,o):b.diff(a,o)},calculateGuestDocuments:function(t){t.identityDocuments=t.identityDocuments&&0<t.identityDocuments.length?t.identityDocuments:[],t.guestsCount=f.guestsCount(t.people,t.extraPeople);var e=parseInt(t.guestsCount.total);if(_.size(t.identityDocuments)>e)t.identityDocuments=_.dropRight(t.identityDocuments,_.size(t.identityDocuments)-e);else if(_.size(t.identityDocuments)<e)for(var n=e-_.size(t.identityDocuments),a=0;a<n;a++)t.identityDocuments.push({})},normalizePeople:function(t){return _.isPlainObject(t)||(t={}),t.adults=E.defaultNumber(t.adults),t.boys=E.defaultNumber(t.boys),t.children=E.defaultNumber(t.children),t.kids=E.defaultNumber(t.kids),t},peopleSummary:function(s,c){s||(s={}),c||(c={});var t=f.guestsCount(s,c);return!t&&t.total<=0?e("people.none").then(function(t){return t}):e(["people.adult","people.adults","people.child","people.children","people.boy","people.boys","people.kid","people.kids"]).then(function(t){var e="",n=0<s.adults||0<c.adults;if(n){var a=parseInt(s.adults||0)+parseInt(c.adults||0);0<a&&(e+=a+" "+(a<2?t["people.adult"]:t["people.adults"]))}var o=0<s.boys||0<c.boys;if(o){var i=parseInt(s.boys||0)+parseInt(c.boys||0);0<i&&(e+=n?", ":"",e+=i+" "+(i<2?t["people.boy"]:t["people.boys"]))}var r=0<s.children||0<c.children;if(r){var u=parseInt(s.children||0)+parseInt(c.children||0);0<u&&(e+=n||o?", ":"",e+=u+" "+(u<2?t["people.child"]:t["people.children"]))}if(0<s.kids||0<c.kids){var l=parseInt(s.kids||0)+parseInt(c.kids||0);0<l&&(e+=n||o||r?", ":"",e+=l+" "+(l<2?t["people.kid"]:t["people.kids"]))}return e.toLowerCase()})},peopleByBeds:function(t){var n={adults:0,boys:0,children:0,kids:0};return _.forEach(t,function(t){if(t.people){var e=t.people;e.adults&&(n.adults=n.adults?parseInt(n.adults)+parseInt(e.adults):parseInt(e.adults)),e.boys&&(n.boys=n.boys?parseInt(n.boys)+parseInt(e.boys):parseInt(e.boys)),e.children&&(n.children=n.children?parseInt(n.children)+parseInt(e.children):parseInt(e.children)),e.kids&&(n.kids=n.kids?parseInt(n.kids)+parseInt(e.kids):parseInt(e.kids))}}),n},guestsCount:function(t,e){t=f.normalizePeople(t),e=f.normalizePeople(e);var n=0,a=!1,o=!1;!_.isNil(t.adults)&&0<t.adults&&(a=!0,n+=parseInt(t.adults)),!_.isNil(t.boys)&&0<t.boys&&(o=!0,n+=parseInt(t.boys)),!_.isNil(t.children)&&0<t.children&&(o=!0,n+=parseInt(t.children)),!_.isNil(t.kids)&&0<t.kids&&(o=!0,n+=parseInt(t.kids));var i=0,r=!1,u=!1;return!_.isNil(e.adults)&&0<e.adults&&(r=!0,i+=parseInt(e.adults)),!_.isNil(e.boys)&&0<e.boys&&(u=!0,i+=parseInt(e.boys)),!_.isNil(e.children)&&0<e.children&&(u=!0,i+=parseInt(e.children)),!_.isNil(e.kids)&&0<e.kids&&(u=!0,i+=parseInt(e.kids)),{standard:n,hasAdults:a,hasChildren:o,extra:i,extraHasAdults:r,extraHasChildren:u,total:n+i}},guestsCountByRooms:function(t,e){return!(!t||!_.isArray(t))&&f.guestsCount(f.peopleByRooms(t,e),f.extraPeopleByRooms(t,e))},guestsCountByBeds:function(t,e,n){var a=0,o=0,i=!1,r=!1;if(t&&angular.isArray(t)&&_.forEach(t,function(t){a+=t.maxPerson*t.count}),e&&e.length){n=n||0;for(var u=angular.copy(e),l=parseInt(n);l;){var s=_.maxBy(u,"maxPerson");if(!s)break;_.pull(u,s);var c=0<=l-s.count?s.count:l;o+=s.maxPerson*c,l-=c,i||(i=null!=s.people&&s.people.adults),r||(r=s.people&&(s.people.boys||s.people.children||s.people.kids))}}return{standard:a,extra:o,extraHasAdults:i,extraHasChildren:r,partial:a+o}},totalPeople:function(t,e){return t=f.normalizePeople(t),e=f.normalizePeople(e),{adults:t.adults+e.adults,boys:t.boys+e.boys,children:t.children+e.children,kids:t.kids+e.kids}},totalPeopleByRooms:function(t,e){return f.totalPeople(f.peopleByRooms(t,e),f.extraPeopleByRooms(t,e))},peopleByRooms:function(t,o){var i={adults:0,boys:0,children:0,kids:0};return _.forEach(t,function(t,e,n){var a=angular.copy(t.people||{});o&&!_.isEmpty(t.beds)&&(a.adults=0,a.boys=0,a.children=0,a.kids=0,_.forEach(t.beds,function(t){a.adults=parseInt(t.people.adults)?a.adults+parseInt(t.people.adults):a.adults,a.boys=parseInt(t.people.boys)?a.boys+parseInt(t.people.boys):a.boys,a.children=parseInt(t.people.children)?a.children+parseInt(t.people.children):a.children,a.kids=parseInt(t.people.kids)?a.kids+parseInt(t.people.kids):a.kids})),i.adults=parseInt(a.adults)?i.adults+parseInt(a.adults):i.adults,i.boys=parseInt(a.boys)?i.boys+parseInt(a.boys):i.boys,i.children=parseInt(a.children)?i.children+parseInt(a.children):i.children,i.kids=parseInt(a.kids)?i.kids+parseInt(a.kids):i.kids}),i},extraPeopleByRooms:function(t,o){var i={adults:0,boys:0,children:0,kids:0};return _.forEach(t,function(t,e,n){var a=angular.copy(t.extraPeople||{});o&&!_.isEmpty(t.otherBeds)&&(a.adults=0,a.boys=0,a.children=0,a.kids=0,_.forEach(t.otherBeds,function(t){a.adults=parseInt(t.people.adults)?a.adults+parseInt(t.people.adults):a.adults,a.boys=parseInt(t.people.boys)?a.boys+parseInt(t.people.boys):a.boys,a.children=parseInt(t.people.children)?a.children+parseInt(t.people.children):a.children,a.kids=parseInt(t.people.kids)?a.kids+parseInt(t.people.kids):a.kids})),a&&(i.adults=parseInt(a.adults)?i.adults+parseInt(a.adults):i.adults,i.boys=parseInt(a.boys)?i.boys+parseInt(a.boys):i.boys,i.children=parseInt(a.children)?i.children+parseInt(a.children):i.children,i.kids=parseInt(a.kids)?i.kids+parseInt(a.kids):i.kids)}),i},peopleByMax:function(t,e,n){if(!t&&!e)return{};if(!t)return 0<n?f.peopleByMax(e,{adults:n},n):angular.copy(e);if(!e)return 0<n?f.peopleByMax(t,{adults:n},n):angular.copy(t);var a=n;a||(a=-1);var o=_.isNil(t.adults)?0:_.isNil(e.adults)?t.adults:t.adults<=e.adults?t.adults:e.adults;0<=a&&(a-=o=o<=a?o:a);var i=_.isNil(t.boys)?0:_.isNil(e.boys)?t.boys:t.boys<=e.boys?t.boys:e.boys;0<=a&&(a-=i=i<=a?i:a);var r=_.isNil(t.children)?0:_.isNil(e.children)?t.children:t.children<=e.children?t.children:e.children;0<=a&&(a-=r=r<=a?r:a);var u=_.isNil(t.kids)?0:_.isNil(e.kids)?t.kids:t.kids<=e.kids?t.kids:e.kids;return 0<=a&&(a-=u=u<=a?u:a),{adults:o,boys:i,children:r,kids:u}},peopleAvailability:function(t,e,n){t=f.normalizePeople(t),f.guestsCount(t).standard<=0&&(t=angular.copy(e)),e=f.normalizePeople(e);for(var a=f.guestsCount(e).standard,o=n?parseInt(n)-a:a,i={adults:0,boys:0,children:0,kids:0},r=1;r<=parseInt(t.adults||0);r++){e.adults=e.adults||0,!(r<=e.adults)&&o+e.adults-r<0||(i.adults=r)}for(r=1;r<=parseInt(t.boys||0);r++){e.boys=e.boys||0,!(r<=e.boys)&&o+e.boys-r<0||(i.boys=r)}for(r=1;r<=parseInt(t.children||0);r++){e.children=e.children||0,!(r<=e.children)&&o+e.children-r<0||(i.children=r)}for(r=1;r<=parseInt(t.kids||0);r++){e.kids=e.kids||0,!(r<=e.kids)&&o+e.kids-r<0||(i.kids=r)}return i},bedsAvailability:function(t,o,i,r){var u=[];return _.forEach(o,function(t){var e=angular.copy(t);e.uid=e.uid||E.uniqueNumber(),e.$$available=!1,e.$$blocked=!1,e.$$editing=!1,u.push(e)}),t&&!_.isEmpty(t)&&_.forEach(t,function(e){var t=0;do{var n=_.filter(u,function(t){return(t.bed||t).type==e.type});if(t=_.size(n),r&&t<=0||t>=e.count)return;var a=angular.copy(e);a.uid=E.uniqueNumber(),a.$$available=!0,a.$$blocked=_.size(o)>=i,u.push(a)}while(t<e.count)}),u},$generateRoomIncludedServices:function(t,e,n,a){var o=[];return _.forEach(_.filter(t.services,["bookability","INCLUDED"]),function(t){o.push(f.serviceSold(t,e,n,1))}),_.unionBy(a||[],o,"service.id")},$generateRoomIncludedBeds:function(t,e,i,r,n){var u=n||[],l=f.normalizePeople(angular.copy(e)),s=f.guestsCount(l);return _.forEach(t.beds,function(e){var t=0;do{var n=_.filter(u,function(t){return t.bed.type==e.type});if((t=_.size(n))>=e.count)return;var a=angular.copy(e);a.uid=E.uniqueNumber();var o=f.peopleByMax(l,a.people,a.maxPerson);u.push(f.bedSold(a,o,i,r)),0,l.adults=l.adults-(o.adults||0),l.boys=l.boys-(o.boys||0),l.children=l.children-(o.children||0),l.kids=l.kids-(o.kids||0),s=f.guestsCount(l)}while(0<s.standard&&t<e.count)}),u},roomSold:function(t,e,n,a,o,i,r,u,l){if(!e||!t||!n)return{};var s=b.diff(e.startDate,e.endDate),c=f.guestsCount(a,o);c.standard||(a={adults:1,boys:0,children:0,kids:0},c=f.guestsCount(a,o)),c.extra||(o=f.peopleByBeds(r),c=f.guestsCount(a,o));var m={type:t,totalRate:e,status:l||"CONFIRMED",people:a,extraPeople:o,guestsCount:c,services:f.$generateRoomIncludedServices(t,a,s,u),beds:f.$generateRoomIncludedBeds(t,a,s,n,i),otherBeds:r||[],creationDate:new Date};return d.calculateVat(m.totalRate.amount,n),m},serviceSold:function(n,a,o,t){if(!n)return{};n.maxCount||(n.maxCount=1),t||(t=1),t>n.maxCount&&-1!=n.maxCount&&(t=n.maxCount),a||(a={adults:0,boys:0,kids:0,children:0});var i=moment.duration(o,"days"),r={type:"PRICE",currency:"EUR",initialAmount:0,finalAmount:0,vatRate:0,vatAmount:0};switch(n.paymentType){case"SINGLE":var e=n.paymentOptions[0];switch(n.frequency){case"LUMP_SUM":r.finalAmount=e.amount.finalAmount;break;case"DAILY":r.finalAmount=e.amount.finalAmount*o;break;case"MONTHLY":r.finalAmount=e.amount.finalAmount*Math.ceil(i.asMonths());break;case"YEARLY":r.finalAmount=e.amount.finalAmount*Math.ceil(i.asYears())}r.vatRate=e.amount.vatRate;break;case"PER_PERSON":_.forEach(n.paymentOptions,function(t){var e=0;switch(t.size){case"PER_ADULT":a.adults&&(e=t.amount.finalAmount*a.adults,r.vatRate=r.vatRate&&r.vatRate>t.amount.vatRate?r.vatRate:t.amount.vatRate);break;case"PER_BOY":a.boys&&(e=t.amount.finalAmount*a.boys,r.vatRate=r.vatRate&&r.vatRate>t.amount.vatRate?r.vatRate:t.amount.vatRate);break;case"PER_CHILD":a.children&&(e=t.amount.finalAmount*a.children,r.vatRate=r.vatRate&&r.vatRate>t.amount.vatRate?r.vatRate:t.amount.vatRate);break;case"PER_KID":a.kids&&(e=t.amount.finalAmount*a.kids,r.vatRate=r.vatRate&&r.vatRate>t.amount.vatRate?r.vatRate:t.amount.vatRate)}switch(n.frequency){case"DAILY":case"NIGHTLY":e*=o;break;case"MONTHLY":e*=Math.ceil(i.asMonths());break;case"YEARLY":e*=Math.ceil(i.asYears())}r.finalAmount+=e})}return r.finalAmount=r.finalAmount*t,r.initialAmount=r.finalAmount,r.vatAmount=E.vatAmount(r.finalAmount,r.vatRate),{service:n,amount:r,people:a,included:"INCLUDED"==n.bookability,status:"CONFIRMED",count:t}},updateServiceSoldPrice:function(t,e,n,a,o){var i=n;t.startDate&&t.endDate&&(i=b.diff(t.startDate,t.endDate));var r=o?angular.copy(t):null;_.assign(t,f.serviceSold(t.service,e||t.people,i,a||t.count)),t.amount=r?r.amount:t.amount,t.amount.vatAmount=E.vatAmount(t.amount.finalAmount,t.amount.vatRate)},bedSold:function(t,e,n,a){if(!t)return{};var o={type:"PRICE",currency:"EUR",initialAmount:0,finalAmount:0,vatRate:a,vatAmount:0};return(e=f.normalizePeople(e)).adults&&0<e.adults&&(o.finalAmount+=e.adults*t.adultsPrice),e.boys&&0<e.boys&&(o.finalAmount+=e.boys*t.boysPrice),e.children&&0<e.children&&(o.finalAmount+=e.children*t.childrenPrice),e.kids&&0<e.kids&&(o.finalAmount+=e.kids*t.kidsPrice),"DAILY"!=t.frequency&&"NIGHTLY"!=t.frequency||(o.finalAmount*=n),o.initialAmount=o.finalAmount,o.vatAmount=E.vatAmount(o.finalAmount,o.vatRate),{bed:t,people:e,amount:o,status:"CONFIRMED"}},updateBedSoldPrice:function(t,e,n,a,o){var i=n;t.startDate&&t.endDate&&(i=b.diff(t.startDate,t.endDate));var r=o?angular.copy(t):null;_.assign(t,f.bedSold(t.bed,e||t.people,i,a||t.amount.vatRate)),t.amount=r?r.amount:t.amount,t.amount.vatAmount=E.vatAmount(t.amount.finalAmount,t.amount.vatRate)},updatePolicyAmount:function(t,e,n){if(t&&e&&n){var a=e.cancellation.chargeNights,o=e.cancellation.percentage||0;o=o<=100?o:100;var i={finalAmount:0};if(a<0||a==n)i.finalAmount=E.fixedDecimals(t.totalRate.amount.finalAmount);else for(var r=0;r<a;r++){var u=t.totalRate.dailyRates[r];u&&(i.finalAmount+=E.fixedDecimals(u.amount.finalAmount))}i.finalAmount=i.finalAmount*(o/100),e.amount=i}},calculateTotalPrice:function(n){if(n){var t=b.diff(n.checkin,n.checkout),o=0,i=0,a=0,r=0,u=0,l=0,s=[],c=n.hotel&&n.hotel.vatTax&&n.hotel.vatTax.finalAmount?n.hotel.vatTax.finalAmount:10,m={},d=0,f=0,p=0,A=0;_.forEach(n.rooms,function(t,e,n){t.totalRate.amount.vatRate=c,t.totalRate.amount.vatAmount=E.vatAmount(t.totalRate.amount.finalAmount,t.totalRate.amount.vatRate),"CONFIRMED"==t.status||"EARLY_CHECKOUT"==t.status?(o+=t.totalRate.amount.initialAmount,i+=t.totalRate.amount.finalAmount,u+=t.totalRate.amount.vatAmount,_.forEach(t.totalRate.dailyRates,function(e){if(!_.isNil(e.promotion)){var t=0;e.promotion.discount&&e.promotion.discount.finalAmount&&(t=e.amount.finalAmount,t="PRICE"==e.promotion.discount.type?e.amount.initialAmount-e.promotion.discount.finalAmount:e.amount.initialAmount-e.amount.initialAmount*((100-e.promotion.discount.finalAmount)/100));var n=_.find(s,function(t){return e.promotion.id&&t.promo.id==e.promotion.id});n?n.price+=t:s.push({promo:e.promotion,percentage:e.promotion.discount&&"PRICE"!=e.promotion.discount.type&&e.promotion.discount.finalAmount?e.promotion.discount.finalAmount+"%":null,price:t}),l+=t}}),d+=t.totalRate.amount.initialAmount,A+=t.totalRate.amount.initialAmount,t.totalRate.amount.vatRate?m[t.totalRate.amount.vatRate]=m[t.totalRate.amount.vatRate]?m[t.totalRate.amount.vatRate]+t.totalRate.amount.vatAmount:t.totalRate.amount.vatAmount:m[c]=m[c]?m[c]+t.totalRate.amount.vatAmount:t.totalRate.amount.vatAmount,_.forEach(t.services,function(n){o+=n.amount.finalAmount,i+=n.amount.finalAmount,u+=n.amount.vatAmount,n.amount.initialAmount=n.amount.initialAmount||angular.copy(n.amount.finalAmount),f+=n.amount.initialAmount,A+=n.amount.initialAmount;var a=!1;_.forEach(m,function(t,e){e&&e==n.amount.vatRate&&(m[e]+=n.amount.vatAmount,a=!0)}),a||n.amount.vatRate&&(m[n.amount.vatRate]=m[n.amount.vatRate]?m[n.amount.vatRate]+n.amount.vatAmount:n.amount.vatAmount)}),_.forEach(t.otherBeds,function(t){t.amount&&(o+=t.amount.finalAmount,i+=t.amount.finalAmount,u+=t.amount.vatAmount,t.amount.initialAmount=t.amount.initialAmount||angular.copy(t.amount.finalAmount),p+=t.amount.initialAmount,A+=t.amount.initialAmount,t.amount.vatRate?m[t.amount.vatRate]=m[t.amount.vatRate]?m[t.amount.vatRate]+t.amount.vatAmount:t.amount.vatAmount:m[c]=m[c]?m[c]+t.amount.vatAmount:t.amount.vatAmount)})):(a+=t.cancelAmount.initialAmount,r+=t.cancelAmount.finalAmount)}),n.cancelAmount||(n.cancelAmount={currency:"EUR",type:"PRICE"});var e=["CANCELLED","NO_SHOW"];n.cancelAmount.initialAmount=_.includes(e,n.status)?n.cancelAmount.initialAmount:E.fixedDecimals(a),n.cancelAmount.finalAmount=_.includes(e,n.status)?n.cancelAmount.finalAmount:E.fixedDecimals(r),n.totalAmount||(n.totalAmount={currency:"EUR",type:"PRICE"}),n.totalAmount.initialAmount=_.includes(e,n.status)?n.totalAmount.initialAmount:o,n.totalAmount.finalAmount=_.includes(e,n.status)?n.totalAmount.finalAmount:i,n.discount||(n.discount={finalAmount:0,type:"PERCENTAGE"});var v=E.calculateDiscount(n.totalAmount.finalAmount,n.discount.finalAmount,"PERCENTAGE");n.totalAmount.discountRate=n.discount.finalAmount,n.totalAmount.discountAmount=v,n.totalAmount.finalAmount=n.totalAmount.finalAmount-v,n.grandAmount={initialAmount:n.totalAmount.initialAmount,finalAmount:n.totalAmount.finalAmount},n.grandAmount.initialAmount+=n.cancelAmount&&n.cancelAmount.initialAmount?n.cancelAmount.initialAmount:0,n.grandAmount.finalAmount+=n.cancelAmount&&n.cancelAmount.finalAmount?n.cancelAmount.finalAmount:0;var h=A-l-n.totalAmount.finalAmount-v;if(n.totalPriceDetails={rooms:E.fixedDecimals(d),services:E.fixedDecimals(f),otherBeds:E.fixedDecimals(p),subTotal:E.fixedDecimals(A),discountPromo:E.fixedDecimals(l),discountHotel:E.fixedDecimals(h)},n.arrayPromo=s,n.totalVat={total:u,vatMap:m},n.totalAmount.discountRate){var y={};u=0,_.forEach(m,function(t,e){y[e]=t-parseFloat(t)/100*parseFloat(n.totalAmount.discountRate),u+=y[e]}),n.totalVat={total:u,vatMap:y}}if((n.id&&null!=n.depositAmount||!n.id)&&n.hotel&&n.hotel.deposit&&0<n.hotel.deposit.finalAmount){var g=100<n.hotel.deposit.finalAmount?100:n.hotel.deposit.finalAmount;n.depositAmount=n.depositAmount||{finalAmount:0},n.depositAmount.finalAmount=E.fixedDecimals(n.totalAmount.finalAmount*(g/100),2)}if((n.id&&null!=n.cityTaxAmount||!n.id)&&n.hotel&&n.hotel.cityTax&&0<n.hotel.cityTax.finalAmount&&t&&n.guestsCount&&n.guestsCount.total){var R=0<n.hotel.cityTaxLimit&&t>n.hotel.cityTaxLimit?n.hotel.cityTaxLimit:t;n.cityTaxAmount=n.cityTaxAmount||{},n.cityTaxAmount.finalAmount=n.hotel.cityTax.finalAmount*(n.guestsCount.total*(0<R?R:1))}}},calculateVatMap:function(n,t){if(n){var o=0,a=n.hotel&&n.hotel.vatTax&&n.hotel.vatTax.finalAmount?n.hotel.vatTax.finalAmount:10,i={};if(_.forEach(n.rooms,function(t,e,n){"EARLY_CHECKOUT"==t.status?(o+=t.cancelAmount.vatAmount,t.totalRate.cancelAmount.vatRate?i[t.totalRate.cancelAmount.vatRate]=i[t.totalRate.cancelAmount.vatRate]?i[t.totalRate.cancelAmount.vatRate]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount:i[a]=i[a]?i[a]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount,_.forEach(t.services,function(n){o+=n.cancelAmount.vatAmount;var a=!1;_.forEach(i,function(t,e){e&&e==n.cancelAmount.vatRate&&(i[e]+=n.cancelAmount.vatAmount,a=!0)}),a||n.cancelAmount.vatRate&&(i[n.cancelAmount.vatRate]=i[n.cancelAmount.vatRate]?i[n.cancelAmount.vatRate]+n.cancelAmount.vatAmount:n.cancelAmount.vatAmount)}),_.forEach(t.otherBeds,function(t){t.cancelAmount&&(o+=t.cancelAmount.vatAmount,t.cancelAmount.vatRate?i[t.cancelAmount.vatRate]=i[t.cancelAmount.vatRate]?i[t.cancelAmount.vatRate]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount:i[a]=i[a]?i[a]+t.cancelAmount.vatAmount:t.cancelAmount.vatAmount)})):"CONFIRMED"==t.status&&(o+=t.totalRate.amount.vatAmount,t.totalRate.amount.vatRate?i[t.totalRate.amount.vatRate]=i[t.totalRate.amount.vatRate]?i[t.totalRate.amount.vatRate]+t.totalRate.amount.vatAmount:t.totalRate.amount.vatAmount:i[a]=i[a]?i[a]+t.totalRate.amount.vatAmount:t.totalRate.amount.vatAmount,_.forEach(t.services,function(n){o+=n.amount.vatAmount;var a=!1;_.forEach(i,function(t,e){e&&e==n.amount.vatRate&&(i[e]+=n.amount.vatAmount,a=!0)}),a||n.amount.vatRate&&(i[n.amount.vatRate]=i[n.amount.vatRate]?i[n.amount.vatRate]+n.amount.vatAmount:n.amount.vatAmount)}),_.forEach(t.otherBeds,function(t){t.amount&&(o+=t.amount.vatAmount,t.amount.vatRate?i[t.amount.vatRate]=i[t.amount.vatRate]?i[t.amount.vatRate]+t.amount.vatAmount:t.amount.vatAmount:i[a]=i[a]?i[a]+t.amount.vatAmount:t.amount.vatAmount)}))}),0<=t){var r={};o=0,_.forEach(i,function(t,e){r[e]=t-parseFloat(t)/100*parseFloat(n.totalAmount.discountRate),o+=r[e]}),n.totalVat={total:o,vatMap:r}}}},applyDiscount:function(t,e,n){if(t&&e){n=n||"PRICE";var a,o,i=t.totalAmount.finalAmount;o="PERCENTAGE"==n?(a=E.calculateDiscount(i,e,n),e):(a=e,E.calculateDiscount(i,e,n)),t.totalAmount.discountRate=o,t.totalAmount.discountAmount=a,t.totalAmount.finalAmount=i-a}},calculateTotalTransfers:function(t){if(t){(_.isNil(t.externalServices)||_.isNil(t.externalServices.transfersServices))&&(t.externalServices={transfersServices:[]});var a=0,o=0;_.forEach(t.externalServices.transfersServices,function(t,e,n){"CONFIRMED"==t.status&&(a+=t.amount.finalAmount,o+=t.amount.vatAmount,t.surcharge&&(a+=t.transferService.nightCharge.finalAmount))}),t.totalTransfers={totalAmount:a,vatAmount:o,taxableAmount:a-o}}},calculateTotalRooms:function(t){if(t&&!_.isNil(t.rooms)){var o=0,i=0,r=0,u=0,l=0,s=[],c=0,m=t.rooms.length;return _.forEach(t.rooms,function(t,e,n){if("CONFIRMED"==t.status||"EARLY_CHECKOUT"==t.status){if(t.extendedRoom?(c+=1,m-=1):o+=1,!_.isEmpty(t.dailyDetails)&&_.some(t.dailyDetails,"room")){var a=_.uniqBy(t.dailyDetails,"room.name");s.push(1<_.size(a)?a[0].room.name+"+":a[0].room.name)}"STANDARD"==t.totalRate.type?t.totalRate.cancellationPolicy&&t.totalRate.cancellationPolicy.flexible?u++:r++:"NOT_REFUNDABLE"==t.totalRate.type&&l++}else i+=1}),{active:o,cancelled:i,total:m,standard:r,flexible:u,notRefundable:l,physicalRooms:s,extendedRooms:c}}},calculateRoomTotalPrice:function(t){if(t){var e={initialAmount:t.totalRate.amount.initialAmount,finalAmount:t.totalRate.amount.finalAmount,servicesAmount:0,bedsAmount:0};_.forEach(t.services,function(t){e.initialAmount+=_.isNil(t.amount.initialAmount)?t.amount.finalAmount:t.amount.initialAmount,e.finalAmount+=t.amount.finalAmount,e.servicesAmount+=t.amount.finalAmount}),_.forEach(t.otherBeds,function(t){e.initialAmount+=_.isNil(t.amount.initialAmount)?t.amount.finalAmount:t.amount.initialAmount,e.finalAmount+=t.amount.finalAmount,e.bedsAmount+=t.amount.finalAmount}),t.totalPrice=e}},createCancelledReservation:function(t,e){var n=this;e=e||(t.hotel.vatTax?t.hotel.vatTax.finalAmount:0);var a=angular.copy(t);a.cancelAmount?_.assign(a.cancelAmount,{initialAmount:0,finalAmount:0}):a.cancelAmount={initialAmount:0,finalAmount:0};var o,i=moment();return _.forEach(a.rooms,function(t){if("CONFIRMED"==t.status){if(t.endDate&&moment(t.endDate).isBefore(i,"days"))return;t.cancelled=!1,_.assign(t,n.createCancelledRoom(t,a,i,e)),a.cancelAmount.initialAmount+=E.fixedDecimals(t.cancelAmount.finalAmount),a.cancelAmount.finalAmount+=E.fixedDecimals(t.cancelAmount.finalAmount)}else t.cancelled=!0}),o=a.cancelAmount.finalAmount<=0?"reservation.manager.cancel.free":"reservation.manager.cancel.penalty",a.statusText=o,a.cancelDate=i.toDate(),a.status="CANCELLED",a.sendEmail=!0,a},createCancelledRoom:function(t,e,n,a){var o=n?moment(n):moment();if(t.endDate&&moment(t.endDate).isBefore(o,"days"))return t;b.diff(t.startDate||e.checkin,o);var i=angular.copy(t);return i.cancelled=!1,i.cancelAmount=i.cancelAmount?i.cancelAmount:{},i.totalRate.cancellationPolicy?(i.tempStatus="penalty",i.cancelAmount.finalAmount=i.totalRate.cancellationPolicy.amount.finalAmount,i.totalRate.cancellationPolicy.limitDate&&moment(i.totalRate.cancellationPolicy.limitDate).utcOffset((e.hotel.addressInfo.offset||0)/60).isSameOrAfter(o)&&(i.cancelAmount.finalAmount=0,i.tempStatus="free")):(i.cancelAmount.finalAmount=0,i.tempStatus="free"),i.cancelAmount.initialAmount=E.fixedDecimals(i.cancelAmount.finalAmount),i.cancelAmount.finalAmount=E.fixedDecimals(i.cancelAmount.finalAmount),i.cancelled=!1,i.cancelAmount.vatRate=i.totalRate.amount.vatRate?i.totalRate.amount.vatRate:a,i.cancelAmount.vatAmount=E.vatAmount(i.cancelAmount.finalAmount,i.cancelAmount.vatRate),i.cancelDate=o.toDate(),i.status="CANCELLED",_.forEach(i.services,function(t){t.status="CANCELLED"}),_.forEach(i.otherBeds,function(t){t.status="CANCELLED"}),i},createNoShowReservation:function(t,e){e=e||(t.hotel.vatTax?t.hotel.vatTax.finalAmount:0);var n=angular.copy(t),a=new Date,o=(moment(a),0);return _.forEach(n.rooms,function(t){t.cancelAmount=t.cancelAmount?t.cancelAmount:{},t.totalRate.noShowPolicy?(t.tempStatus="penalty",t.cancelAmount.finalAmount=t.totalRate.noShowPolicy.amount.finalAmount):(t.cancelAmount.finalAmount=0,t.tempStatus="free"),t.cancelAmount.finalAmount=E.fixedDecimals(t.cancelAmount.finalAmount),"CONFIRMED"==t.status?(o+=t.cancelAmount.finalAmount,t.cancelled=!1,t.cancelAmount.vatRate=t.totalRate.amount.vatRate?t.totalRate.amount.vatRate:e,t.cancelAmount.vatAmount=E.vatAmount(t.cancelAmount.finalAmount,t.cancelAmount.vatRate),t.cancelDate=a,t.status="NO_SHOW",_.forEach(t.services,function(t){t.status="NO_SHOW"}),_.forEach(t.otherBeds,function(t){t.status="NO_SHOW"})):t.cancelled=!0}),n.cancelAmount={initialAmount:E.fixedDecimals(o),finalAmount:E.fixedDecimals(o),total:E.fixedDecimals(0)},n.cancelDate=a,n.status="NO_SHOW",n.sendEmail=!0,n},createEarlyCheckoutReservation:function(t,e){var n=this;e=e||(t.hotel.vatTax?t.hotel.vatTax.finalAmount:0);var a,o,i,r,u,l,s=angular.copy(t),c=new Date,m=moment(c);return s.initialAmount=angular.copy(s.totalAmount),_.assign(s.totalAmount,{initialAmount:0,finalAmount:0}),0<b.diff(s.checkin,m)?(_.forEach(s.rooms,function(t){if("CONFIRMED"==t.status){if(t.endDate&&moment(t.endDate).isBefore(m,"days"))return void(t.status="EARLY_CHECKOUT");t.cancelled=!1,_.assign(t,n.createEarlyCheckoutRoom(t,s,m,e)),t.checkoutDone=c,s.totalAmount.initialAmount+=t.totalRoomAmount.initialAmount,s.totalAmount.finalAmount+=t.totalRoomAmount.finalAmount}else t.cancelled=!0}),o="reservation.earlycheckout.title",i="reservation.earlycheckout.reason.label",r="reservation.earlycheckout.penalty",a="reservation.manager.earlyCheckout",u="reservation.earlycheckout.free.label",l="reservation.earlycheckout.penalty.label",s.checkoutDone=c,s.status="EARLY_CHECKOUT",s.totalAmount.initialAmount=E.fixedDecimals(s.totalAmount.initialAmount),s.totalAmount.finalAmount=E.fixedDecimals(s.totalAmount.finalAmount),s.totalAmount.vatRate=s.totalAmount.vatRate||e,s.totalAmount.vatAmount=E.vatAmount(s.totalAmount.finalAmount,s.totalAmount.vatRate)):(o="reservation.deleteCheckin.title",i="reservation.deleteCheckin.reason.label",r="reservation.deleteCheckin.penalty",a=0<(s=n.createCancelledReservation(t,e)).cancelAmount.finalAmount?"reservation.manager.deleteCheckin":"reservation.manager.deleteCheckin.free",u="reservation.cancellation.free",l="reservation.bill.penalty"),s.title=o,s.reason=i,s.penalty=r,s.statusText=a,s.freeLabel=u,s.penaltyLabel=l,s.sendEmail=!0,s},createEarlyCheckoutRoom:function(t,e,n,a){var o=f.createTerminatedRoom(t,e,n,a,"EARLY_CHECKOUT");return o&&(o.checkoutDone=new Date),o},createTerminatedRoom:function(t,e,n,a,o){if(!t||"CONFIRMED"!=t.status)return null;var i=n?moment(n):moment(),r=t.endDate?moment(t.endDate):null;if(r&&r.isSame(i,"days"))return angular.copy(t);var u=moment(t.startDate||e.checkin);r=r||moment(e.checkout);var l=moment.range(u,r);if(!l.contains(i,{exclusive:!0}))return null;var s=this,c=t.totalRate.amount.currency;a=a||t.totalRate.amount.vatRate||e.hotel.vatTax.finalAmount;var m=angular.copy(t);m.totalRoomAmount={initialAmount:0,finalAmount:0,currency:c},m.cancelled=!1;var d=moment.range(u,i);m.paymentServices=[],_.forEach(m.services,function(t){s.terminateServiceSold(t,d,o,l)&&(t.included||"INCLUDED"==t.service.bookability||m.paymentServices.push(t),m.totalRoomAmount.initialAmount+=E.fixedDecimals(t.amount.initialAmount||t.amount.finalAmount),m.totalRoomAmount.finalAmount+=E.fixedDecimals(t.amount.finalAmount))}),_.forEach(m.beds,function(t){t&&"CONFIRMED"==t.status&&(t.status=o||t.status)}),_.forEach(m.otherBeds,function(t){s.terminateBedSold(t,d,a,o,l)&&(m.totalRoomAmount.initialAmount+=E.fixedDecimals(t.amount.initialAmount||t.amount.finalAmount),m.totalRoomAmount.finalAmount+=E.fixedDecimals(t.amount.finalAmount))}),m.amount=m.totalRoomAmount,m.status=o||t.status,m.endDate=moment(d.end).toDate(),m.initialAmount=angular.copy(t.totalRate.amount),m.tempStatus="earlyCheckout";var f="EARLY_CHECKOUT"==m.status&&d.end.isSame(moment(),"day")?moment.range(d.start,moment(d.end).add(1,"days")):d;if(m.totalRate.initialDailyRates=angular.copy(m.totalRate.dailyRates),"STANDARD"==m.totalRate.type){_.forEach(m.totalRate.initialDailyRates,function(t){t.disabled=!f.contains(t.date,{exclusive:!0}),t.toRemove=t.disabled}),m.totalRate.dailyRates=_.filter(m.totalRate.initialDailyRates,function(t){return!t.toRemove});var p={initialAmount:0,finalAmount:0,currency:c};_.forEach(m.totalRate.dailyRates,function(t){p.initialAmount+=E.fixedDecimals(t.amount.initialAmount||t.amount.finalAmount),p.finalAmount+=E.fixedDecimals(t.amount.finalAmount)}),_.assign(m.totalRate.amount,p)}else if("NOT_REFUNDABLE"==m.totalRate.type){var A=m.totalRate.cancellationPolicy?m.totalRate.cancellationPolicy.cancellation:null,v=A?0<A.chargeNights?A.chargeNights:-1:null,h=v?0<v&&v<l.diff("days")?moment.range(l.start,moment(l.start).add(v,"days")):l:null,y=h&&h.diff("days")>f.diff("days")?h:f;_.forEach(m.totalRate.initialDailyRates,function(t){var e=moment(t.date);y.contains(e,{exclusive:!0})?(t.disabled=!1,t.toRemove=!1,!f.contains(e,{exclusive:!0})&&h&&h.contains(e,{exclusive:!0})&&(m.tempStatus="penalty",t.disabled=!0,A.percentage<100&&(t.amount.initialAmount=t.amount.finalAmount,t.amount.finalAmount=E.calculateDiscount(t.amount.finalAmount,A.percentage,"PERCENTAGE")))):(t.disabled=!0,t.toRemove=!0)}),m.totalRate.dailyRates=_.filter(m.totalRate.initialDailyRates,function(t){return!t.toRemove});p={initialAmount:0,finalAmount:0,currency:c};_.forEach(m.totalRate.dailyRates,function(t){p.initialAmount+=E.fixedDecimals(t.amount.initialAmount||t.amount.finalAmount),p.finalAmount+=E.fixedDecimals(t.amount.finalAmount)}),p.finalAmount<(m.totalRate.cancellationPolicy&&m.totalRate.cancellationPolicy.amount?m.totalRate.cancellationPolicy.amount.finalAmount:0)&&(p=m.totalRate.cancellationPolicy.amount,m.tempStatus="penalty"),_.assign(m.totalRate.amount,p)}return m.totalRate.amount.vatRate=m.totalRate.amount.vatRate||a,m.totalRate.amount.vatAmount=E.vatAmount(m.totalRate.amount.finalAmount,m.totalRate.amount.vatRate),m.totalRoomAmount.initialAmount=E.fixedDecimals(m.totalRoomAmount.initialAmount+m.totalRate.amount.initialAmount),m.totalRoomAmount.finalAmount=E.fixedDecimals(m.totalRoomAmount.finalAmount+m.totalRate.amount.finalAmount),s.calculateRoomTotalPrice(m),m},terminateServiceSold:function(t,e,n,a){if(!t||"CONFIRMED"!=t.status)return!1;var o=moment.range(moment(t.startDate||e.start),moment(t.endDate||e.end));if(!o.contains(e.end))return!1;var i=(o=moment.range(o.start,e.end)).diff("days"),r=f.serviceSold(t.service,t.people,i,t.count);if(t.status=n||t.status,t.initialAmount=angular.copy(t.amount),t.amount=angular.copy(r.amount),"DAILY"==t.service.frequency||"NIGHTLY"==t.service.frequency){if(a&&a.start&&a.end){t.dailyRates=[];for(var u=f.serviceSold(t.service,t.people,1,t.count).amount,l=moment(t.startDate||a.start),s=moment(t.endDate||a.end),c=moment(a.start);c.isBefore(moment(a.end),"days");c.add(1,"days"))t.dailyRates.push({date:c.toDate(),amount:c.isBefore(l,"days")||c.isAfter(s,"days")?null:u,disabled:c.isSameOrAfter(e.end,"days")})}t.endDate=moment(e.end).toDate()}return!0},terminateBedSold:function(t,e,n,a,o){if(!t||"CONFIRMED"!=t.status)return!1;var i=moment.range(t.startDate||e.start,t.endDate||e.end);if(!i.contains(e.end))return!1;var r=(i=moment.range(i.start,e.end)).diff("days"),u=f.bedSold(t.bed,t.people,r,n);if(t.status=a||t.status,t.initialAmount=angular.copy(t.amount),t.amount=angular.copy(u.amount),"DAILY"==t.bed.frequency||"NIGHTLY"==t.bed.frequency){if(o&&o.start&&o.end){t.dailyRates=[];for(var l=f.bedSold(t.bed,t.people,1,n).amount,s=moment(t.startDate||o.start),c=moment(t.endDate||o.end),m=moment(o.start);m.isBefore(moment(o.end),"days");m.add(1,"days"))t.dailyRates.push({date:m.toDate(),amount:m.isBefore(s,"days")||m.isAfter(c,"days")?null:l,disabled:m.isSameOrAfter(e.end,"days")})}t.endDate=moment(e.end).toDate()}return!0},bestPromotion:function(t){var e,n=0;return _.forEach(t,function(t){if(!t.secret)if("STANDARD"==t.promotionType){if(!e)return n=t.discount.finalAmount-t.discount.initialAmount,void(e=t);if(t.discount.finalAmount-t.discount.initialAmount>n){if(!t.onArrival&&e.onArrival)return;n=t.discount.finalAmount-t.discount.initialAmount,e=t}else t.discount.finalAmount-t.discount.initialAmount>n&&t.onArrival&&!e.onArrival&&(n=t.discount.finalAmount-t.discount.initialAmount,e=t)}else n=t.discount.finalAmount-t.discount.initialAmount,e=t}),e},bestPromotionForRates:function(t){var e=[];return _.forEach(t,function(t){e=_.union(e,t.promotions)}),f.bestPromotion(e)},getRoomPenalty:function(t,e,n){var a=null;if(t.totalRate.cancellationPolicy){var o=moment.isMoment(n)?n:moment(n);a=t.totalRate.cancellationPolicy.limitDate&&moment(t.totalRate.cancellationPolicy.limitDate).utcOffset((e.addressInfo.offset||0)/60).isSameOrAfter(o)?{finalAmount:0,initialAmount:0}:t.totalRate.cancellationPolicy.amount}return a},getReservationPenalty:function(t){if(t){var e={STANDARD:{date:null,amount:null},NOT_REFUNDABLE:{date:null,amount:null},TOTAL:[],TOTAL_AMOUNT:angular.copy(t.totalAmount)};_.forEach(t.rooms,function(t){e[t.totalRate.type].date=t.totalRate.cancellationPolicy.limitDate||new Date,e[t.totalRate.type].amount=d.sum(e[t.totalRate.type].amount,t.totalRate.cancellationPolicy?t.totalRate.cancellationPolicy.amount:0)});var n=e.STANDARD.date,a=e.NOT_REFUNDABLE.date;return n&&!a?e.TOTAL.push({startDate:n,amount:e.STANDARD.amount}):!n&&a?e.TOTAL.push({startDate:a,amount:e.NOT_REFUNDABLE.amount}):n&&a&&(n&&a&&n.getTime()>a.getTime()?e.TOTAL.push({startDate:a,endDate:n,amount:e.NOT_REFUNDABLE.amount},{startDate:n,amount:d.sum(e.STANDARD.amount,e.NOT_REFUNDABLE.amount)}):e.TOTAL.push({startDate:n,endDate:a,amount:e.STANDARD.amount},{startDate:a,amount:d.sum(e.STANDARD.amount,e.NOT_REFUNDABLE.amount)})),e}},generatePhysicalRoomsList:function(n,t){if(t&&!_.isEmpty(t))return n=_.isNil(n)?{}:n,_.forEach(t,function(t){_.forEach(t.roomsAvailabilities,function(e){if(e.roomClosed)return!0;n[e.room.id]=n[e.room.id]||[],_.some(n[e.room.id],function(t){return moment(t.date).isSame(moment(e.date),"day")})||n[e.room.id].push({date:e.date,roomsSold:[]})})}),n},isRoomInPenalty:function(t,e,n){var a=f.getRoomPenalty(t,e,n);return angular.isObject(a)&&0<a.finalAmount},maskCardPan:function(t){return String(t).replace(/-/g,"").replace(/.*(\d{4})$/,"**** **** **** $1")},beautifyCardPan:function(t){return String(t).replace(/-/g,"").replace(/(.{4})/g,"$1 ").replace(/-([^-]*)$/,"$1")}};return f}t.$inject=["$translate","NumberUtils","AmountUtils","ObjectUtils","DateUtils","LocalStorage","RESERVATION"],angular.module("itaca-utils").factory("ReservationUtils",t)}(),function(){"use strict";angular.module("itaca.utils").value("RESERVATION",{rooms:[]})}(),function(){"use strict";angular.module("itaca.utils").factory("ReviewsUtils",function(){var t={generateScoreLabel:function(t){if(t){var e;switch(t){case 4:e="review.score.bad";break;case 5:e="review.score.poor";break;case 6:e="review.score.sufficient";break;case 7:e="review.score.good";break;case 8:e="review.score.very.good";break;case 9:e="review.score.excellent";break;case 10:e="review.score.fabulous"}return e}}};return t})}(),function(){"use strict";function t(a){return function(t,e){if("text"===e){var n="";(n=a.trustAsHtml(t)).$$unwrapTrustedValue&&(n=n.$$unwrapTrustedValue()),t=n}return t}}t.$inject=["$sce"],angular.module("itaca.utils").factory("sceStrategy",t)}(),function(){"use strict";function n(n,t){var a=this;this.$$redirectUrl=t||"/login",this.responseError=function(t){var e=t.data&&t.data.status?t.data.status:t.status?t.status:null;if(e)switch(e){case 401:ctrl.$$dialogNotAutorized();break;case 403:location.assign(a.$$redirectUrl)}return n.reject(t)},this.$$dialogNotAutorized=function(){$translate(["error.401","error.code.401"]).then(function(t){Dialog.showAlert(null,t["error.401"],t["error.code.401"])})}}angular.module("itaca.utils").provider("SessionExpiredInterceptor",function(){var e="/login";this.init=function(t){if(!_.isString(t))return!1;e=t},this.$get=["$q",function(t){return new n(t,e)}]})}(),function(){"use strict";angular.module("itaca.utils").factory("StringUtils",function(){var e={isBlank:function(t){return _.isUndefined(t)||_.isNull(t)||_.isEmpty(t)}};return e.isNotBlank=function(t){return!e.isBlank(t)},e.isEmpty=function(t){return e.isNotBlank(t)&&_.isEmpty(_.trim(t))},e.isNotEmpty=function(t){return!e.isEmpty(t)},e.normalizeForUrl=function(t,e){return _.toLower(_.replace(_.deburr(e?_.snakeCase(t):t),/[^\w]/gi,""))},e.isBoolean=function(t){try{return _.isBoolean(JSON.parse(t))}catch(t){return!1}},e.toBoolean=function(t){return e.isBoolean(t)?JSON.parse(t):null},e})}(),function(){"use strict";angular.module("itaca.utils").factory("textTransform$$service",function(){var t={transform:function(t,e,n){t.on("input",function(){var t=n(e.$viewValue);e.$setViewValue(t),e.$render()})}};return t})}(),function(){"use strict";function t(a){var i={buildUrl:function(t,e){var n=a(e);return 0<n.length&&(t+=(-1===t.indexOf("?")?"?":"&")+n),t},withParam:function(t,e,n){var a=t.split("?")[1],o=a?JSON.parse('{"'+a.replace(/&/g,'","').replace(/=/g,'":"')+'"}',function(t,e){return""===t?e:decodeURIComponent(e)}):{};return o[e]=n,i.buildUrl(t,o)},parseUrl:function(t){var e=document.createElement("a");return e.href=t,e}};return i}t.$inject=["$httpParamSerializer"],angular.module("itaca.utils").factory("UrlUtils",t)}();